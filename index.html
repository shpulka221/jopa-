<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>LEVEL RUSH ‚Äî Mobile</title>
  <style>
    :root{
      --bg0:#050611;
      --bg1:#090b1a;
      --bg2:#141a33;

      --glass: rgba(255,255,255,.075);
      --glass2: rgba(255,255,255,.05);
      --stroke: rgba(255,255,255,.12);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);

      --acc:#7AA7FF;
      --acc2:#B47CFF;

      --good:#7CFFB2;
      --warn:#FFD56A;
      --bad:#FF6B8B;

      --shadow: 0 22px 90px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ margin:0; height:100%; background: var(--bg0); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{ overflow:hidden; }

    canvas#game{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      display:block;
      background:
        radial-gradient(1200px 720px at 18% 18%, rgba(122,167,255,.18), rgba(0,0,0,0) 58%),
        radial-gradient(1200px 760px at 86% 22%, rgba(180,124,255,.16), rgba(0,0,0,0) 60%),
        radial-gradient(900px 700px at 70% 85%, rgba(255,213,106,.08), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, #080a16, #050611);
      z-index:0;
      touch-action:none;
    }

    /* HUD */
    .hud{
      position:fixed;
      left:12px; right:12px;
      top: calc(10px + env(safe-area-inset-top));
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
      z-index:3;
    }

    .hudBox{
      pointer-events:auto;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.035));
      border:1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hudBox::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(800px 280px at 20% 0%, rgba(122,167,255,.20), rgba(0,0,0,0) 65%),
        radial-gradient(800px 280px at 88% 10%, rgba(180,124,255,.18), rgba(0,0,0,0) 65%);
      opacity:.9;
      pointer-events:none;
    }

    .stats{
      position:relative;
      padding:10px 12px 12px;
      min-width: 214px;
      max-width: 60vw;
    }

    .line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
      position:relative;
      z-index:1;
    }
    .line b{ color:var(--text); font-weight:950; }
    .mono{ font-variant-numeric: tabular-nums; }

    .bars{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:7px;
      position:relative;
      z-index:1;
    }
    .bar{
      height:9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      width:60%;
      border-radius:999px;
      background: linear-gradient(90deg, var(--acc), var(--acc2));
      box-shadow: 0 0 18px rgba(122,167,255,.28);
    }
    .bar.hp > i{
      background: linear-gradient(90deg, var(--good), #2EE59D);
      box-shadow: 0 0 18px rgba(124,255,178,.20);
    }
    .bar.sh > i{
      background: linear-gradient(90deg, rgba(122,167,255,.95), rgba(180,124,255,.95));
      box-shadow: 0 0 18px rgba(180,124,255,.16);
    }

    .hudRight{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:flex-end;
      flex-wrap:wrap;
      max-width: 44vw;
      pointer-events:auto;
    }

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color:var(--text);
      height:42px;
      padding:0 12px;
      border-radius: 16px;
      font-weight:950;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      user-select:none;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{
      border-color: rgba(122,167,255,.30);
      background: linear-gradient(180deg, rgba(122,167,255,.18), rgba(180,124,255,.10));
    }
    .btn.warn{
      border-color: rgba(255,213,106,.30);
      background: linear-gradient(180deg, rgba(255,213,106,.18), rgba(255,213,106,.08));
    }
    .btn.danger{
      border-color: rgba(255,107,139,.30);
      background: linear-gradient(180deg, rgba(255,107,139,.18), rgba(255,107,139,.08));
    }

    /* Skill indicator chips */
    .skillHUD{
      position:fixed;
      right:12px;
      bottom: calc(12px + env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:3;
      pointer-events:none;
    }
    .skillChip{
      width:58px;
      height:58px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .skillChip::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(220px 120px at 30% 0%, rgba(122,167,255,.20), rgba(0,0,0,0) 70%);
      opacity:.9;
    }
    .skillChip .ico{ position:relative; font-size:20px; z-index:1; }
    .skillChip .cd{
      position:absolute; inset:0;
      background: rgba(0,0,0,.42);
      display:flex; align-items:center; justify-content:center;
      font-weight:950;
      font-size:14px;
      opacity:0;
      transition: opacity .12s ease;
      z-index:2;
    }
    .skillChip.cool .cd{ opacity:1; }
    .skillChip .hint{
      position:absolute; left:8px; right:8px; bottom:6px;
      font-size:10px;
      color: rgba(255,255,255,.72);
      text-align:center;
      font-weight:900;
      z-index:1;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:12px; right:12px;
      bottom: calc(18px + env(safe-area-inset-bottom));
      display:flex;
      justify-content:center;
      z-index:20;
      pointer-events:none;
    }
    .toast > div{
      max-width: min(620px, 100%);
      background: rgba(10,12,20,.78);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.90);
      border-radius: 18px;
      padding:10px 12px;
      font-size:13px;
      font-weight:900;
      box-shadow: 0 20px 80px rgba(0,0,0,.55);
      transform: translateY(14px);
      opacity:0;
      transition: transform .18s ease, opacity .18s ease;
    }
    .toast.show > div{ transform: translateY(0); opacity:1; }

    /* Overlays */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      z-index:10;
    }
    .overlay.show{ display:flex; }

    .panel{
      width:min(680px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 30px 110px rgba(0,0,0,.65);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(900px 420px at 18% 0%, rgba(122,167,255,.20), rgba(0,0,0,0) 55%),
        radial-gradient(900px 420px at 88% 10%, rgba(180,124,255,.18), rgba(0,0,0,0) 55%),
        radial-gradient(900px 420px at 50% 110%, rgba(255,213,106,.10), rgba(0,0,0,0) 55%);
      pointer-events:none;
      opacity:.95;
    }
    .panelHeader{
      position:relative;
      padding:14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      z-index:1;
    }
    .panelHeader h2{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .panelHeader p{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .panelBody{ position:relative; padding:12px 14px 14px; z-index:1; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .card{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding:12px;
    }
    .card h3{ margin:0 0 6px; font-size:13px; font-weight:950; }
    .card p{ margin:0 0 10px; font-size:12px; color:var(--muted); line-height:1.35; }
    .row2{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .tag{
      font-size:11px;
      color:rgba(255,255,255,.78);
      padding:5px 9px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;
    }
    .price{ font-weight:950; color:var(--warn); }
    .wide{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .wide .btn{ flex:1; justify-content:center; }
    .input{
      width:100%;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      font-size:14px;
    }

    /* Chest open overlay */
    .openAnim{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:12px;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      z-index:30;
    }
    .openAnim.show{ display:flex; }
    .chestBox{
      width:120px; height:120px;
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05));
      box-shadow: 0 28px 110px rgba(0,0,0,.65);
      display:flex; align-items:center; justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .chestBox::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,213,106,.22), rgba(0,0,0,0) 55%),
        radial-gradient(circle at 70% 40%, rgba(180,124,255,.18), rgba(0,0,0,0) 60%);
      transform: rotate(12deg);
      opacity:.95;
    }
    .chestIcon{
      position:relative;
      font-size:52px;
      filter: drop-shadow(0 14px 24px rgba(0,0,0,.55));
    }
    .shake{ animation: shake .55s ease-in-out; }
    @keyframes shake{
      0%{ transform: translate(0,0) rotate(0deg); }
      20%{ transform: translate(-3px,2px) rotate(-2deg); }
      40%{ transform: translate(4px,-2px) rotate(2deg); }
      60%{ transform: translate(-2px,-2px) rotate(-2deg); }
      80%{ transform: translate(3px,1px) rotate(2deg); }
      100%{ transform: translate(0,0) rotate(0deg); }
    }
    .animText{
      font-size:13px;
      color:rgba(255,255,255,.88);
      font-weight:950;
      text-align:center;
      padding:0 12px;
    }

    @media (max-width: 420px){
      .stats{ min-width: 200px; max-width: 64vw; }
      .btn{ height:40px; font-size:12.5px; border-radius: 15px; }
      .skillChip{ width:54px; height:54px; border-radius: 18px; }
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>

  <div class="hud">
    <div class="hudBox stats">
      <div class="line">
        <div>–£—Ä. <b class="mono" id="uiLevel">1</b> <span id="uiStage" style="margin-left:8px; color:rgba(255,255,255,.62)"></span></div>
        <div>üí∞ <b class="mono" id="uiCoins">0</b></div>
      </div>
      <div class="bars">
        <div class="bar hp"><i id="uiHpBar"></i></div>
        <div class="bar sh"><i id="uiShieldBar"></i></div>
        <div class="bar"><i id="uiXpBar"></i></div>
      </div>
      <div class="line" style="margin-top:8px;">
        <div>HP: <b class="mono" id="uiHpText">0/0</b></div>
        <div>üîë <b class="mono" id="uiKeys">0</b></div>
      </div>
      <div class="line">
        <div>XP: <b class="mono" id="uiXpText">0/0</b></div>
        <div>–©–∏—Ç: <b class="mono" id="uiShieldText">0</b></div>
      </div>
    </div>

    <div class="hudRight">
      <button class="btn primary" id="btnShop">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</button>
      <button class="btn warn" id="btnChest">üéÅ –°—É–Ω–¥—É–∫–∏</button>
      <button class="btn" id="btnUpgrades">‚öôÔ∏è –ü—Ä–æ–∫–∞—á–∫–∞</button>
      <button class="btn danger" id="btnMenu">‚ò∞ –ú–µ–Ω—é</button>
    </div>
  </div>

  <div class="skillHUD">
    <div class="skillChip" id="chipDash"><div class="ico">üí®</div><div class="cd" id="cdDash">0.0</div><div class="hint">—Ä—ã–≤–æ–∫</div></div>
    <div class="skillChip" id="chipShield"><div class="ico">üõ°Ô∏è</div><div class="cd" id="cdShield">0.0</div><div class="hint">—â–∏—Ç</div></div>
  </div>

  <div class="toast" id="toast"><div id="toastText">‚Äî</div></div>

  <!-- Start -->
  <div class="overlay show" id="startOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>LEVEL RUSH</h2>
          <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <b>–≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º</b> ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ, <b>—Ç–∞–ø</b> ‚Äî –∞—Ç–∞–∫–∞, <b>–±—ã—Å—Ç—Ä—ã–π —Å–≤–∞–π–ø</b> ‚Äî —Ä—ã–≤–æ–∫, <b>—Ç–∞–ø 2 –ø–∞–ª—å—Ü–∞–º–∏</b> ‚Äî —â–∏—Ç.</p>
        </div>
        <button class="btn" id="btnResetSave">üß® –°–±—Ä–æ—Å</button>
      </div>
      <div class="panelBody">
        <div class="card">
          <h3>–§–∏—à–∫–∏</h3>
          <p>–ö–∞–∂–¥—ã–µ <b>5 —É—Ä–æ–≤–Ω–µ–π</b> ‚Äî <b>–±–æ—Å—Å</b> —Å —É–º–µ–Ω–∏—è–º–∏ (—Ä—ã–≤–æ–∫ + –≤—ã—Å—Ç—Ä–µ–ª + –ø—Ä–∏–∑—ã–≤). –ó–∞ –±–æ—Å—Å–∞ –∫–ª—é—á–∏ üîë. –£—Ä–æ–Ω —Ç–µ–ø–µ—Ä—å —Å <b>—Ü–∏—Ñ—Ä–∞–º–∏</b> –∏ –∫—Ä–∏—Ç–∞–º–∏.</p>
          <div class="row2">
            <span class="tag">Boss skills</span>
            <span class="tag">Damage numbers</span>
            <span class="tag">Fireworks</span>
            <span class="tag">Cosmetics</span>
          </div>
        </div>
        <div class="wide">
          <button class="btn primary" id="btnPlay">‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å</button>
          <button class="btn" id="btnHow">‚ùî –ü–æ–º–æ—â—å</button>
        </div>
        <div style="margin-top:10px; font-size:12px; color:rgba(255,255,255,.70); line-height:1.35;">
          –ê–π—Ñ–æ–Ω: Safari ‚Üí –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí <b>–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- Menu -->
  <div class="overlay" id="menuOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–ú–µ–Ω—é</h2>
          <p>–ü–∞—É–∑–∞ / –Ω–æ–≤—ã–π –∑–∞–±–µ–≥ / –∞–¥–º–∏–Ω–∫–∞</p>
        </div>
        <button class="btn" data-close="menuOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="grid">
          <div class="card">
            <h3>–ñ–µ—Å—Ç—ã</h3>
            <p>
              ‚Ä¢ –í–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ<br>
              ‚Ä¢ –¢–∞–ø ‚Äî –∞—Ç–∞–∫–∞<br>
              ‚Ä¢ –ë—ã—Å—Ç—Ä—ã–π —Å–≤–∞–π–ø ‚Äî —Ä—ã–≤–æ–∫<br>
              ‚Ä¢ –¢–∞–ø 2 –ø–∞–ª—å—Ü–∞–º–∏ ‚Äî —â–∏—Ç
            </p>
            <div class="row2">
              <span class="tag">—É–¥–æ–±–Ω–æ</span>
              <span class="tag">–≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ</span>
            </div>
          </div>
          <div class="card">
            <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
            <p>–ü–∞—Ä–æ–ª—å: <b>1235</b>. –ú–æ–∂–Ω–æ –≤—ã–¥–∞—Ç—å —Å–µ–±–µ –º–æ–Ω–µ—Ç—ã, SP –∏ –∫–ª—é—á–∏.</p>
            <div class="row2">
              <button class="btn warn" id="btnAdmin">üõ†Ô∏è –û—Ç–∫—Ä—ã—Ç—å</button>
              <span class="tag">—á–∏—Ç-—Ä–µ–∂–∏–º</span>
            </div>
          </div>
        </div>
        <div class="wide">
          <button class="btn primary" id="btnResume">‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          <button class="btn danger" id="btnRestart">üîÑ –ù–æ–≤—ã–π –∑–∞–±–µ–≥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upgrades -->
  <div class="overlay" id="upOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–ü—Ä–æ–∫–∞—á–∫–∞</h2>
          <p>–û—á–∫–∏ SP –∑–∞ —É—Ä–æ–≤–µ–Ω—å. –¢—Ä–∞—Ç—å –Ω–∞ —Å—Ç–∞—Ç—ã.</p>
        </div>
        <button class="btn" data-close="upOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="card">
          <div class="row2">
            <div>SP: <b class="mono" id="uiSP">0</b></div>
            <span class="tag">+1 –∑–∞ —É—Ä–æ–≤–µ–Ω—å</span>
          </div>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="card">
            <h3>–£—Ä–æ–Ω</h3>
            <p>–ë–æ–ª—å—à–µ —É—Ä–æ–Ω–∞ –ø–æ –≤—Ä–∞–≥–∞–º.</p>
            <div class="row2">
              <span class="tag">DMG: <b class="mono" id="uiDmg">0</b></span>
              <button class="btn primary" id="upDmg">+1</button>
            </div>
          </div>
          <div class="card">
            <h3>–ó–¥–æ—Ä–æ–≤—å–µ</h3>
            <p>–ë–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ HP.</p>
            <div class="row2">
              <span class="tag">VIT: <b class="mono" id="uiVit">0</b></span>
              <button class="btn primary" id="upVit">+1</button>
            </div>
          </div>
          <div class="card">
            <h3>–°–∫–æ—Ä–æ—Å—Ç—å</h3>
            <p>–ë—ã—Å—Ç—Ä–µ–µ –¥–≤–∏–≥–∞–µ—à—å—Å—è.</p>
            <div class="row2">
              <span class="tag">SPD: <b class="mono" id="uiSpd">0</b></span>
              <button class="btn primary" id="upSpd">+1</button>
            </div>
          </div>
          <div class="card">
            <h3>–ö—Ä–∏—Ç</h3>
            <p>–®–∞–Ω—Å –∫—Ä–∏—Ç-—É–¥–∞—Ä–∞.</p>
            <div class="row2">
              <span class="tag">CRT: <b class="mono" id="uiCrt">0</b></span>
              <button class="btn primary" id="upCrt">+1</button>
            </div>
          </div>
        </div>

        <div style="margin-top:10px; font-size:12px; color:rgba(255,255,255,.70); line-height:1.35;">
          –ö—Ä–∏—Ç—ã –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è, —Ü–∏—Ñ—Ä—ã —É—Ä–æ–Ω–∞ ‚Äî –∂—ë–ª—Ç—ã–µ.
        </div>
      </div>
    </div>
  </div>

  <!-- Shop -->
  <div class="overlay" id="shopOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
          <p>–ù–∏—à—Ç—è–∫–∏: —Å–∫–∏–Ω—ã, —Ç—Ä–µ–π–ª—ã, –∞—É—Ä—ã, —ç—Ñ—Ñ–µ–∫—Ç—ã —É–¥–∞—Ä–∞, —Ç–µ–º–∞ –∞—Ä–µ–Ω—ã.</p>
        </div>
        <button class="btn" data-close="shopOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="card">
          <div class="row2">
            <div>–ë–∞–ª–∞–Ω—Å: üí∞ <b class="mono" id="uiShopCoins">0</b></div>
            <span class="tag">Cosmetics</span>
          </div>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="card">
            <h3>–°–∫–∏–Ω ‚Äú–õ—ë–¥‚Äù</h3>
            <p>–•–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∏–ª—å.</p>
            <div class="row2">
              <span class="price">250</span>
              <button class="btn primary" id="buySkinIce">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–°–∫–∏–Ω ‚Äú–ù–µ–æ–Ω‚Äù</h3>
            <p>–Ø—Ä–∫–∏–π –∫–∏–±–µ—Ä-–Ω–µ–æ–Ω.</p>
            <div class="row2">
              <span class="price">400</span>
              <button class="btn primary" id="buySkinNeon">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–°–∫–∏–Ω ‚Äú–ó–æ–ª–æ—Ç–æ‚Äù</h3>
            <p>–ë–ª–µ—Å—Ç—è—â–∏–π –∑–æ–ª–æ—Ç–æ–π.</p>
            <div class="row2">
              <span class="price">600</span>
              <button class="btn primary" id="buySkinGold">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–°–∫–∏–Ω ‚Äú–¢–µ–Ω—å‚Äù</h3>
            <p>–¢—ë–º–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å.</p>
            <div class="row2">
              <span class="price">700</span>
              <button class="btn primary" id="buySkinShadow">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>

          <div class="card">
            <h3>–¢—Ä–µ–π–ª ‚Äú–ò—Å–∫—Ä—ã‚Äù</h3>
            <p>–°–∞–ª—é—Ç–Ω—ã–π —Å–ª–µ–¥.</p>
            <div class="row2">
              <span class="price">300</span>
              <button class="btn primary" id="buyTrailSparks">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–¢—Ä–µ–π–ª ‚Äú–î—ã–º‚Äù</h3>
            <p>–ú—è–≥–∫–∏–π –¥—ã–º–Ω—ã–π —Å–ª–µ–¥.</p>
            <div class="row2">
              <span class="price">300</span>
              <button class="btn primary" id="buyTrailSmoke">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–¢—Ä–µ–π–ª ‚Äú–ì–ª–∏—Ç—á‚Äù</h3>
            <p>–ö–∏–±–µ—Ä-–º–∏–≥–∞–Ω–∏–µ.</p>
            <div class="row2">
              <span class="price">450</span>
              <button class="btn primary" id="buyTrailGlitch">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–¢—Ä–µ–π–ª ‚Äú–ü–ª–∞–∑–º–∞‚Äù</h3>
            <p>–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –ø–ª–∞–∑–º–∞.</p>
            <div class="row2">
              <span class="price">500</span>
              <button class="btn primary" id="buyTrailPlasma">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>

          <div class="card">
            <h3>–ê—É—Ä–∞ ‚ÄúGlow‚Äù</h3>
            <p>–°–≤–µ—á–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –∏–≥—Ä–æ–∫–∞.</p>
            <div class="row2">
              <span class="price">350</span>
              <button class="btn primary" id="buyAuraGlow">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–ê—É—Ä–∞ ‚ÄúPulse‚Äù</h3>
            <p>–ü—É–ª—å—Å–∏—Ä—É—é—â–∞—è –∞—É—Ä–∞.</p>
            <div class="row2">
              <span class="price">500</span>
              <button class="btn primary" id="buyAuraPulse">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>

          <div class="card">
            <h3>–≠—Ñ—Ñ–µ–∫—Ç —É–¥–∞—Ä–∞ ‚ÄúSlash‚Äù</h3>
            <p>–ö—Ä–∞—Å–∏–≤—ã–π —Å–ª—ç—à –ø—Ä–∏ –∞—Ç–∞–∫–µ.</p>
            <div class="row2">
              <span class="price">350</span>
              <button class="btn primary" id="buyHitSlash">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–≠—Ñ—Ñ–µ–∫—Ç —É–¥–∞—Ä–∞ ‚ÄúNova‚Äù</h3>
            <p>–í—Å–ø—ã—à–∫–∞/–Ω–æ–≤–∞ –Ω–∞ –∫—Ä–∏—Ç–∞—Ö.</p>
            <div class="row2">
              <span class="price">600</span>
              <button class="btn primary" id="buyHitNova">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>

          <div class="card">
            <h3>–¢–µ–º–∞ –∞—Ä–µ–Ω—ã ‚ÄúCyber‚Äù</h3>
            <p>–ù–µ–æ–Ω–æ–≤–∞—è —Å–µ—Ç–∫–∞.</p>
            <div class="row2">
              <span class="price">450</span>
              <button class="btn primary" id="buyThemeCyber">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–¢–µ–º–∞ –∞—Ä–µ–Ω—ã ‚ÄúVoid‚Äù</h3>
            <p>–¢—ë–º–Ω–∞—è –∞—Ä–µ–Ω–∞.</p>
            <div class="row2">
              <span class="price">450</span>
              <button class="btn primary" id="buyThemeVoid">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <h3>–ù–∞–¥–µ—Ç–æ</h3>
          <p>–ú–µ–Ω—è–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –µ—Å–ª–∏ –∫—É–ø–ª–µ–Ω–æ.</p>
          <div class="row2">
            <span class="tag">–°–∫–∏–Ω: <b class="mono" id="uiSkin">default</b></span>
            <span class="tag">–¢—Ä–µ–π–ª: <b class="mono" id="uiTrail">none</b></span>
            <span class="tag">–ê—É—Ä–∞: <b class="mono" id="uiAura">none</b></span>
            <span class="tag">–•–∏—ÇFX: <b class="mono" id="uiHitFx">none</b></span>
            <span class="tag">–¢–µ–º–∞: <b class="mono" id="uiTheme">default</b></span>
          </div>
          <div class="wide">
            <button class="btn" id="equipDefault">–°–∫–∏–Ω default</button>
            <button class="btn" id="equipNoneTrail">–¢—Ä–µ–π–ª none</button>
            <button class="btn" id="equipNoneAura">–ê—É—Ä–∞ none</button>
            <button class="btn" id="equipNoneHitFx">HitFX none</button>
            <button class="btn" id="equipDefaultTheme">–¢–µ–º–∞ default</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chests -->
  <div class="overlay" id="chestOverlay">
    <div class="panel" style="position:relative;">
      <div class="panelHeader">
        <div>
          <h2>–°—É–Ω–¥—É–∫–∏</h2>
          <p>–û—Ç–∫—Ä—ã–≤–∞–π –∑–∞ –∫–ª—é—á–∏ üîë –∏–ª–∏ –∑–∞ –º–æ–Ω–µ—Ç—ã. –ë—É–¥–µ—Ç —Å–∞–ª—é—Ç üòà</p>
        </div>
        <button class="btn" data-close="chestOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="card">
          <div class="row2">
            <div>üîë <b class="mono" id="uiChestKeys">0</b></div>
            <div>üí∞ <b class="mono" id="uiChestCoins">0</b></div>
          </div>
          <p style="margin-top:10px;">–õ—É—Ç: –º–æ–Ω–µ—Ç—ã / SP / –∫–æ—Å–º–µ—Ç–∏–∫–∞. –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π ‚Äî —á–∞—â–µ –∫–æ—Å–º–µ—Ç–∏–∫–∞.</p>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="card">
            <h3>–û–±—ã—á–Ω—ã–π</h3>
            <p>–ù–æ—Ä–º –ª—É—Ç.</p>
            <div class="row2">
              <span class="tag">1 üîë –∏–ª–∏ 200 üí∞</span>
              <button class="btn primary" id="openCommon">–û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–†–µ–¥–∫–∏–π</h3>
            <p>–ß—É—Ç—å –ª—É—á—à–µ.</p>
            <div class="row2">
              <span class="tag">2 üîë –∏–ª–∏ 350 üí∞</span>
              <button class="btn primary" id="openRare">–û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π</h3>
            <p>–ö–æ—Å–º–µ—Ç–∏–∫–∞ —á–∞—â–µ.</p>
            <div class="row2">
              <span class="tag">3 üîë –∏–ª–∏ 500 üí∞</span>
              <button class="btn primary" id="openLegend">–û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–ë–æ—Å—Å—ã</h3>
            <p>–ö–∞–∂–¥—ã–µ 5 —É—Ä–æ–≤–Ω–µ–π ‚Äî –±–æ—Å—Å. –î—Ä–æ–ø –∫–ª—é—á–µ–π: +1 üîë (–∏–Ω–æ–≥–¥–∞ +2).</p>
            <div class="row2">
              <span class="tag">—É—Ä–æ–≤–µ–Ω—å % 5</span>
              <span class="tag">–ë–û–°–°</span>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–π –ª—É—Ç</h3>
          <p id="lootText" style="margin:0; color:rgba(255,255,255,.86); font-weight:900;">‚Äî</p>
        </div>
      </div>

      <div class="openAnim" id="openAnim">
        <div class="chestBox" id="chestBox">
          <div class="chestIcon" id="chestIcon">üéÅ</div>
        </div>
        <div class="animText" id="animText">–û—Ç–∫—Ä—ã–≤–∞–µ–º‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Admin -->
  <div class="overlay" id="adminOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
          <p>–ü–∞—Ä–æ–ª—å ‚Üí –≤—ã–¥–∞—á–∞ –º–æ–Ω–µ—Ç / SP / –∫–ª—é—á–µ–π üîë</p>
        </div>
        <button class="btn" data-close="adminOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="card">
          <h3>–ü–∞—Ä–æ–ª—å</h3>
          <p>–í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏.</p>
          <input class="input" id="adminPass" type="password" inputmode="numeric" placeholder="–ü–∞—Ä–æ–ª—å..." />
          <div class="wide">
            <button class="btn primary" id="adminLogin">–í–æ–π—Ç–∏</button>
            <button class="btn" id="adminLogout">–í—ã–π—Ç–∏</button>
          </div>
          <div style="margin-top:8px; font-size:12px; color:rgba(255,255,255,.72); font-weight:900;" id="adminState">–°—Ç–∞—Ç—É—Å: üîí –∑–∞–∫—Ä—ã—Ç–æ</div>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="card">
            <h3>–ú–æ–Ω–µ—Ç—ã üí∞</h3>
            <p>–í—ã–¥–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ.</p>
            <div class="row2">
              <button class="btn warn" id="giveCoins1">+500</button>
              <button class="btn warn" id="giveCoins2">+2000</button>
            </div>
          </div>
          <div class="card">
            <h3>SP ‚≠ê</h3>
            <p>–û—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏.</p>
            <div class="row2">
              <button class="btn warn" id="giveSP1">+5</button>
              <button class="btn warn" id="giveSP2">+20</button>
            </div>
          </div>
          <div class="card">
            <h3>–ö–ª—é—á–∏ üîë</h3>
            <p>–î–ª—è —Å—É–Ω–¥—É–∫–æ–≤.</p>
            <div class="row2">
              <button class="btn warn" id="giveKeys1">+5</button>
              <button class="btn warn" id="giveKeys2">+20</button>
            </div>
          </div>
          <div class="card">
            <h3>–í–∞–∂–Ω–æ</h3>
            <p>–≠—Ç–æ —á–∏—Ç-–∞–¥–º–∏–Ω–∫–∞ –≤ –∫–ª–∏–µ–Ω—Ç–µ. –î–ª—è —Å–æ–ª–æ-–∏–≥—Ä—ã –Ω–æ—Ä–º.</p>
            <div class="row2">
              <span class="tag">local</span>
              <span class="tag">–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ----------------- helpers -----------------
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const rnd = (a,b)=>a+Math.random()*(b-a);
  const dist = (ax,ay,bx,by)=>Math.hypot(ax-bx,ay-by);

  // ----------------- canvas -----------------
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', { alpha:false });

  function resize(){
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    canvas.width = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor(innerHeight * dpr);
    canvas.style.width = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize);
  resize();

  // ----------------- save -----------------
  const SAVE_KEY = 'level_rush_save_v4_boss_shop_numbers';
  const ADMIN_PASSWORD = '1235';

  const defaultSave = () => ({
    coins:0, keys:0,
    level:1, xp:0, sp:0,
    stats:{ dmg:0, vit:0, spd:0, crt:0 },
    cosmetics:{
      ownedSkins:{ default:true },
      ownedTrails:{ none:true },
      ownedAuras:{ none:true },
      ownedHitFx:{ none:true },
      ownedThemes:{ default:true },
      skin:'default',
      trail:'none',
      aura:'none',
      hitFx:'none',
      theme:'default'
    },
    adminUnlocked:false
  });

  function loadSave(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return defaultSave();
      const s = JSON.parse(raw);
      const d = defaultSave();
      return {
        ...d, ...s,
        stats:{...d.stats, ...(s.stats||{})},
        cosmetics:{
          ...d.cosmetics, ...(s.cosmetics||{}),
          ownedSkins:{...d.cosmetics.ownedSkins, ...((s.cosmetics||{}).ownedSkins||{})},
          ownedTrails:{...d.cosmetics.ownedTrails,...((s.cosmetics||{}).ownedTrails||{})},
          ownedAuras:{...d.cosmetics.ownedAuras,...((s.cosmetics||{}).ownedAuras||{})},
          ownedHitFx:{...d.cosmetics.ownedHitFx,...((s.cosmetics||{}).ownedHitFx||{})},
          ownedThemes:{...d.cosmetics.ownedThemes,...((s.cosmetics||{}).ownedThemes||{})},
        }
      };
    }catch{
      return defaultSave();
    }
  }
  let S = loadSave();
  const save = ()=> localStorage.setItem(SAVE_KEY, JSON.stringify(S));

  // ----------------- UI refs -----------------
  const $ = id => document.getElementById(id);

  const uiLevel=$('uiLevel'), uiCoins=$('uiCoins'), uiKeys=$('uiKeys');
  const uiHpBar=$('uiHpBar'), uiShieldBar=$('uiShieldBar'), uiXpBar=$('uiXpBar');
  const uiHpText=$('uiHpText'), uiShieldText=$('uiShieldText'), uiXpText=$('uiXpText');
  const uiStage=$('uiStage');

  const btnShop=$('btnShop'), btnChest=$('btnChest'), btnUpgrades=$('btnUpgrades'), btnMenu=$('btnMenu');
  const startOverlay=$('startOverlay'), menuOverlay=$('menuOverlay'), upOverlay=$('upOverlay'), shopOverlay=$('shopOverlay'), chestOverlay=$('chestOverlay'), adminOverlay=$('adminOverlay');
  const btnPlay=$('btnPlay'), btnHow=$('btnHow'), btnResetSave=$('btnResetSave');
  const btnResume=$('btnResume'), btnRestart=$('btnRestart');

  const uiSP=$('uiSP'), uiDmg=$('uiDmg'), uiVit=$('uiVit'), uiSpd=$('uiSpd'), uiCrt=$('uiCrt');
  const upDmg=$('upDmg'), upVit=$('upVit'), upSpd=$('upSpd'), upCrt=$('upCrt');

  const uiShopCoins=$('uiShopCoins'), uiSkin=$('uiSkin'), uiTrail=$('uiTrail'), uiAura=$('uiAura'), uiHitFx=$('uiHitFx'), uiTheme=$('uiTheme');
  const buySkinIce=$('buySkinIce'), buySkinNeon=$('buySkinNeon'), buyTrailSparks=$('buyTrailSparks'), buyTrailSmoke=$('buyTrailSmoke');
  const equipDefault=$('equipDefault'), equipNoneTrail=$('equipNoneTrail'), equipNoneAura=$('equipNoneAura'), equipNoneHitFx=$('equipNoneHitFx'), equipDefaultTheme=$('equipDefaultTheme');

  // New shop items
  const buySkinGold=$('buySkinGold'), buySkinShadow=$('buySkinShadow');
  const buyTrailGlitch=$('buyTrailGlitch'), buyTrailPlasma=$('buyTrailPlasma');
  const buyAuraGlow=$('buyAuraGlow'), buyAuraPulse=$('buyAuraPulse');
  const buyHitSlash=$('buyHitSlash'), buyHitNova=$('buyHitNova');
  const buyThemeCyber=$('buyThemeCyber'), buyThemeVoid=$('buyThemeVoid');

  const uiChestKeys=$('uiChestKeys'), uiChestCoins=$('uiChestCoins');
  const lootText=$('lootText');
  const openCommon=$('openCommon'), openRare=$('openRare'), openLegend=$('openLegend');

  const btnAdmin=$('btnAdmin'), adminPass=$('adminPass'), adminLogin=$('adminLogin'), adminLogout=$('adminLogout'), adminState=$('adminState');
  const giveCoins1=$('giveCoins1'), giveCoins2=$('giveCoins2'), giveSP1=$('giveSP1'), giveSP2=$('giveSP2');
  const giveKeys1=$('giveKeys1'), giveKeys2=$('giveKeys2');

  const toast=$('toast'), toastText=$('toastText');

  const chipDash=$('chipDash'), chipShield=$('chipShield');
  const cdDash=$('cdDash'), cdShield=$('cdShield');

  const openAnim=$('openAnim'), chestBox=$('chestBox'), chestIcon=$('chestIcon'), animText=$('animText');

  document.querySelectorAll('[data-close]').forEach(b=>{
    b.addEventListener('click', ()=> hideOverlay(b.getAttribute('data-close')));
  });

  function showToast(msg){
    toastText.textContent = msg;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.classList.remove('show'), 1600);
  }

  // ----------------- overlays -----------------
  let paused = true;

  function showOverlay(el){
    el.classList.add('show');
    paused = true;
    updateUI();
  }
  function hideOverlay(id){
    $(id).classList.remove('show');
    if(!startOverlay.classList.contains('show')) paused = false;
    updateUI();
    save();
  }

  // ----------------- game core -----------------
  const world = {
    pad: 44,
    topPad: 74,
    w: ()=> innerWidth,
    h: ()=> innerHeight
  };

  function xpNeed(lv){
    return Math.floor(60 + lv*25 + Math.pow(lv,1.25)*6);
  }
  const isBossLevel = lv => lv % 5 === 0;

  function stageName(){
    return isBossLevel(S.level) ? '‚Äî –ë–û–°–°' : `‚Äî –í–æ–ª–Ω–∞ ${wave}`;
  }

  // themes affect arena style
  function themeStyle(){
    const t = S.cosmetics.theme;
    if(t==='cyber'){
      return {
        gridAlpha: 0.13,
        border: 'rgba(122,167,255,.18)',
        grid: 'rgba(255,255,255,.22)'
      };
    }
    if(t==='void'){
      return {
        gridAlpha: 0.08,
        border: 'rgba(180,124,255,.14)',
        grid: 'rgba(255,255,255,.18)'
      };
    }
    return {
      gridAlpha: 0.10,
      border: 'rgba(255,255,255,.14)',
      grid: 'rgba(255,255,255,.18)'
    };
  }

  function skinColor(name){
    if(name==='ice') return '#7AA7FF';
    if(name==='neon') return '#B47CFF';
    if(name==='gold') return '#FFD56A';
    if(name==='shadow') return '#A9B0C8';
    return '#FFFFFF';
  }

  const player = {
    x: innerWidth*0.5,
    y: innerHeight*0.62,
    r: 14,
    vx:0, vy:0,

    maxHp:100,
    hp:100,

    baseSpeed: 220,
    atkCd: 0,

    dashCd: 0,
    shieldCd: 0,
    dashTime: 0,
    dashVx: 0,
    dashVy: 0,

    shield: 0,
    shieldMax: 0,
    shieldTime: 0,

    hitFlash: 0,
  };

  const enemies = [];
  const particles = [];
  const trails = [];
  const confetti = [];
  const bullets = [];      // boss projectiles
  const damageTexts = [];  // —Ü–∏—Ñ—Ä—ã —É—Ä–æ–Ω–∞

  let wave = 1;
  let enemiesToSpawn = 3;

  function applyStats(){
    const st = S.stats;
    player.maxHp = 100 + st.vit*22;
    player.baseSpeed = 220 + st.spd*14;
    player.shieldMax = 44 + st.vit*8;
    player.hp = clamp(player.hp, 0, player.maxHp);
    player.shield = clamp(player.shield, 0, player.shieldMax);
  }
  applyStats();

  function addCoins(n){ S.coins += n; }
  function addKeys(n){ S.keys = Math.max(0, S.keys + n); }
  function addXp(n){
    S.xp += n;
    while(S.xp >= xpNeed(S.level)){
      S.xp -= xpNeed(S.level);
      S.level += 1;
      S.sp += 1;
      player.hp = clamp(player.hp + player.maxHp*0.35, 0, player.maxHp);
    }
  }

  // ----------------- enemies / boss -----------------
  function spawnEnemy(kind='mob'){
    const pad=world.pad;
    const x = Math.random()<0.5 ? rnd(pad, world.w()-pad) : (Math.random()<0.5 ? pad : world.w()-pad);
    const y = Math.random()<0.5 ? rnd(world.topPad+pad, world.h()-pad) : (Math.random()<0.5 ? world.topPad+pad : world.h()-pad);

    const lv=S.level;
    let hp=40+lv*9, spd=105+lv*2.5, dmg=10+lv*1.25, r=12;

    if(kind==='brute'){ hp*=1.7; spd*=0.82; dmg*=1.25; r=15; }
    if(kind==='runner'){ hp*=0.85; spd*=1.35; dmg*=0.9; r=11; }

    if(kind==='boss'){
      // –±–æ—Å—Å —Å 3 —É–º–µ–Ω–∏—è–º–∏: charge + shoot + summon
      hp=320 + lv*70;
      spd=125 + lv*1.7;
      dmg=20 + lv*2.2;
      r=28;
      enemies.push({
        x,y,r, vx:0,vy:0,
        hp,maxHp:hp,
        spd,dmg,
        kind,
        atkCd:rnd(0.4,0.9),
        hitFlash:0,
        phase:1,
        chargeCd: 2.8,
        shootCd: 1.9,
        summonCd: 5.6,
        charging:0,
        chargeVx:0,
        chargeVy:0
      });
      return;
    }

    enemies.push({ x,y,r, vx:0,vy:0, hp,maxHp:hp, spd,dmg, kind, atkCd:rnd(0.4,1.2), hitFlash:0 });
  }

  function spawnWave(){
    enemies.length=0;
    bullets.length=0;
    const count = enemiesToSpawn + Math.floor(wave*0.6);
    for(let i=0;i<count;i++){
      const t=Math.random();
      if(t<0.15) spawnEnemy('runner');
      else if(t<0.35) spawnEnemy('brute');
      else spawnEnemy('mob');
    }
  }

  function startLevel(){
    applyStats();
    wave=1;
    enemies.length=0;
    bullets.length=0;
    particles.length=0;
    trails.length=0;

    player.hp = player.maxHp;
    player.shield = 0;
    player.shieldTime = 0;

    if(isBossLevel(S.level)) spawnEnemy('boss');
    else{
      enemiesToSpawn = 3 + Math.floor(S.level*0.6);
      spawnWave();
    }
  }

  // ----------------- damage numbers -----------------
  function addDamageText(x,y,amount,crit,isPlayerHit=false){
    const txt = Math.max(1, Math.round(amount)).toString();
    damageTexts.push({
      x, y,
      vy: rnd(-55,-85),
      vx: rnd(-18,18),
      t: 0,
      life: isPlayerHit ? 0.85 : 0.75,
      txt,
      crit,
      isPlayerHit
    });
  }

  // ----------------- combat -----------------
  function damageForPlayer(){
    const st=S.stats;
    const base=18 + st.dmg*6;
    const critChance=0.03 + st.crt*0.025;
    const crit=Math.random()<critChance;
    return { dmg: crit ? base*1.9 : base, crit };
  }

  function nearestEnemy(){
    if(!enemies.length) return null;
    let best=null, bd=1e9;
    for(const e of enemies){
      const d=dist(player.x,player.y,e.x,e.y);
      if(d<bd){ bd=d; best=e; }
    }
    return best;
  }

  function hitBurst(x,y,crit){
    for(let i=0;i<10;i++){
      particles.push({
        x,y,
        vx:rnd(-200,200),
        vy:rnd(-240,90),
        life:rnd(0.22,0.44),
        t:0,
        r:rnd(1.6,3.6),
        crit
      });
    }
  }

  function spawnTrail(){
    const t=S.cosmetics.trail;
    if(t==='none') return;

    trails.push({
      x:player.x, y:player.y,
      r: player.r*(t==='smoke'?1.05:0.85),
      life: t==='smoke'?0.60: (t==='plasma'?0.45:0.38),
      t:0,
      kind:t
    });
  }

  function takeDamage(amount){
    let left = amount;
    if(player.shield > 0){
      const use = Math.min(player.shield, left);
      player.shield -= use;
      left -= use;
    }
    if(left > 0) player.hp -= left;
    addDamageText(player.x, player.y - 18, amount, false, true);
  }

  function doAttack(){
    if(player.atkCd > 0) return;
    const e = nearestEnemy();
    if(!e) return;

    const d = dist(player.x,player.y,e.x,e.y);
    if(d > player.r + e.r + 26) return;

    player.atkCd = 0.24;
    const {dmg,crit} = damageForPlayer();
    e.hp -= dmg;
    e.hitFlash = 0.12;

    // hit FX
    if(S.cosmetics.hitFx === 'slash'){
      for(let i=0;i<7;i++){
        particles.push({ x:e.x, y:e.y, vx:rnd(-260,260), vy:rnd(-260,260), life:rnd(0.18,0.30), t:0, r:rnd(1.2,2.8), crit:true, slash:true });
      }
    }else if(S.cosmetics.hitFx === 'nova' && crit){
      fireConfetti(e.x, e.y, 22, 0.75, true);
    }

    hitBurst(e.x,e.y,crit);
    addDamageText(e.x, e.y - e.r - 10, dmg, crit, false);

    const nx=(e.x-player.x)/(d||1), ny=(e.y-player.y)/(d||1);
    e.vx += nx*140;
    e.vy += ny*140;
  }

  // boss bullet
  function bossShoot(boss){
    const dx = player.x - boss.x;
    const dy = player.y - boss.y;
    const d = Math.hypot(dx,dy) || 1;
    const speed = 420 + S.level*6;
    bullets.push({
      x: boss.x + (dx/d)*(boss.r+6),
      y: boss.y + (dy/d)*(boss.r+6),
      vx: (dx/d)*speed,
      vy: (dy/d)*speed,
      r: 6,
      life: 3.0,
      t: 0,
      dmg: Math.max(8, boss.dmg*0.75)
    });
  }

  function enemyUpdate(e,dt){
    const pad=world.pad;

    // boss logic
    if(e.kind==='boss'){
      e.phase = (e.hp/e.maxHp < 0.5) ? 2 : 1;

      // cooldowns
      e.chargeCd -= dt;
      e.shootCd -= dt;
      e.summonCd -= dt;

      // charging state
      if(e.charging > 0){
        e.charging -= dt;
        e.vx = e.chargeVx;
        e.vy = e.chargeVy;
      }else{
        // normal chase
        const dx=player.x-e.x, dy=player.y-e.y;
        const d=Math.hypot(dx,dy)||1;

        e.vx += (dx/d)*e.spd*dt;
        e.vy += (dy/d)*e.spd*dt;

        // friction
        e.vx *= Math.pow(0.0005, dt);
        e.vy *= Math.pow(0.0005, dt);

        // skills triggers
        const wantCharge = (e.chargeCd<=0 && d>160);
        const wantShoot  = (e.shootCd<=0 && d>120);
        const wantSummon = (e.summonCd<=0);

        if(wantCharge){
          // charge toward player
          const cdx = dx/d, cdy = dy/d;
          const sp = (e.phase===2 ? 820 : 720);
          e.charging = (e.phase===2 ? 0.22 : 0.18);
          e.chargeVx = cdx*sp;
          e.chargeVy = cdy*sp;
          e.chargeCd = (e.phase===2 ? 2.2 : 2.8);
          fireConfetti(e.x,e.y,18,0.55,false,true);
        }else if(wantShoot){
          bossShoot(e);
          e.shootCd = (e.phase===2 ? 1.2 : 1.8);
        }else if(wantSummon){
          // summon 1-2 minions
          const n = (e.phase===2 ? (Math.random()<0.55?2:1) : 1);
          for(let i=0;i<n;i++){
            const kind = Math.random()<0.5 ? 'runner' : 'mob';
            spawnEnemy(kind);
            // relocate last spawned near boss
            const last = enemies[enemies.length-1];
            last.x = clamp(e.x + rnd(-90,90), pad, world.w()-pad);
            last.y = clamp(e.y + rnd(-90,90), world.topPad+pad, world.h()-pad);
          }
          e.summonCd = (e.phase===2 ? 4.0 : 5.6);
          fireConfetti(e.x,e.y,26,0.75,true);
        }
      }

      e.x += e.vx*dt;
      e.y += e.vy*dt;

      e.x = clamp(e.x, pad, world.w()-pad);
      e.y = clamp(e.y, world.topPad+pad, world.h()-pad);

      // melee hit
      e.atkCd -= dt;
      const dxp=player.x-e.x, dyp=player.y-e.y;
      const dp=Math.hypot(dxp,dyp)||1;
      const range = e.r + player.r + 22;
      if(e.atkCd<=0 && dp < range){
        e.atkCd = (e.phase===2 ? 0.45 : 0.60);
        takeDamage(e.dmg);
        player.hitFlash = 0.12;
        hitBurst(player.x,player.y,false);
        const nx=(player.x-e.x)/(dp||1), ny=(player.y-e.y)/(dp||1);
        player.vx += nx*260;
        player.vy += ny*260;

        if(player.hp <= 0){
          player.hp = 0;
          paused = true;
          setTimeout(()=>{
            alert("–ù–£ –¢–´ –ò –õ–û–• üòà\n(—à—É—Ç–∫–∞)\n\n–û–ö ‚Äî –Ω–∞—á–Ω—ë—à—å —É—Ä–æ–≤–µ–Ω—å –∑–∞–Ω–æ–≤–æ.");
            paused = false;
            startLevel();
            updateUI();
            save();
          }, 30);
        }
      }

      e.hitFlash = Math.max(0, e.hitFlash - dt);
      return;
    }

    // normal enemies
    const dx=player.x-e.x, dy=player.y-e.y;
    const d=Math.hypot(dx,dy)||1;

    e.vx += (dx/d)*e.spd*dt;
    e.vy += (dy/d)*e.spd*dt;

    e.vx *= Math.pow(0.0006, dt);
    e.vy *= Math.pow(0.0006, dt);

    e.x += e.vx*dt;
    e.y += e.vy*dt;

    e.x = clamp(e.x, pad, world.w()-pad);
    e.y = clamp(e.y, world.topPad+pad, world.h()-pad);

    e.atkCd -= dt;
    const range = e.r + player.r + 12;
    if(e.atkCd<=0 && d < range){
      e.atkCd = 0.75;
      takeDamage(e.dmg);
      player.hitFlash = 0.12;
      hitBurst(player.x,player.y,false);
      const nx=(player.x-e.x)/(d||1), ny=(player.y-e.y)/(d||1);
      player.vx += nx*240;
      player.vy += ny*240;

      if(player.hp <= 0){
        player.hp = 0;
        paused = true;
        setTimeout(()=>{
          alert("–ù–£ –¢–´ –ò –õ–û–• üòà\n(—à—É—Ç–∫–∞)\n\n–û–ö ‚Äî –Ω–∞—á–Ω—ë—à—å —É—Ä–æ–≤–µ–Ω—å –∑–∞–Ω–æ–≤–æ.");
          paused = false;
          startLevel();
          updateUI();
          save();
        }, 30);
      }
    }

    e.hitFlash = Math.max(0, e.hitFlash - dt);
  }

  // ----------------- skills -----------------
  function tryDash(dirX, dirY){
    if(player.dashCd > 0 || player.dashTime > 0) return false;

    let dx=dirX, dy=dirY;
    let m=Math.hypot(dx,dy);

    if(m < 0.01){
      const e = nearestEnemy();
      if(e){
        dx = e.x - player.x;
        dy = e.y - player.y;
        m = Math.hypot(dx,dy);
      }
    }
    if(m < 0.01){ dx=0; dy=-1; m=1; }
    dx/=m; dy/=m;

    player.dashTime = 0.16;
    const dashSpeed = 740;
    player.dashVx = dx*dashSpeed;
    player.dashVy = dy*dashSpeed;
    player.dashCd = 2.6;

    fireConfetti(player.x, player.y, 20, 0.55, true);
    return true;
  }

  function tryShield(){
    if(player.shieldCd > 0 || player.shieldTime > 0) return false;
    applyStats();
    player.shield = player.shieldMax;
    player.shieldTime = 3.2;
    player.shieldCd = 7.5;
    fireConfetti(player.x, player.y, 26, 0.70, false, true);
    return true;
  }

  // ----------------- gestures -----------------
  let pointer = {
    active:false,
    id:null,
    x:0, y:0,
    startX:0, startY:0,
    startT:0,
    lastX:0, lastY:0,
    moved:false,
    vx:0, vy:0
  };

  let lastTapT = 0;
  let twoFingerTapTimer = 0;

  let moveTarget = { active:false, x:player.x, y:player.y };

  function setMoveTarget(x,y){
    moveTarget.active = true;
    moveTarget.x = x;
    moveTarget.y = y;
  }
  function clearMoveTarget(){ moveTarget.active=false; }

  canvas.addEventListener('touchstart', (e)=>{
    e.preventDefault();

    if(e.touches.length >= 2){
      twoFingerTapTimer = performance.now();
      return;
    }

    const t = e.changedTouches[0];
    pointer.active = true;
    pointer.id = t.identifier;
    pointer.x = pointer.lastX = pointer.startX = t.clientX;
    pointer.y = pointer.lastY = pointer.startY = t.clientY;
    pointer.startT = performance.now();
    pointer.moved = false;

    setMoveTarget(pointer.x, pointer.y);
  }, {passive:false});

  canvas.addEventListener('touchmove', (e)=>{
    e.preventDefault();
    if(e.touches.length >= 2) return;

    const list = [...e.changedTouches];
    const t = list.find(tt => tt.identifier === pointer.id);
    if(!t || !pointer.active) return;

    const now = performance.now();
    const dx = t.clientX - pointer.lastX;
    const dy = t.clientY - pointer.lastY;
    const dt = Math.max(1, now - (pointer._lt || now));
    pointer._lt = now;

    pointer.vx = dx / dt;
    pointer.vy = dy / dt;

    pointer.lastX = pointer.x;
    pointer.lastY = pointer.y;

    pointer.x = t.clientX;
    pointer.y = t.clientY;

    const totalMove = Math.hypot(pointer.x-pointer.startX, pointer.y-pointer.startY);
    if(totalMove > 10) pointer.moved = true;

    setMoveTarget(pointer.x, pointer.y);
  }, {passive:false});

  canvas.addEventListener('touchend', (e)=>{
    e.preventDefault();
    const now = performance.now();

    if(twoFingerTapTimer){
      const dt = now - twoFingerTapTimer;
      twoFingerTapTimer = 0;
      if(dt < 240){
        tryShield();
        return;
      }
    }

    const list = [...e.changedTouches];
    const t = list.find(tt => tt.identifier === pointer.id);
    if(!t || !pointer.active) return;

    const dur = now - pointer.startT;
    const total = Math.hypot(pointer.x-pointer.startX, pointer.y-pointer.startY);

    const speed = Math.hypot(pointer.vx, pointer.vy);
    const fastSwipe = (dur < 220 && total > 55) || (speed > 1.25 && total > 45);

    if(fastSwipe){
      const dx = pointer.x - pointer.startX;
      const dy = pointer.y - pointer.startY;
      tryDash(dx, dy);
    }else{
      if(dur < 220 && total < 14){
        if(now - lastTapT < 260){
          tryDash(0,0);
        }else{
          doAttack();
        }
        lastTapT = now;
      }
    }

    pointer.active = false;
    pointer.id = null;
    clearMoveTarget();
  }, {passive:false});

  canvas.addEventListener('touchcancel', (e)=>{
    e.preventDefault();
    pointer.active=false;
    pointer.id=null;
    clearMoveTarget();
    twoFingerTapTimer=0;
  }, {passive:false});

  // mouse fallback
  let mouseDown=false;
  canvas.addEventListener('mousedown', (e)=>{
    mouseDown=true;
    pointer.active=true;
    pointer.id='mouse';
    pointer.x = pointer.startX = e.clientX;
    pointer.y = pointer.startY = e.clientY;
    pointer.startT = performance.now();
    setMoveTarget(pointer.x, pointer.y);
  });
  window.addEventListener('mousemove', (e)=>{
    if(!mouseDown) return;
    pointer.x=e.clientX; pointer.y=e.clientY;
    setMoveTarget(pointer.x, pointer.y);
  });
  window.addEventListener('mouseup', ()=>{
    if(!mouseDown) return;
    mouseDown=false;
    const now=performance.now();
    const dur=now-pointer.startT;
    const total=Math.hypot(pointer.x-pointer.startX, pointer.y-pointer.startY);
    if(dur<220 && total<10) doAttack();
    pointer.active=false;
    pointer.id=null;
    clearMoveTarget();
  });

  // ----------------- confetti / fireworks -----------------
  function fireConfetti(x,y,amount=26,power=0.7, gold=false, purple=false){
    for(let i=0;i<amount;i++){
      const ang = rnd(0, Math.PI*2);
      const sp  = rnd(220, 720) * power;
      const size= rnd(2.2, 4.8);
      const life= rnd(0.55, 1.05);
      const spin= rnd(-14, 14);

      const pal = purple
        ? ['#B47CFF','#7AA7FF','#FFFFFF']
        : gold
          ? ['#FFD56A','#FF6B8B','#FFFFFF']
          : ['#7AA7FF','#B47CFF','#FFD56A','#7CFFB2','#FFFFFF'];

      confetti.push({
        x, y,
        vx: Math.cos(ang)*sp,
        vy: Math.sin(ang)*sp - rnd(60,220),
        g: rnd(520, 980),
        r: size,
        life,
        t: 0,
        rot: rnd(0, Math.PI*2),
        spin,
        col: pal[(Math.random()*pal.length)|0],
        rect: Math.random()<0.55
      });
    }
  }

  // ----------------- chests -----------------
  const CHEST = {
    common:{ keyCost:1, coinCost:200, name:'–û–±—ã—á–Ω—ã–π', icon:'üéÅ' },
    rare:{ keyCost:2, coinCost:350, name:'–†–µ–¥–∫–∏–π', icon:'üéÅ' },
    legend:{ keyCost:3, coinCost:500, name:'–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', icon:'üèÜ' }
  };

  function randPick(arr){
    const total = arr.reduce((s,x)=>s+x.w,0);
    let r = Math.random()*total;
    for(const it of arr){
      r -= it.w;
      if(r<=0) return it;
    }
    return arr[arr.length-1];
  }

  const ownSkin = k => !!S.cosmetics.ownedSkins[k];
  const ownTrail = k=> !!S.cosmetics.ownedTrails[k];
  const ownAura = k=> !!S.cosmetics.ownedAuras[k];
  const ownHitFx = k=> !!S.cosmetics.ownedHitFx[k];
  const ownTheme = k=> !!S.cosmetics.ownedThemes[k];

  function grantCosmetic(tier){
    const skins=['ice','neon','gold','shadow'];
    const trailsList=['sparks','smoke','glitch','plasma'];
    const auras=['glow','pulse'];
    const hitfx=['slash','nova'];
    const themes=['cyber','void'];

    const pool=[];
    const w = tier==='legend'?3: tier==='rare'?2:1;

    const pickFrom = (arr, ownFn, type) => {
      const not = arr.filter(x=>!ownFn(x));
      (not.length?not:arr).forEach(id=>pool.push({type,id,w}));
    };

    pickFrom(skins, ownSkin, 'skin');
    pickFrom(trailsList, ownTrail, 'trail');
    pickFrom(auras, ownAura, 'aura');
    pickFrom(hitfx, ownHitFx, 'hitFx');
    pickFrom(themes, ownTheme, 'theme');

    const p = randPick(pool);

    if(p.type==='skin'){ S.cosmetics.ownedSkins[p.id]=true; S.cosmetics.skin=p.id; return `üé® —Å–∫–∏–Ω "${p.id}" (–Ω–∞–¥–µ—Ç)`; }
    if(p.type==='trail'){ S.cosmetics.ownedTrails[p.id]=true; S.cosmetics.trail=p.id; return `‚ú® —Ç—Ä–µ–π–ª "${p.id}" (–Ω–∞–¥–µ—Ç)`; }
    if(p.type==='aura'){ S.cosmetics.ownedAuras[p.id]=true; S.cosmetics.aura=p.id; return `üü£ –∞—É—Ä–∞ "${p.id}" (–Ω–∞–¥–µ—Ç–∞)`; }
    if(p.type==='hitFx'){ S.cosmetics.ownedHitFx[p.id]=true; S.cosmetics.hitFx=p.id; return `‚ö° HitFX "${p.id}" (–≤–∫–ª—é—á–µ–Ω)`; }
    S.cosmetics.ownedThemes[p.id]=true; S.cosmetics.theme=p.id; return `üéõÔ∏è —Ç–µ–º–∞ "${p.id}" (–≤–∫–ª—é—á–µ–Ω–∞)`;
  }

  function wait(ms){ return new Promise(res=>setTimeout(res, ms)); }

  async function playChestAnim(icon, title){
    openAnim.classList.add('show');
    chestIcon.textContent = icon;
    animText.textContent = title;
    chestBox.classList.remove('shake');

    await wait(80);
    chestBox.classList.add('shake');

    await wait(520);
    fireConfetti(innerWidth*0.5, innerHeight*0.42, 44, 0.9, true);
    await wait(220);

    openAnim.classList.remove('show');
  }

  async function openChest(tier){
    const cfg = CHEST[tier];

    if(S.keys >= cfg.keyCost){
      S.keys -= cfg.keyCost;
    }else{
      if(S.coins < cfg.coinCost){
        showToast(`–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç üîë –∏–ª–∏ üí∞ –¥–ª—è "${cfg.name}"`);
        return;
      }
      S.coins -= cfg.coinCost;
    }

    updateUI(); save();
    await playChestAnim(cfg.icon, `–û—Ç–∫—Ä—ã–≤–∞–µ–º "${cfg.name}"‚Ä¶`);

    const tables = {
      common:[
        {w:54, fn:()=>{const c=200+Math.floor(rnd(0,120)); addCoins(c); return `üí∞ +${c}`;}},
        {w:18, fn:()=>{const c=450+Math.floor(rnd(0,250)); addCoins(c); return `üí∞ +${c}`;}},
        {w:15, fn:()=>{S.sp+=1; return `‚≠ê SP +1`;}},
        {w:8,  fn:()=>{S.sp+=2; return `‚≠ê SP +2`;}},
        {w:5,  fn:()=>`–ö–æ—Å–º–µ—Ç–∏–∫–∞: ${grantCosmetic('common')}`},
      ],
      rare:[
        {w:36, fn:()=>{const c=350+Math.floor(rnd(0,180)); addCoins(c); return `üí∞ +${c}`;}},
        {w:22, fn:()=>{const c=700+Math.floor(rnd(0,350)); addCoins(c); return `üí∞ +${c}`;}},
        {w:20, fn:()=>{S.sp+=2; return `‚≠ê SP +2`;}},
        {w:12, fn:()=>{S.sp+=3; return `‚≠ê SP +3`;}},
        {w:10, fn:()=>`–ö–æ—Å–º–µ—Ç–∏–∫–∞: ${grantCosmetic('rare')}`},
      ],
      legend:[
        {w:16, fn:()=>{const c=600+Math.floor(rnd(0,250)); addCoins(c); return `üí∞ +${c}`;}},
        {w:22, fn:()=>{const c=1200+Math.floor(rnd(0,600)); addCoins(c); return `üí∞ +${c}`;}},
        {w:18, fn:()=>{S.sp+=4; return `‚≠ê SP +4`;}},
        {w:14, fn:()=>{S.sp+=6; return `‚≠ê SP +6`;}},
        {w:30, fn:()=>`–ö–æ—Å–º–µ—Ç–∏–∫–∞: ${grantCosmetic('legend')}`},
      ]
    };

    const pick = randPick(tables[tier]);
    const text = pick.fn();

    lootText.textContent = `–°—É–Ω–¥—É–∫ "${cfg.name}": ${text}`;
    showToast(`üéâ ${text}`);
    fireConfetti(innerWidth*0.5, innerHeight*0.48, tier==='legend'?58:44, tier==='legend'?1.0:0.85, true);

    updateUI(); save();
  }

  // ----------------- shop system -----------------
  function canPay(cost){ return S.coins >= cost; }
  function pay(cost){ if(!canPay(cost)) return false; S.coins -= cost; return true; }

  function equipSkin(k){ if(!ownSkin(k)) return; S.cosmetics.skin=k; updateUI(); save(); }
  function equipTrail(k){ if(!ownTrail(k)) return; S.cosmetics.trail=k; updateUI(); save(); }
  function equipAura(k){ if(!ownAura(k)) return; S.cosmetics.aura=k; updateUI(); save(); }
  function equipHitFx(k){ if(!ownHitFx(k)) return; S.cosmetics.hitFx=k; updateUI(); save(); }
  function equipTheme(k){ if(!ownTheme(k)) return; S.cosmetics.theme=k; updateUI(); save(); }

  function buyCosmetic(cost, alreadyOwned, onBuy, msgBuy, msgEquip){
    if(alreadyOwned()){
      onBuy(false);
      showToast(msgEquip);
      fireConfetti(innerWidth*0.5, innerHeight*0.45, 26, 0.75, true);
      return true;
    }
    if(!pay(cost)){
      showToast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç üí∞');
      return false;
    }
    onBuy(true);
    showToast(msgBuy);
    fireConfetti(innerWidth*0.5, innerHeight*0.45, 44, 0.9, true);
    return true;
  }

  // ----------------- admin -----------------
  function setAdminUI(){
    const on=!!S.adminUnlocked;
    adminState.textContent = `–°—Ç–∞—Ç—É—Å: ${on?'üîì –æ—Ç–∫—Ä—ã—Ç–æ':'üîí –∑–∞–∫—Ä—ã—Ç–æ'}`;
    const arr=[giveCoins1,giveCoins2,giveSP1,giveSP2,giveKeys1,giveKeys2];
    arr.forEach(b=>{
      b.disabled = !on;
      b.style.opacity = !on ? 0.55 : 1;
    });
  }
  function guardAdmin(){
    if(!S.adminUnlocked){ alert('–ê–¥–º–∏–Ω–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞. –í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å.'); return false; }
    return true;
  }

  // ----------------- UI update -----------------
  function updateUI(){
    uiLevel.textContent = S.level;
    uiCoins.textContent = S.coins;
    uiKeys.textContent = S.keys;

    uiHpText.textContent = `${Math.ceil(player.hp)}/${player.maxHp}`;
    uiShieldText.textContent = `${Math.ceil(player.shield)}`;
    uiHpBar.style.width = `${clamp((player.hp/player.maxHp)*100,0,100)}%`;
    uiShieldBar.style.width = `${clamp(((player.shield/player.shieldMax)||0)*100,0,100)}%`;

    const need = xpNeed(S.level);
    uiXpText.textContent = `${S.xp}/${need}`;
    uiXpBar.style.width = `${clamp((S.xp/need)*100,0,100)}%`;

    uiStage.textContent = stageName();

    uiSP.textContent = S.sp;
    uiDmg.textContent = S.stats.dmg;
    uiVit.textContent = S.stats.vit;
    uiSpd.textContent = S.stats.spd;
    uiCrt.textContent = S.stats.crt;

    uiShopCoins.textContent = S.coins;
    uiSkin.textContent = S.cosmetics.skin;
    uiTrail.textContent = S.cosmetics.trail;
    uiAura.textContent = S.cosmetics.aura;
    uiHitFx.textContent = S.cosmetics.hitFx;
    uiTheme.textContent = S.cosmetics.theme;

    uiChestCoins.textContent = S.coins;
    uiChestKeys.textContent = S.keys;

    // cooldown indicators
    if(player.dashCd > 0){
      chipDash.classList.add('cool');
      cdDash.textContent = player.dashCd.toFixed(1);
    }else chipDash.classList.remove('cool');

    if(player.shieldCd > 0){
      chipShield.classList.add('cool');
      cdShield.textContent = player.shieldCd.toFixed(1);
    }else chipShield.classList.remove('cool');

    // button labels (buy/equip)
    const label = (owned, equipped)=> owned ? (equipped ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';

    buySkinIce.textContent = label(ownSkin('ice'), S.cosmetics.skin==='ice');
    buySkinNeon.textContent = label(ownSkin('neon'), S.cosmetics.skin==='neon');
    buySkinGold.textContent = label(ownSkin('gold'), S.cosmetics.skin==='gold');
    buySkinShadow.textContent = label(ownSkin('shadow'), S.cosmetics.skin==='shadow');

    buyTrailSparks.textContent = label(ownTrail('sparks'), S.cosmetics.trail==='sparks');
    buyTrailSmoke.textContent = label(ownTrail('smoke'), S.cosmetics.trail==='smoke');
    buyTrailGlitch.textContent = label(ownTrail('glitch'), S.cosmetics.trail==='glitch');
    buyTrailPlasma.textContent = label(ownTrail('plasma'), S.cosmetics.trail==='plasma');

    buyAuraGlow.textContent = label(ownAura('glow'), S.cosmetics.aura==='glow');
    buyAuraPulse.textContent = label(ownAura('pulse'), S.cosmetics.aura==='pulse');

    buyHitSlash.textContent = label(ownHitFx('slash'), S.cosmetics.hitFx==='slash');
    buyHitNova.textContent = label(ownHitFx('nova'), S.cosmetics.hitFx==='nova');

    buyThemeCyber.textContent = label(ownTheme('cyber'), S.cosmetics.theme==='cyber');
    buyThemeVoid.textContent = label(ownTheme('void'), S.cosmetics.theme==='void');

    setAdminUI();
  }

  // ----------------- draw helpers -----------------
  function roundRect(c,x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2);
    c.moveTo(x+rr,y);
    c.arcTo(x+w,y,x+w,y+h,rr);
    c.arcTo(x+w,y+h,x,y+h,rr);
    c.arcTo(x,y+h,x,y,rr);
    c.arcTo(x,y,x+w,y,rr);
    c.closePath();
  }

  function drawBg(){
    const w=world.w(), h=world.h();

    // base fill (background is set on canvas, still we clear)
    ctx.fillStyle = '#050611';
    ctx.fillRect(0,0,w,h);

    // grid
    const ts = themeStyle();
    ctx.globalAlpha = ts.gridAlpha;
    ctx.strokeStyle = ts.grid;
    ctx.lineWidth = 1;
    const step = (S.cosmetics.theme==='cyber') ? 40 : 44;
    ctx.beginPath();
    for(let x=0;x<w;x+=step){ ctx.moveTo(x,0); ctx.lineTo(x,h); }
    for(let y=0;y<h;y+=step){ ctx.moveTo(0,y); ctx.lineTo(w,y); }
    ctx.stroke();
    ctx.globalAlpha = 1;

    // border
    const pad=world.pad;
    ctx.strokeStyle = ts.border;
    ctx.lineWidth = 2;
    ctx.strokeRect(pad, world.topPad+pad, w-pad*2, h-(pad*2+world.topPad));
  }

  function drawCircle(x,y,r,color,flash=0, glow=0){
    ctx.save();
    ctx.shadowColor = flash>0 ? 'rgba(255,255,255,.92)' : (glow>0 ? color : 'rgba(0,0,0,.65)');
    ctx.shadowBlur = flash>0 ? 18 : (glow>0 ? glow : 12);
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  function drawHpBar(x,y,w,h,ratio,color){
    ctx.save();
    ctx.fillStyle='rgba(0,0,0,.32)';
    ctx.strokeStyle='rgba(255,255,255,.10)';
    ctx.lineWidth=1;
    ctx.beginPath(); roundRect(ctx,x,y,w,h,999); ctx.fill(); ctx.stroke();
    ctx.fillStyle=color;
    ctx.beginPath(); roundRect(ctx,x,y,w*clamp(ratio,0,1),h,999); ctx.fill();
    ctx.restore();
  }

  function drawAura(){
    const a = S.cosmetics.aura;
    if(a==='none') return;
    const pulse = (a==='pulse');
    const t = performance.now()/1000;
    const rr = player.r + (pulse ? (10 + 4*Math.sin(t*5)) : 10);
    const alpha = pulse ? (0.22 + 0.10*Math.sin(t*4)) : 0.22;

    ctx.save();
    ctx.globalAlpha = alpha;
    const grd = ctx.createRadialGradient(player.x,player.y, player.r, player.x,player.y, rr+18);
    grd.addColorStop(0, 'rgba(180,124,255,.0)');
    grd.addColorStop(0.35, 'rgba(180,124,255,.35)');
    grd.addColorStop(1, 'rgba(180,124,255,.0)');
    ctx.fillStyle = grd;
    ctx.beginPath();
    ctx.arc(player.x,player.y, rr+18, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  // ----------------- draw -----------------
  function draw(){
    drawBg();

    // trails
    for(const t of trails){
      const a = 1 - (t.t/t.life);
      ctx.globalAlpha = a * (t.kind==='smoke' ? 0.18 : (t.kind==='plasma'?0.34:0.30));
      if(t.kind==='sparks'){
        ctx.fillStyle = 'rgba(255,213,106,1)';
      }else if(t.kind==='glitch'){
        ctx.fillStyle = Math.random()<0.5 ? 'rgba(122,167,255,1)' : 'rgba(180,124,255,1)';
      }else if(t.kind==='plasma'){
        ctx.fillStyle = 'rgba(180,124,255,1)';
      }else{
        ctx.fillStyle = 'rgba(255,255,255,1)';
      }
      ctx.beginPath();
      ctx.arc(t.x, t.y, t.r*(0.9+(t.t/t.life)*0.6), 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // bullets
    for(const b of bullets){
      ctx.save();
      ctx.globalAlpha = 0.9;
      drawCircle(b.x, b.y, b.r+2, 'rgba(0,0,0,.45)', 0, 0);
      drawCircle(b.x, b.y, b.r, '#FF6B8B', 0, 18);
      ctx.restore();
    }

    // enemies
    for(const e of enemies){
      const isBoss = e.kind==='boss';
      const c = isBoss ? '#FF6B8B' : (e.kind==='runner' ? '#FFD56A' : (e.kind==='brute' ? '#7CFFB2' : '#FFFFFF'));
      const glow = isBoss ? 24 : 0;

      drawCircle(e.x,e.y,e.r+3,'rgba(0,0,0,.42)');
      drawCircle(e.x,e.y,e.r,c,e.hitFlash, glow);

      // boss crown
      if(isBoss){
        ctx.save();
        ctx.globalAlpha = 0.9;
        ctx.fillStyle = 'rgba(255,213,106,.9)';
        ctx.font = '900 12px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.textAlign='center';
        ctx.fillText('BOSS', e.x, e.y - e.r - 18);
        ctx.restore();
      }

      drawHpBar(e.x-28, e.y-e.r-14, 56, 8, e.hp/e.maxHp, isBoss?'rgba(255,107,139,.95)':'rgba(255,255,255,.75)');
    }

    // player aura
    drawAura();

    // player
    const pc = skinColor(S.cosmetics.skin);
    drawCircle(player.x,player.y,player.r+3,'rgba(0,0,0,.45)');
    drawCircle(player.x,player.y,player.r,pc,player.hitFlash, 18);

    // shield ring
    if(player.shield>0){
      ctx.save();
      ctx.globalAlpha = 0.55 + 0.25*Math.sin(performance.now()/130);
      ctx.strokeStyle = 'rgba(180,124,255,.98)';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.r+11, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    // hit particles
    for(const p of particles){
      const a=1-(p.t/p.life);
      ctx.globalAlpha=a;
      if(p.slash){
        ctx.fillStyle = 'rgba(255,255,255,1)';
      }else{
        ctx.fillStyle=p.crit ? 'rgba(255,213,106,1)' : 'rgba(255,255,255,1)';
      }
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha=1;

    // confetti
    for(const c of confetti){
      const a = 1 - (c.t / c.life);
      ctx.globalAlpha = Math.max(0,a);
      ctx.save();
      ctx.translate(c.x, c.y);
      ctx.rotate(c.rot);
      ctx.fillStyle = c.col;
      if(c.rect){
        ctx.fillRect(-c.r*1.3, -c.r*0.7, c.r*2.6, c.r*1.4);
      }else{
        ctx.beginPath();
        ctx.arc(0,0,c.r,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }
    ctx.globalAlpha=1;

    // damage numbers
    ctx.save();
    ctx.textAlign='center';
    for(const d of damageTexts){
      const a = 1 - (d.t/d.life);
      ctx.globalAlpha = Math.max(0,a);

      if(d.isPlayerHit){
        ctx.fillStyle = 'rgba(255,107,139,1)';
        ctx.font = '900 14px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.fillText('-' + d.txt, d.x, d.y);
      }else{
        ctx.fillStyle = d.crit ? 'rgba(255,213,106,1)' : 'rgba(255,255,255,1)';
        ctx.font = d.crit ? '950 16px system-ui, -apple-system, Segoe UI, Roboto' : '900 14px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.fillText(d.txt, d.x, d.y);
        if(d.crit){
          ctx.globalAlpha = Math.max(0,a*0.55);
          ctx.strokeStyle = 'rgba(0,0,0,.55)';
          ctx.lineWidth = 3;
          ctx.strokeText(d.txt, d.x, d.y);
        }
      }
    }
    ctx.restore();
  }

  // ----------------- update loop -----------------
  function clampToArena(){
    const pad=world.pad;
    player.x = clamp(player.x, pad, world.w()-pad);
    player.y = clamp(player.y, world.topPad+pad, world.h()-pad);
  }

  function updatePlayer(dt){
    player.atkCd = Math.max(0, player.atkCd - dt);
    player.dashCd = Math.max(0, player.dashCd - dt);
    player.shieldCd = Math.max(0, player.shieldCd - dt);

    if(player.shieldTime > 0){
      player.shieldTime -= dt;
      if(player.shieldTime <= 0) player.shieldTime = 0;
    }

    if(player.dashTime > 0){
      player.dashTime -= dt;
      player.vx = player.dashVx;
      player.vy = player.dashVy;
    }else{
      if(moveTarget.active){
        const dx = moveTarget.x - player.x;
        const dy = moveTarget.y - player.y;
        const d = Math.hypot(dx,dy) || 1;

        const speed = player.baseSpeed * clamp(d/120, 0.35, 1.25);
        const tx = (dx/d) * speed;
        const ty = (dy/d) * speed;

        player.vx += (tx - player.vx) * (1 - Math.pow(0.001, dt));
        player.vy += (ty - player.vy) * (1 - Math.pow(0.001, dt));
      }else{
        player.vx *= Math.pow(0.0008, dt);
        player.vy *= Math.pow(0.0008, dt);
      }
    }

    player.x += player.vx * dt;
    player.y += player.vy * dt;
    clampToArena();

    if(S.cosmetics.trail!=='none' && (Math.abs(player.vx)+Math.abs(player.vy) > 60)){
      if(Math.random() < 0.44) spawnTrail();
    }

    // auto poke (helps)
    const e = nearestEnemy();
    if(e){
      const d = dist(player.x,player.y,e.x,e.y);
      if(d < player.r + e.r + 24 && player.atkCd <= 0){
        doAttack();
      }
    }

    player.hitFlash = Math.max(0, player.hitFlash - dt);
  }

  function updateBullets(dt){
    for(let i=bullets.length-1;i>=0;i--){
      const b = bullets[i];
      b.t += dt;
      b.x += b.vx*dt;
      b.y += b.vy*dt;

      // hit player
      const d = dist(b.x,b.y, player.x,player.y);
      if(d < b.r + player.r){
        bullets.splice(i,1);
        takeDamage(b.dmg);
        fireConfetti(b.x,b.y,18,0.6,false,true);
        continue;
      }

      if(b.t >= b.life){
        bullets.splice(i,1);
        continue;
      }

      // out of arena
      if(b.x < -50 || b.x > world.w()+50 || b.y < -50 || b.y > world.h()+50){
        bullets.splice(i,1);
      }
    }
  }

  function updateParticles(dt){
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.t += dt;
      p.x += p.vx*dt;
      p.y += p.vy*dt;
      p.vy += 520*dt;
      if(p.t >= p.life) particles.splice(i,1);
    }
    for(let i=trails.length-1;i>=0;i--){
      const t=trails[i];
      t.t += dt;
      if(t.t >= t.life) trails.splice(i,1);
    }
    for(let i=confetti.length-1;i>=0;i--){
      const c=confetti[i];
      c.t += dt;
      c.vy += c.g * dt;
      c.x += c.vx * dt;
      c.y += c.vy * dt;
      c.vx *= Math.pow(0.04, dt);
      c.rot += c.spin * dt;
      if(c.t >= c.life) confetti.splice(i,1);
    }
    for(let i=damageTexts.length-1;i>=0;i--){
      const d=damageTexts[i];
      d.t += dt;
      d.x += d.vx * dt * 60;
      d.y += d.vy * dt;
      d.vy += 60*dt; // —á—É—Ç—å –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è –≤–≤–µ—Ä—Ö
      if(d.t >= d.life) damageTexts.splice(i,1);
    }
  }

  function maybeComplete(){
    if(enemies.length !== 0) return;

    if(isBossLevel(S.level)){
      let k=1;
      if(Math.random() < 0.18) k=2;
      addKeys(k);
      showToast(`–ë–æ—Å—Å: üîë +${k}`);
      fireConfetti(innerWidth*0.5, innerHeight*0.38, 48, 0.95, true);

      S.level += 1;
      S.sp += 1;
      player.hp = clamp(player.hp + player.maxHp*0.45, 0, player.maxHp);

      startLevel();
      save();
      return;
    }

    wave += 1;
    if(wave <= 3){
      enemiesToSpawn = 3 + Math.floor(S.level*0.6);
      spawnWave();
    }else{
      addXp(70 + Math.floor(S.level*18));
      addCoins(60 + Math.floor(S.level*10));
      S.level += 1;
      S.sp += 1;
      startLevel();
      save();
    }
  }

  // ----------------- loop -----------------
  let last = performance.now();
  function loop(now){
    const dt = clamp((now-last)/1000, 0, 0.033);
    last = now;

    if(!paused){
      updatePlayer(dt);

      for(const e of enemies) enemyUpdate(e,dt);
      updateBullets(dt);

      // remove dead + rewards
      for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i];
        if(e.hp <= 0){
          enemies.splice(i,1);
          const baseXp = e.kind==='boss' ? 160 : 18;
          const coins = e.kind==='boss' ? 200 : (10 + Math.floor(S.level*0.35));
          addXp(baseXp + Math.floor(S.level*7));
          addCoins(coins);

          if(e.kind==='boss'){
            fireConfetti(e.x,e.y,54,1.0,true);
            showToast('–ë–æ—Å—Å —É–Ω–∏—á—Ç–æ–∂–µ–Ω üòà');
          }else{
            if(Math.random()<0.15) fireConfetti(e.x,e.y,14,0.55,false,true);
          }
        }
      }

      maybeComplete();
      updateParticles(dt);
      updateUI();
    }

    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ----------------- buttons -----------------
  btnPlay.addEventListener('click', ()=>{
    startOverlay.classList.remove('show');
    paused = false;
    startLevel();
    updateUI();
    save();
    showToast('–ü–æ–µ—Ö–∞–ª–∏ üòà');
  });

  btnHow.addEventListener('click', ()=>{
    alert(
      "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:\n" +
      "‚Äî –í–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º –≤ –ª—é–±–æ–π —á–∞—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞: –¥–≤–∏–∂–µ–Ω–∏–µ\n" +
      "‚Äî –¢–∞–ø: –∞—Ç–∞–∫–∞\n" +
      "‚Äî –ë—ã—Å—Ç—Ä—ã–π —Å–≤–∞–π–ø: —Ä—ã–≤–æ–∫\n" +
      "‚Äî –¢–∞–ø 2 –ø–∞–ª—å—Ü–∞–º–∏: —â–∏—Ç\n\n" +
      "–ë–æ—Å—Å:\n" +
      "‚Äî –†—ã–≤–æ–∫ (charge)\n" +
      "‚Äî –í—ã—Å—Ç—Ä–µ–ª—ã\n" +
      "‚Äî –ü—Ä–∏–∑—ã–≤ –º–∏–Ω—å–æ–Ω–æ–≤\n"
    );
  });

  btnResetSave.addEventListener('click', ()=>{
    if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")) return;
    localStorage.removeItem(SAVE_KEY);
    S = loadSave();
    applyStats();
    updateUI();
    startLevel();
    showToast('–°–±—Ä–æ—à–µ–Ω–æ');
  });

  btnShop.addEventListener('click', ()=> showOverlay(shopOverlay));
  btnChest.addEventListener('click', ()=> showOverlay(chestOverlay));
  btnUpgrades.addEventListener('click', ()=> showOverlay(upOverlay));
  btnMenu.addEventListener('click', ()=> showOverlay(menuOverlay));

  btnResume.addEventListener('click', ()=> hideOverlay('menuOverlay'));
  btnRestart.addEventListener('click', ()=>{
    hideOverlay('menuOverlay');
    startLevel();
    save();
    showToast('–ù–æ–≤—ã–π –∑–∞–±–µ–≥');
  });

  // upgrades
  const spendSP = ()=>{ if(S.sp<=0) return false; S.sp -= 1; return true; };
  upDmg.addEventListener('click', ()=>{ if(!spendSP()) return showToast('–ù–µ—Ç SP'); S.stats.dmg += 1; updateUI(); save(); showToast('DMG +1'); });
  upVit.addEventListener('click', ()=>{ if(!spendSP()) return showToast('–ù–µ—Ç SP'); S.stats.vit += 1; applyStats(); updateUI(); save(); showToast('VIT +1'); });
  upSpd.addEventListener('click', ()=>{ if(!spendSP()) return showToast('–ù–µ—Ç SP'); S.stats.spd += 1; applyStats(); updateUI(); save(); showToast('SPD +1'); });
  upCrt.addEventListener('click', ()=>{ if(!spendSP()) return showToast('–ù–µ—Ç SP'); S.stats.crt += 1; updateUI(); save(); showToast('CRT +1'); });

  // shop equip defaults
  equipDefault.addEventListener('click', ()=>{ equipSkin('default'); showToast('–°–∫–∏–Ω: default'); });
  equipNoneTrail.addEventListener('click', ()=>{ equipTrail('none'); showToast('–¢—Ä–µ–π–ª: none'); });
  equipNoneAura.addEventListener('click', ()=>{ equipAura('none'); showToast('–ê—É—Ä–∞: none'); });
  equipNoneHitFx.addEventListener('click', ()=>{ equipHitFx('none'); showToast('HitFX: none'); });
  equipDefaultTheme.addEventListener('click', ()=>{ equipTheme('default'); showToast('–¢–µ–º–∞: default'); });

  // shop purchases
  buySkinIce.addEventListener('click', ()=>{
    buyCosmetic(250, ()=>ownSkin('ice'), (fresh)=>{ if(fresh) S.cosmetics.ownedSkins.ice=true; equipSkin('ice'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: ice', '–ù–∞–¥–µ—Ç–æ: ice');
  });
  buySkinNeon.addEventListener('click', ()=>{
    buyCosmetic(400, ()=>ownSkin('neon'), (fresh)=>{ if(fresh) S.cosmetics.ownedSkins.neon=true; equipSkin('neon'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: neon', '–ù–∞–¥–µ—Ç–æ: neon');
  });
  buySkinGold.addEventListener('click', ()=>{
    buyCosmetic(600, ()=>ownSkin('gold'), (fresh)=>{ if(fresh) S.cosmetics.ownedSkins.gold=true; equipSkin('gold'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: gold', '–ù–∞–¥–µ—Ç–æ: gold');
  });
  buySkinShadow.addEventListener('click', ()=>{
    buyCosmetic(700, ()=>ownSkin('shadow'), (fresh)=>{ if(fresh) S.cosmetics.ownedSkins.shadow=true; equipSkin('shadow'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: shadow', '–ù–∞–¥–µ—Ç–æ: shadow');
  });

  buyTrailSparks.addEventListener('click', ()=>{
    buyCosmetic(300, ()=>ownTrail('sparks'), (fresh)=>{ if(fresh) S.cosmetics.ownedTrails.sparks=true; equipTrail('sparks'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: sparks', '–ù–∞–¥–µ—Ç–æ: sparks');
  });
  buyTrailSmoke.addEventListener('click', ()=>{
    buyCosmetic(300, ()=>ownTrail('smoke'), (fresh)=>{ if(fresh) S.cosmetics.ownedTrails.smoke=true; equipTrail('smoke'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: smoke', '–ù–∞–¥–µ—Ç–æ: smoke');
  });
  buyTrailGlitch.addEventListener('click', ()=>{
    buyCosmetic(450, ()=>ownTrail('glitch'), (fresh)=>{ if(fresh) S.cosmetics.ownedTrails.glitch=true; equipTrail('glitch'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: glitch', '–ù–∞–¥–µ—Ç–æ: glitch');
  });
  buyTrailPlasma.addEventListener('click', ()=>{
    buyCosmetic(500, ()=>ownTrail('plasma'), (fresh)=>{ if(fresh) S.cosmetics.ownedTrails.plasma=true; equipTrail('plasma'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: plasma', '–ù–∞–¥–µ—Ç–æ: plasma');
  });

  buyAuraGlow.addEventListener('click', ()=>{
    buyCosmetic(350, ()=>ownAura('glow'), (fresh)=>{ if(fresh) S.cosmetics.ownedAuras.glow=true; equipAura('glow'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: aura glow', '–ù–∞–¥–µ—Ç–æ: aura glow');
  });
  buyAuraPulse.addEventListener('click', ()=>{
    buyCosmetic(500, ()=>ownAura('pulse'), (fresh)=>{ if(fresh) S.cosmetics.ownedAuras.pulse=true; equipAura('pulse'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: aura pulse', '–ù–∞–¥–µ—Ç–æ: aura pulse');
  });

  buyHitSlash.addEventListener('click', ()=>{
    buyCosmetic(350, ()=>ownHitFx('slash'), (fresh)=>{ if(fresh) S.cosmetics.ownedHitFx.slash=true; equipHitFx('slash'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: HitFX slash', '–í–∫–ª—é—á–µ–Ω: HitFX slash');
  });
  buyHitNova.addEventListener('click', ()=>{
    buyCosmetic(600, ()=>ownHitFx('nova'), (fresh)=>{ if(fresh) S.cosmetics.ownedHitFx.nova=true; equipHitFx('nova'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: HitFX nova', '–í–∫–ª—é—á–µ–Ω: HitFX nova');
  });

  buyThemeCyber.addEventListener('click', ()=>{
    buyCosmetic(450, ()=>ownTheme('cyber'), (fresh)=>{ if(fresh) S.cosmetics.ownedThemes.cyber=true; equipTheme('cyber'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: —Ç–µ–º–∞ cyber', '–í–∫–ª—é—á–µ–Ω–∞: —Ç–µ–º–∞ cyber');
  });
  buyThemeVoid.addEventListener('click', ()=>{
    buyCosmetic(450, ()=>ownTheme('void'), (fresh)=>{ if(fresh) S.cosmetics.ownedThemes.void=true; equipTheme('void'); save(); }, '–ö—É–ø–ª–µ–Ω–æ: —Ç–µ–º–∞ void', '–í–∫–ª—é—á–µ–Ω–∞: —Ç–µ–º–∞ void');
  });

  // chests
  openCommon.addEventListener('click', ()=> openChest('common'));
  openRare.addEventListener('click', ()=> openChest('rare'));
  openLegend.addEventListener('click', ()=> openChest('legend'));

  // admin
  btnAdmin.addEventListener('click', ()=> showOverlay(adminOverlay));
  adminLogin.addEventListener('click', ()=>{
    const pass = (adminPass.value||'').trim();
    if(pass === ADMIN_PASSWORD){
      S.adminUnlocked = true;
      adminPass.value = '';
      setAdminUI();
      updateUI(); save();
      showToast('–ê–¥–º–∏–Ω–∫–∞: –æ—Ç–∫—Ä—ã—Ç–æ üîì');
      fireConfetti(innerWidth*0.5, innerHeight*0.45, 38, 0.85, false, true);
    }else{
      alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å üòà');
    }
  });
  adminLogout.addEventListener('click', ()=>{
    S.adminUnlocked = false;
    setAdminUI();
    updateUI(); save();
    showToast('–ê–¥–º–∏–Ω–∫–∞: –∑–∞–∫—Ä—ã—Ç–æ üîí');
  });

  giveCoins1.addEventListener('click', ()=>{ if(!guardAdmin()) return; addCoins(500); updateUI(); save(); showToast('üí∞ +500'); fireConfetti(innerWidth*0.5, innerHeight*0.45, 22, 0.7, true); });
  giveCoins2.addEventListener('click', ()=>{ if(!guardAdmin()) return; addCoins(2000); updateUI(); save(); showToast('üí∞ +2000'); fireConfetti(innerWidth*0.5, innerHeight*0.45, 30, 0.85, true); });
  giveSP1.addEventListener('click', ()=>{ if(!guardAdmin()) return; S.sp += 5; updateUI(); save(); showToast('‚≠ê SP +5'); fireConfetti(innerWidth*0.5, innerHeight*0.45, 22, 0.7, false, true); });
  giveSP2.addEventListener('click', ()=>{ if(!guardAdmin()) return; S.sp += 20; updateUI(); save(); showToast('‚≠ê SP +20'); fireConfetti(innerWidth*0.5, innerHeight*0.45, 30, 0.85, false, true); });

  giveKeys1.addEventListener('click', ()=>{ if(!guardAdmin()) return; addKeys(5); updateUI(); save(); showToast('üîë +5'); fireConfetti(innerWidth*0.5, innerHeight*0.45, 22, 0.75, true); });
  giveKeys2.addEventListener('click', ()=>{ if(!guardAdmin()) return; addKeys(20); updateUI(); save(); showToast('üîë +20'); fireConfetti(innerWidth*0.5, innerHeight*0.45, 34, 0.9, true); });

  // ----------------- controls buttons -----------------
  btnShop.addEventListener('click', ()=> showOverlay(shopOverlay));
  btnChest.addEventListener('click', ()=> showOverlay(chestOverlay));
  btnUpgrades.addEventListener('click', ()=> showOverlay(upOverlay));
  btnMenu.addEventListener('click', ()=> showOverlay(menuOverlay));

  // ----------------- initial -----------------
  updateUI();
  setAdminUI();
  paused = true;
})();
</script>
</body>
</html>
