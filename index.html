<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Block Master ‚Äî Drag + Combo</title>
  <style>
    :root{
      --bg1:#0b2a7b;
      --bg2:#0a1b4d;

      --panelA: rgba(255,255,255,.10);
      --panelB: rgba(255,255,255,.06);

      --gridFrame: rgba(42,161,255,.65);
      --gridGlow: rgba(42,161,255,.22);

      --cellA: rgba(255,255,255,.06);
      --cellB: rgba(255,255,255,.03);

      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --soft: 0 10px 20px rgba(0,0,0,.25);

      --text:#e9f3ff;
      --muted:rgba(233,243,255,.72);

      --good:#2fe084;
      --bad:#ff4d73;
      --warn:#ffcc4d;
      --violet:#a855ff;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%; margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    body{
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 50% -10%, #1f63ff33, transparent 60%),
        radial-gradient(900px 600px at 20% 20%, #53c1ff22, transparent 55%),
        radial-gradient(900px 600px at 85% 35%, #a855ff1f, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
      user-select:none;
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background-image:
        radial-gradient(circle at 12% 22%, rgba(255,255,255,.06) 0 2px, transparent 3px),
        radial-gradient(circle at 40% 14%, rgba(255,255,255,.05) 0 2px, transparent 3px),
        radial-gradient(circle at 74% 18%, rgba(255,255,255,.05) 0 2px, transparent 3px),
        radial-gradient(circle at 22% 60%, rgba(255,255,255,.04) 0 2px, transparent 3px),
        radial-gradient(circle at 62% 70%, rgba(255,255,255,.04) 0 2px, transparent 3px),
        radial-gradient(circle at 86% 62%, rgba(255,255,255,.04) 0 2px, transparent 3px);
      opacity:.75;
      pointer-events:none;
    }

    canvas#fx{position:fixed; inset:0; pointer-events:none; z-index:90;}

    /* MENU */
    .menu{
      position:fixed; inset:0;
      display:grid; place-items:center;
      padding:16px;
      z-index:100;
      background:
        radial-gradient(900px 700px at 30% 20%, rgba(255,204,77,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 35%, rgba(47,224,132,.14), transparent 60%),
        radial-gradient(900px 700px at 60% 85%, rgba(168,85,255,.14), transparent 60%),
        linear-gradient(180deg, #1b46ff, #07133a);
    }
    .menuCard{
      width:min(540px, 96vw);
      border-radius:28px;
      padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.07));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .menuCard:before{
      content:"";
      position:absolute; inset:-60%;
      background:
        radial-gradient(circle at 40% 30%, rgba(255,204,77,.26), transparent 55%),
        radial-gradient(circle at 75% 60%, rgba(47,224,132,.18), transparent 60%),
        radial-gradient(circle at 35% 75%, rgba(42,161,255,.18), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .menuTop{display:flex; align-items:center; justify-content:space-between; gap:12px; position:relative;}
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: conic-gradient(from 200deg, #ff4d73, #ffcc4d, #33e28a, #2aa1ff, #a855ff, #ff4d73);
      box-shadow: 0 12px 20px rgba(0,0,0,.25);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:7px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.40), rgba(255,255,255,.06));
      mix-blend-mode: overlay;
    }
    .title{font-weight:1000; letter-spacing:.6px; font-size:20px; line-height:1.05;}
    .subtitle{margin-top:2px; font-size:12px; color:var(--muted); font-weight:800;}
    .bestPill{
      padding:10px 12px;
      border-radius:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: var(--soft);
      min-width:140px;
      text-align:right;
    }
    .bestPill .k{font-size:11px; color:var(--muted); font-weight:900;}
    .bestPill .v{font-size:18px; font-weight:1000; letter-spacing:.4px;}
    .crown{
      display:inline-grid; place-items:center;
      width:20px; height:20px; border-radius:8px;
      background: linear-gradient(180deg, rgba(255,204,77,.95), rgba(255,166,0,.85));
      color:#3b2500;
      box-shadow: 0 10px 18px rgba(0,0,0,.20);
      font-size:13px;
      margin-right:6px;
    }
    .skins{margin-top:14px; position:relative;}
    .skins h3{margin:10px 0 10px; font-size:13px; letter-spacing:.3px; color:var(--muted);}
    .skinRow{display:flex; gap:10px; flex-wrap:wrap;}
    .skin{
      width:54px; height:54px; border-radius:16px;
      cursor:pointer;
      border:2px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 20px rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
      transition: transform .12s ease;
    }
    .skin:active{transform: translateY(1px) scale(.99);}
    .skin.sel{outline: 3px solid rgba(47,224,132,.9); border-color: rgba(47,224,132,.35);}
    .skin:after{
      content:"";
      position:absolute; inset:-30%;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.35), transparent 45%),
        radial-gradient(circle at 75% 75%, rgba(255,255,255,.18), transparent 50%);
      transform: rotate(18deg);
      opacity:.65;
      pointer-events:none;
    }
    .menuBtns{display:flex; gap:10px; margin-top:16px;}
    .btn{
      border:none; cursor:pointer;
      border-radius:18px;
      padding:12px 14px;
      font-weight:1000; letter-spacing:.4px;
      box-shadow: var(--shadow);
      transition: transform .12s ease;
      flex:1;
    }
    .btn:active{transform: translateY(1px) scale(.99);}
    .btn.play{background: linear-gradient(180deg, rgba(47,224,132,.98), rgba(30,207,118,.92)); color:#08321e;}
    .btn.ghost{
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      color:var(--text); box-shadow: var(--soft); flex:.8;
    }

    /* GAME */
    .app{
      height:100%;
      display:none;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:14px;
      padding:14px;
    }
    .topbar{
      width:min(520px, 96vw);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .pill{
      display:flex; flex-direction:column;
      gap:1px;
      padding:10px 12px;
      border-radius:16px;
      min-width:120px;
      background: linear-gradient(180deg, var(--panelA), var(--panelB));
      box-shadow: var(--soft);
      backdrop-filter: blur(10px);
    }
    .pill .k{font-size:11px; color:var(--muted); font-weight:900;}
    .pill .v{font-size:18px; font-weight:1000; letter-spacing:.4px; display:flex; align-items:center; gap:6px;}

    .boardWrap{
      position:relative;
      width: min(420px, 92vw);
      aspect-ratio: 1 / 1;
      border-radius:22px;
      padding:10px;
      background: linear-gradient(180deg, var(--gridGlow), rgba(42,161,255,.10));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .board{
      width:100%;
      height:100%;
      border-radius:18px;
      background:
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.18)),
        radial-gradient(140% 120% at 50% 0%, rgba(255,255,255,.05), transparent 60%);
      border: 3px solid var(--gridFrame);
      overflow:hidden;
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(10, 1fr);
      gap: 1px;
      padding: 8px;
    }
    .cell{
      border-radius: 6px;
      background: var(--cellB);
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
    }
    .cell:nth-child(odd){ background: var(--cellA); }
    .cell.filled{
      background: var(--fill, #ff4d73);
      box-shadow: inset 0 -10px 18px rgba(0,0,0,.18), inset 0 10px 18px rgba(255,255,255,.12);
      animation: popIn .14s ease-out;
    }
    .cell.filled:after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 40%),
                  radial-gradient(circle at 70% 70%, rgba(255,255,255,.28), transparent 45%);
      opacity:.22;
      transform: rotate(25deg);
      pointer-events:none;
    }
    @keyframes popIn{
      0%{ transform: scale(.88); filter: brightness(.92); }
      100%{ transform: scale(1); filter: brightness(1); }
    }

    .cell.previewOk{ outline: 2px solid rgba(47,224,132,.95); filter: brightness(1.06); }
    .cell.previewBad{ outline: 2px solid rgba(255,77,115,.95); filter: brightness(.92); }

    .clearFlash{
      position:absolute; inset:10px;
      border-radius:18px;
      pointer-events:none;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform: translateX(-120%);
      opacity:0;
    }
    .clearFlash.run{ animation: sweep .42s ease-out; }
    @keyframes sweep{
      0%{ transform: translateX(-120%); opacity:0; }
      20%{ opacity:1; }
      100%{ transform: translateX(120%); opacity:0; }
    }

    .toast{
      position:absolute;
      left:50%; top:12px;
      transform: translateX(-50%);
      padding:10px 14px;
      border-radius:16px;
      background: rgba(0,0,0,.34);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      font-weight:1000;
      letter-spacing:.3px;
      opacity:0;
      pointer-events:none;
      z-index:40;
      white-space:nowrap;
    }
    .toast.show{ animation: toastPop .95s ease forwards; }
    @keyframes toastPop{
      0%{opacity:0; transform: translateX(-50%) translateY(-8px) scale(.98);}
      15%{opacity:1; transform: translateX(-50%) translateY(0) scale(1);}
      80%{opacity:1;}
      100%{opacity:0; transform: translateX(-50%) translateY(-10px) scale(.98);}
    }

    .bottom{width:min(520px,96vw); display:flex; flex-direction:column; gap:10px; align-items:center;}

    .pieces{
      width:min(520px, 96vw);
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border-radius:22px;
      background: linear-gradient(180deg, var(--panelA), var(--panelB));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .pieceSlot{
      flex:1;
      min-width:0;
      display:grid;
      place-items:center;
      border-radius:18px;
      background: rgba(0,0,0,.12);
      padding:10px;
      position:relative;
      overflow:hidden;
    }
    .pieceSlot.empty{ opacity:.35; }

    .piece{
      width:100%;
      max-width:140px;
      aspect-ratio: 1 / 1;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(5, 1fr);
      gap:4px;
      touch-action:none;
      cursor:grab;
      filter: drop-shadow(0 12px 14px rgba(0,0,0,.25));
      transition: transform .12s ease;
    }
    .piece:active{ cursor:grabbing; }
    .pCell{ border-radius:8px; background: transparent; position:relative; }
    .pCell.on{
      background: var(--pcolor);
      box-shadow: inset 0 -10px 18px rgba(0,0,0,.16), inset 0 10px 18px rgba(255,255,255,.14);
    }
    .pCell.on:after{
      content:"";
      position:absolute; inset:-35%;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.6), transparent 40%),
        radial-gradient(circle at 70% 70%, rgba(255,255,255,.25), transparent 50%);
      opacity:.22;
      transform: rotate(25deg);
      pointer-events:none;
    }

    .controls{
      width:min(520px, 96vw);
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .btnSmall{
      flex:1;
      border:none; cursor:pointer;
      border-radius:18px;
      padding:12px 14px;
      font-weight:1000;
      letter-spacing:.4px;
      box-shadow: var(--shadow);
      transition: transform .12s ease;
      background: linear-gradient(180deg, rgba(47,224,132,.98), rgba(30,207,118,.92));
      color:#08321e;
    }
    .btnSmall.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      color:var(--text);
      box-shadow: var(--soft);
      flex:.9;
    }
    .btnSmall:active{ transform: translateY(1px) scale(.99); }

    .overlay{
      position:fixed; inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      z-index:110;
      padding:16px;
    }
    .overlay.show{ display:grid; }
    .modal{
      width:min(520px, 96vw);
      border-radius:26px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.07));
      box-shadow: var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .modal h2{margin:0 0 6px; font-size:18px; letter-spacing:.2px;}
    .modal p{margin:0 0 12px; color:var(--muted); font-weight:800;}
    .modal .row{display:flex; gap:10px;}

    .shake{ animation: shake .35s ease; }
    @keyframes shake{
      0%{transform:translateX(0)}
      20%{transform:translateX(-10px)}
      40%{transform:translateX(9px)}
      60%{transform:translateX(-7px)}
      80%{transform:translateX(5px)}
      100%{transform:translateX(0)}
    }

    /* drag ghost */
    .dragGhost{
      position:fixed; left:0; top:0;
      width: 170px; height:170px;
      transform: translate(-9999px,-9999px);
      z-index:95;
      pointer-events:none;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(5, 1fr);
      gap:5px;
      filter: drop-shadow(0 16px 18px rgba(0,0,0,.32));
      opacity:.98;
    }
    .dragGhost .pCell{ border-radius:10px; }
    .dragGhost.hidden{display:none;}

    @media (max-height: 760px){
      .boardWrap{ width:min(380px, 92vw); }
      .piece{ max-width:120px; }
    }
  </style>
</head>

<body>
<canvas id="fx"></canvas>

<!-- MENU -->
<div class="menu" id="menu">
  <div class="menuCard">
    <div class="menuTop">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">BLOCK MASTER</div>
          <div class="subtitle">drag&drop ‚Ä¢ –±–µ–∑ –Ω–∞–ª–æ–∂–µ–Ω–∏–π ‚Ä¢ –∫–æ–º–±–æ ‚Ä¢ —Ä–µ–∫–æ—Ä–¥</div>
        </div>
      </div>
      <div class="bestPill">
        <div class="k">BEST</div>
        <div class="v"><span class="crown">üëë</span><span id="menuBest">0</span></div>
      </div>
    </div>

    <div class="skins">
      <h3>–í—ã–±–µ—Ä–∏ –¥–∏–∑–∞–π–Ω –ø–æ–ª—è</h3>
      <div class="skinRow" id="skinRow"></div>
    </div>

    <div class="menuBtns">
      <button class="btn play" id="btnPlay">–ò–ì–†–ê–¢–¨</button>
      <button class="btn ghost" id="btnResetBest">–°–ë–†–û–°–ò–¢–¨ –†–ï–ö–û–†–î</button>
    </div>
  </div>
</div>

<!-- GAME -->
<div class="app" id="app">
  <div class="topbar">
    <div class="pill">
      <div class="k">SCORE</div>
      <div class="v" id="score">0</div>
    </div>
    <div class="pill">
      <div class="k">COMBO</div>
      <div class="v" id="combo">x1</div>
    </div>
    <div class="pill">
      <div class="k">BEST</div>
      <div class="v"><span class="crown">üëë</span><span id="best">0</span></div>
    </div>
  </div>

  <div class="boardWrap" id="boardWrap">
    <div class="toast" id="toast">–ö–†–ê–°–ê–í–ê!</div>
    <div class="clearFlash" id="clearFlash"></div>
    <div class="board" id="board"></div>
  </div>

  <div class="bottom">
    <div class="pieces" id="pieces"></div>
    <div class="controls">
      <button class="btnSmall secondary" id="btnMenu">–ú–µ–Ω—é</button>
      <button class="btnSmall secondary" id="btnNew">–ù–æ–≤–∞—è</button>
      <button class="btnSmall" id="btnShuffle">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å (x1)</button>
    </div>
  </div>
</div>

<!-- GAME OVER -->
<div class="overlay" id="overlay">
  <div class="modal" id="modal">
    <h2 id="overTitle">–ü—Ä–æ–∏–≥—Ä—ã—à</h2>
    <p id="overText">–•–æ–¥–æ–≤ –Ω–µ—Ç.</p>
    <div class="row">
      <button class="btnSmall secondary" id="btnClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btnSmall" id="btnRestart">–ó–∞–Ω–æ–≤–æ</button>
    </div>
  </div>
</div>

<div class="dragGhost hidden" id="ghost"></div>

<script>
(() => {
  // ---------- helpers ----------
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const rand  = (a,b)=>Math.random()*(b-a)+a;
  const pick  = (arr)=>arr[Math.floor(Math.random()*arr.length)];

  // ---------- constants ----------
  const N = 10;
  const BEST_KEY = "bm_best_drag_combo_v1";
  const SKIN_KEY = "bm_skin_drag_combo_v1";

  const COLORS = ["#ff4d73","#ffcc4d","#33e28a","#2aa1ff","#a855ff","#00e5ff","#ff7a00","#7cff00"];
  const SHAPES = [
    [[1]],
    [[1,1]],
    [[1,1,1]],
    [[1,1,1,1]],
    [[1,1,1,1,1]],
    [[1],[1]],
    [[1],[1],[1]],
    [[1],[1],[1],[1]],
    [[1],[1],[1],[1],[1]],
    [[1,1],[1,1]],
    [[1,1,1],[1,1,1],[1,1,1]],
    [[1,0],[1,0],[1,1]],
    [[0,1],[0,1],[1,1]],
    [[1,1],[1,0],[1,0]],
    [[1,1],[0,1],[0,1]],
    [[1,0,0],[1,0,0],[1,1,1]],
    [[0,0,1],[0,0,1],[1,1,1]],
    [[1,1,1],[1,0,0],[1,0,0]],
    [[1,1,1],[0,0,1],[0,0,1]],
    [[1,1,1],[0,1,0]],
    [[0,1,0],[1,1,1]],
    [[1,0],[1,1],[1,0]],
    [[0,1],[1,1],[0,1]],
    [[1,1,0],[0,1,1]],
    [[0,1,1],[1,1,0]],
    [[1,0],[1,1],[0,1]],
    [[0,1],[1,1],[1,0]],
    [[1,1,1],[1,0,1]],
    [[1,1,1],[1,1,0]],
    [[1,1,1],[0,1,1]],
    [[1,1,0],[1,1,1]],
    [[0,1,1],[1,1,1]],
  ];

  const SKINS = [
    {name:"Ocean", cellA:"rgba(255,255,255,.06)", cellB:"rgba(255,255,255,.03)", frame:"rgba(42,161,255,.65)", glow:"rgba(42,161,255,.22)"},
    {name:"Night", cellA:"rgba(255,255,255,.05)", cellB:"rgba(255,255,255,.025)", frame:"rgba(255,255,255,.22)", glow:"rgba(255,255,255,.10)"},
    {name:"Neon",  cellA:"rgba(47,224,132,.12)", cellB:"rgba(47,224,132,.06)", frame:"rgba(47,224,132,.60)", glow:"rgba(47,224,132,.18)"},
    {name:"Rose",  cellA:"rgba(255,77,115,.12)", cellB:"rgba(255,77,115,.06)", frame:"rgba(255,77,115,.62)", glow:"rgba(255,77,115,.18)"},
    {name:"Gold",  cellA:"rgba(255,204,77,.14)", cellB:"rgba(255,204,77,.07)", frame:"rgba(255,204,77,.62)", glow:"rgba(255,204,77,.18)"},
  ];

  // ---------- DOM ----------
  const menuEl = document.getElementById("menu");
  const appEl  = document.getElementById("app");
  const boardWrap = document.getElementById("boardWrap");
  const boardEl = document.getElementById("board");
  const piecesEl = document.getElementById("pieces");
  const ghostEl = document.getElementById("ghost");
  const toastEl = document.getElementById("toast");
  const clearFlashEl = document.getElementById("clearFlash");

  const scoreEl = document.getElementById("score");
  const comboEl = document.getElementById("combo");
  const bestEl  = document.getElementById("best");
  const menuBestEl = document.getElementById("menuBest");

  const skinRow = document.getElementById("skinRow");

  const btnPlay = document.getElementById("btnPlay");
  const btnResetBest = document.getElementById("btnResetBest");

  const btnMenu = document.getElementById("btnMenu");
  const btnNew  = document.getElementById("btnNew");
  const btnShuffle = document.getElementById("btnShuffle");

  const overlayEl = document.getElementById("overlay");
  const overTextEl = document.getElementById("overText");
  const btnClose = document.getElementById("btnClose");
  const btnRestart = document.getElementById("btnRestart");
  const modalEl = document.getElementById("modal");

  // ---------- FX canvas ----------
  const fx = document.getElementById("fx");
  const ctx = fx.getContext("2d");
  let W=0,H=0,DPR=1;
  function resizeFX(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    W = Math.floor(innerWidth*DPR);
    H = Math.floor(innerHeight*DPR);
    fx.width = W; fx.height = H;
    fx.style.width = innerWidth+"px";
    fx.style.height= innerHeight+"px";
  }
  addEventListener("resize", resizeFX);
  resizeFX();

  const particles=[];
  function spawnFirework(x,y,power=1){
    const cx=x*DPR, cy=y*DPR;
    const colors=["#ff4d73","#ffcc4d","#33e28a","#2aa1ff","#a855ff","#00e5ff","#ffffff"];
    const count=Math.floor(110*power);
    for(let i=0;i<count;i++){
      const a=rand(0,Math.PI*2);
      const sp=rand(2.0,8.5)*power*DPR;
      particles.push({
        x:cx,y:cy,
        vx:Math.cos(a)*sp,
        vy:Math.sin(a)*sp - rand(0,1.2*DPR),
        life:rand(45,90), t:0,
        size:rand(1.7,4.0)*DPR,
        col:pick(colors),
        grav:0.10*DPR, drag:0.985
      });
    }
  }
  function spawnConfetti(power=1){
    const colors=["#ff4d73","#ffcc4d","#33e28a","#2aa1ff","#a855ff","#ffffff"];
    const count=Math.floor(150*power);
    for(let i=0;i<count;i++){
      particles.push({
        x:rand(0,W), y:rand(-50*DPR,0),
        vx:rand(-1.6,1.6)*DPR,
        vy:rand(1.6,4.4)*DPR,
        life:rand(110,180), t:0,
        size:rand(2.4,5.6)*DPR,
        col:pick(colors),
        grav:0.03*DPR, drag:0.995,
        rect:true, rot:rand(0,Math.PI*2), vr:rand(-0.22,0.22)
      });
    }
  }
  function boomAtBoard(power=1.2){
    const r=boardWrap.getBoundingClientRect();
    const cx=r.left + r.width/2;
    const cy=r.top + r.height/2;
    spawnConfetti(power);
    spawnFirework(cx,cy,power);
    spawnFirework(cx-r.width*0.22, cy+r.height*0.05, power*0.85);
    spawnFirework(cx+r.width*0.22, cy-r.height*0.05, power*0.85);
  }
  function tickFX(){
    ctx.clearRect(0,0,W,H);
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.t++;
      p.vx*=p.drag;
      p.vy=(p.vy+p.grav)*p.drag;
      p.x+=p.vx; p.y+=p.vy;
      const a=1-(p.t/p.life);
      if(a<=0){ particles.splice(i,1); continue; }
      ctx.globalAlpha=clamp(a,0,1);
      ctx.fillStyle=p.col;
      if(p.rect){
        p.rot+=p.vr;
        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.rot);
        ctx.fillRect(-p.size,-p.size*0.35,p.size*2,p.size*0.7);
        ctx.restore();
      }else{
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
        ctx.fill();
      }
    }
    ctx.globalAlpha=1;
    requestAnimationFrame(tickFX);
  }
  tickFX();

  // ---------- game state ----------
  let board = Array.from({length:N}, ()=>Array(N).fill(null));
  let score = 0;
  let best = parseInt(localStorage.getItem(BEST_KEY) || "0", 10);
  if(!Number.isFinite(best)) best = 0;

  let combo = 1;          // —Ç–µ–∫—É—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (x1..)
  let comboStreak = 0;    // —Å–∫–æ–ª—å–∫–æ –ø–æ–¥—Ä—è–¥ —Ö–æ–¥–æ–≤ —Å –æ—á–∏—Å—Ç–∫–æ–π
  function comboMult(){
    // x1, x2, x3... (–Ω–æ –º—è–≥—á–µ –ø–æ –æ—á–∫–∞–º: 1 + 0.5*(x-1))
    return 1 + 0.5*(combo-1);
  }

  let shuffleLeft = 1;
  let pieces = []; // {shape, color, used}
  const cellEls = [];

  // drag state
  let drag = null; // {idx, shape, color, pointerId, ax, ay}
  let lastPreview = [];

  // ---------- UI ----------
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.remove("show");
    void toastEl.offsetWidth;
    toastEl.classList.add("show");
  }
  function setCombo(c){
    combo = Math.max(1, c);
    comboEl.textContent = `x${combo}`;
  }
  function addScore(d){
    score += d;
    if(score < 0) score = 0;
    scoreEl.textContent = score;
    if(score > best){
      best = score;
      localStorage.setItem(BEST_KEY, String(best));
      bestEl.textContent = best;
      menuBestEl.textContent = best;
    }
  }

  // ---------- skins ----------
  let currentSkin = localStorage.getItem(SKIN_KEY) || SKINS[0].name;
  function applySkin(name){
    const s = SKINS.find(x=>x.name===name) || SKINS[0];
    currentSkin = s.name;
    document.documentElement.style.setProperty("--cellA", s.cellA);
    document.documentElement.style.setProperty("--cellB", s.cellB);
    document.documentElement.style.setProperty("--gridFrame", s.frame);
    document.documentElement.style.setProperty("--gridGlow", s.glow);
    localStorage.setItem(SKIN_KEY, currentSkin);
    buildSkinButtons();
  }
  function buildSkinButtons(){
    skinRow.innerHTML = "";
    for(const s of SKINS){
      const b = document.createElement("div");
      b.className = "skin" + (s.name===currentSkin ? " sel" : "");
      b.style.background = `linear-gradient(180deg, ${s.cellA}, ${s.cellB})`;
      b.title = s.name;
      b.addEventListener("click", ()=>applySkin(s.name));
      skinRow.appendChild(b);
    }
  }

  // ---------- board render ----------
  function buildBoard(){
    boardEl.innerHTML = "";
    cellEls.length = 0;
    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const d = document.createElement("div");
        d.className = "cell";
        d.dataset.x = x;
        d.dataset.y = y;
        boardEl.appendChild(d);
        cellEls.push(d);
      }
    }
  }
  function renderBoard(){
    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const el = cellEls[y*N+x];
        const v = board[y][x];
        if(v){
          el.classList.add("filled");
          el.style.setProperty("--fill", v);
        }else{
          el.classList.remove("filled");
          el.style.removeProperty("--fill");
        }
      }
    }
  }

  // ---------- shapes ----------
  function shapeCells(shape){
    const out=[];
    for(let y=0;y<shape.length;y++){
      for(let x=0;x<shape[0].length;x++){
        if(shape[y][x]) out.push([x,y]);
      }
    }
    return out;
  }
  function shapeAnchor(shape){
    const cells=shapeCells(shape);
    let minX=999,minY=999;
    for(const [x,y] of cells){ if(x<minX)minX=x; if(y<minY)minY=y; }
    return {ax:minX, ay:minY};
  }
  function canPlace(shape, bx, by){
    for(const [sx,sy] of shapeCells(shape)){
      const x=bx+sx, y=by+sy;
      if(x<0||x>=N||y<0||y>=N) return false;
      if(board[y][x]) return false;
    }
    return true;
  }
  function place(shape, color, bx, by){
    for(const [sx,sy] of shapeCells(shape)){
      board[by+sy][bx+sx] = color;
    }
  }

  // ---------- clear rules ----------
  function isFullRow(y){ for(let x=0;x<N;x++) if(!board[y][x]) return false; return true; }
  function isFullCol(x){ for(let y=0;y<N;y++) if(!board[y][x]) return false; return true; }
  function isFullDiagMain(){ for(let i=0;i<N;i++) if(!board[i][i]) return false; return true; }
  function isFullDiagAnti(){ for(let i=0;i<N;i++) if(!board[i][N-1-i]) return false; return true; }

  function clearLinesAndDiags(){
    const rows=[], cols=[];
    for(let y=0;y<N;y++) if(isFullRow(y)) rows.push(y);
    for(let x=0;x<N;x++) if(isFullCol(x)) cols.push(x);
    const dm = isFullDiagMain();
    const da = isFullDiagAnti();

    const total = rows.length + cols.length + (dm?1:0) + (da?1:0);
    if(total===0) return {total:0, dm:false, da:false, rows:0, cols:0};

    clearFlashEl.classList.remove("run");
    void clearFlashEl.offsetWidth;
    clearFlashEl.classList.add("run");

    for(const y of rows) for(let x=0;x<N;x++) board[y][x]=null;
    for(const x of cols) for(let y=0;y<N;y++) board[y][x]=null;
    if(dm) for(let i=0;i<N;i++) board[i][i]=null;
    if(da) for(let i=0;i<N;i++) board[i][N-1-i]=null;

    return {total, dm, da, rows:rows.length, cols:cols.length};
  }

  // ---------- pieces UI ----------
  function shapeTo5x5(shape){
    const h=shape.length, w=shape[0].length;
    const g=Array.from({length:5},()=>Array(5).fill(0));
    const offY=Math.floor((5-h)/2);
    const offX=Math.floor((5-w)/2);
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        g[offY+y][offX+x]=shape[y][x]?1:0;
      }
    }
    return g;
  }

  function newPieces(){
    pieces = Array.from({length:3}, ()=>({shape:pick(SHAPES), color:pick(COLORS), used:false}));
    renderPieces();
  }

  function renderPieces(){
    piecesEl.innerHTML = "";
    pieces.forEach((p,i)=>{
      const slot = document.createElement("div");
      slot.className = "pieceSlot" + (p.used ? " empty" : "");
      if(!p.used){
        const piece = document.createElement("div");
        piece.className = "piece";
        piece.style.setProperty("--pcolor", p.color);
        piece.dataset.idx = i;

        const g=shapeTo5x5(p.shape);
        for(let y=0;y<5;y++){
          for(let x=0;x<5;x++){
            const c=document.createElement("div");
            c.className="pCell"+(g[y][x]?" on":"");
            piece.appendChild(c);
          }
        }
        slot.appendChild(piece);
        piece.addEventListener("pointerdown", (e)=>startDrag(e,i));
      }
      piecesEl.appendChild(slot);
    });
  }

  // ---------- preview ----------
  function clearPreview(){
    for(const el of lastPreview) el.classList.remove("previewOk","previewBad");
    lastPreview = [];
  }
  function setPreview(bx,by,ok,shape){
    clearPreview();
    for(const [sx,sy] of shapeCells(shape)){
      const x=bx+sx, y=by+sy;
      if(x<0||x>=N||y<0||y>=N) continue;
      const el=cellEls[y*N+x];
      el.classList.add(ok ? "previewOk":"previewBad");
      lastPreview.push(el);
    }
  }

  // ---------- board hit test ----------
  function boardCellFromPoint(clientX, clientY){
    const rect = boardEl.getBoundingClientRect();
    const inside = clientX>=rect.left && clientX<=rect.right && clientY>=rect.top && clientY<=rect.bottom;
    const nx=(clientX-rect.left)/rect.width;
    const ny=(clientY-rect.top)/rect.height;
    const bx=Math.floor(clamp(nx,0,0.999999)*N);
    const by=Math.floor(clamp(ny,0,0.999999)*N);
    return {bx,by,inside};
  }

  // ---------- ghost ----------
  function buildGhost(shape,color){
    ghostEl.innerHTML="";
    ghostEl.style.setProperty("--pcolor", color);
    const g=shapeTo5x5(shape);
    for(let y=0;y<5;y++){
      for(let x=0;x<5;x++){
        const c=document.createElement("div");
        c.className="pCell"+(g[y][x]?" on":"");
        ghostEl.appendChild(c);
      }
    }
  }
  function moveGhost(x,y){
    const size=170;
    ghostEl.style.transform = `translate(${x-size/2}px, ${y-size/2}px) scale(1.02)`;
  }

  // ---------- placement / lose ----------
  function anyMovePossible(){
    for(const p of pieces){
      if(p.used) continue;
      for(let by=0;by<N;by++){
        for(let bx=0;bx<N;bx++){
          if(canPlace(p.shape,bx,by)) return true;
        }
      }
    }
    return false;
  }

  function doPlacePiece(idx, bx, by){
    const p = pieces[idx];
    if(!p || p.used) return;

    place(p.shape, p.color, bx, by);
    p.used = true;

    const placedCount = shapeCells(p.shape).length;
    addScore(placedCount * 10);

    // CLEAR + COMBO
    const cleared = clearLinesAndDiags();
    if(cleared.total > 0){
      comboStreak++;
      setCombo(1 + comboStreak); // x2 –Ω–∞ –ø–µ—Ä–≤–æ–º –∫–ª–∏—Ä–µ –ø–æ–¥—Ä—è–¥
      const base = 140 * cleared.total;
      const bonus = Math.round(base * comboMult());
      addScore(bonus);

      // —Ç–æ—Å—Ç—ã
      if(cleared.dm || cleared.da){
        toast(`–î–ò–ê–ì–û–ù–ê–õ–¨ üí•  COMBO x${combo}`);
      } else if(cleared.total >= 2){
        toast(`–ö–û–ú–ë–û üî• x${combo}`);
      } else {
        toast(`–ß–ò–°–¢–û ‚úÖ  x${combo}`);
      }

      // —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫ —Å–∏–ª—å–Ω–µ–µ –æ—Ç –∫–æ–º–±–æ
      boomAtBoard(1.05 + Math.min(0.12*(combo-1), 0.9));
    } else {
      // —Å–±—Ä–æ—Å –∫–æ–º–±–æ –µ—Å–ª–∏ —Ö–æ–¥ –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏
      comboStreak = 0;
      setCombo(1);
      toast("–û–ö üòà");
    }

    renderBoard();
    renderPieces();

    if(pieces.every(x=>x.used)){
      newPieces();
    }

    if(!anyMovePossible()){
      gameOver();
    }
  }

  // ---------- drag ----------
  function startDrag(e, idx){
    const p = pieces[idx];
    if(!p || p.used) return;

    const {ax,ay} = shapeAnchor(p.shape);
    drag = {idx, shape:p.shape, color:p.color, pointerId:e.pointerId, ax, ay};

    buildGhost(p.shape, p.color);
    ghostEl.classList.remove("hidden");
    moveGhost(e.clientX, e.clientY);

    e.currentTarget.setPointerCapture(e.pointerId);

    const onMove = (ev)=>{
      if(!drag || ev.pointerId!==drag.pointerId) return;
      moveGhost(ev.clientX, ev.clientY);

      const hit = boardCellFromPoint(ev.clientX, ev.clientY);
      if(hit.inside){
        const placeX = hit.bx - drag.ax;
        const placeY = hit.by - drag.ay;
        const ok = canPlace(drag.shape, placeX, placeY);
        setPreview(placeX, placeY, ok, drag.shape);
      }else{
        clearPreview();
      }
    };

    const onUp = (ev)=>{
      if(!drag || ev.pointerId!==drag.pointerId) return;
      try{ e.currentTarget.releasePointerCapture(ev.pointerId); }catch(_){}
      ghostEl.classList.add("hidden");

      const hit = boardCellFromPoint(ev.clientX, ev.clientY);
      if(hit.inside){
        const placeX = hit.bx - drag.ax;
        const placeY = hit.by - drag.ay;
        if(canPlace(drag.shape, placeX, placeY)){
          clearPreview();
          doPlacePiece(drag.idx, placeX, placeY);
        } else {
          // –ø—Ä–æ—Å—Ç–æ –Ω–µ —Å—Ç–∞–≤–∏–º
          clearPreview();
          boardWrap.classList.remove("shake");
          void boardWrap.offsetWidth;
          boardWrap.classList.add("shake");
        }
      } else {
        clearPreview();
      }

      drag = null;
      window.removeEventListener("pointermove", onMove);
      window.removeEventListener("pointerup", onUp, true);
      window.removeEventListener("pointercancel", onUp, true);
    };

    window.addEventListener("pointermove", onMove);
    window.addEventListener("pointerup", onUp, true);
    window.addEventListener("pointercancel", onUp, true);
  }

  // ---------- game over ----------
  function showModal(text){
    overlayEl.classList.add("show");
    overTextEl.textContent = text;
  }
  function closeModal(){
    overlayEl.classList.remove("show");
  }

  function gameOver(){
    boardWrap.classList.remove("shake");
    void boardWrap.offsetWidth;
    boardWrap.classList.add("shake");

    // —Å–∞–ª—é—Ç –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ
    boomAtBoard(1.35);

    if(score > best){
      best = score;
      localStorage.setItem(BEST_KEY, String(best));
      bestEl.textContent = best;
      menuBestEl.textContent = best;
      toast("–ù–û–í–´–ô –†–ï–ö–û–†–î üëëüéÜ");
      setTimeout(()=>boomAtBoard(1.75), 180);
      showModal(`–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥: ${best} üëë  –°—á—ë—Ç: ${score}.`);
    }else{
      toast("–•–æ–¥–æ–≤ –Ω–µ—Ç üòà");
      showModal(`–°—á—ë—Ç: ${score}. –†–µ–∫–æ—Ä–¥: ${best}.`);
    }
  }

  // ---------- buttons ----------
  function restart(){
    closeModal();
    score = 0;
    scoreEl.textContent = "0";
    shuffleLeft = 1;
    btnShuffle.textContent = "–ü–µ—Ä–µ–º–µ—à–∞—Ç—å (x1)";
    board = Array.from({length:N}, ()=>Array(N).fill(null));
    renderBoard();
    newPieces();

    comboStreak = 0;
    setCombo(1);

    toast("–ü–û–ï–•–ê–õ–ò üöÄ");
    if(!anyMovePossible()) gameOver();
  }

  btnShuffle.addEventListener("click", ()=>{
    if(shuffleLeft<=0){
      toast("–®–∞—Ñ—Ñ–ª –∫–æ–Ω—á–∏–ª—Å—è üòà");
      return;
    }
    for(const p of pieces){
      if(!p.used){
        p.shape = pick(SHAPES);
        p.color = pick(COLORS);
      }
    }
    shuffleLeft--;
    btnShuffle.textContent = `–ü–µ—Ä–µ–º–µ—à–∞—Ç—å (x${shuffleLeft})`;
    renderPieces();
    toast("–ü–ï–†–ï–ú–ï–®–ê–õ üí´");
    if(!anyMovePossible()) gameOver();
  });

  btnNew.addEventListener("click", restart);
  btnMenu.addEventListener("click", ()=>{
    closeModal();
    appEl.style.display="none";
    menuEl.style.display="grid";
  });

  btnClose.addEventListener("click", closeModal);
  btnRestart.addEventListener("click", restart);
  overlayEl.addEventListener("click", (e)=>{ if(e.target===overlayEl) closeModal(); });

  // menu
  btnPlay.addEventListener("click", ()=>{
    menuEl.style.display="none";
    appEl.style.display="flex";
    restart();
  });

  btnResetBest.addEventListener("click", ()=>{
    best = 0;
    localStorage.setItem(BEST_KEY, "0");
    bestEl.textContent = "0";
    menuBestEl.textContent = "0";
    toast("–†–µ–∫–æ—Ä–¥ —Å–±—Ä–æ—à–µ–Ω");
  });

  // prevent iOS scroll while dragging
  document.addEventListener("touchmove", (e)=>{ if(drag) e.preventDefault(); }, {passive:false});

  // ---------- init ----------
  function init(){
    buildBoard();
    buildSkinButtons();
    applySkin(currentSkin);

    bestEl.textContent = best;
    menuBestEl.textContent = best;

    scoreEl.textContent = "0";
    setCombo(1);

    renderBoard();
    newPieces();
    btnShuffle.textContent = "–ü–µ—Ä–µ–º–µ—à–∞—Ç—å (x1)";
  }
  init();
})();
</script>
</body>
</html>
