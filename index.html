<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Block Puzzle ‚Äî Classic</title>
  <style>
    :root{
      --bg1:#0b2a7b;
      --bg2:#0a1b4d;
      --gridBorder:#2aa1ff;
      --cellA:rgba(255,255,255,.06);
      --cellB:rgba(255,255,255,.03);
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --soft: 0 10px 20px rgba(0,0,0,.25);
      --text:#e9f3ff;
      --muted:rgba(233,243,255,.72);
      --btn:#2fe084;
      --btn2:#1ecf76;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%; margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    body{
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 50% -10%, #1f63ff33, transparent 60%),
        radial-gradient(900px 600px at 20% 20%, #53c1ff22, transparent 55%),
        radial-gradient(900px 600px at 85% 35%, #a855ff1f, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
      user-select:none;
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background-image:
        radial-gradient(circle at 12% 22%, rgba(255,255,255,.06) 0 2px, transparent 3px),
        radial-gradient(circle at 40% 14%, rgba(255,255,255,.05) 0 2px, transparent 3px),
        radial-gradient(circle at 74% 18%, rgba(255,255,255,.05) 0 2px, transparent 3px),
        radial-gradient(circle at 22% 60%, rgba(255,255,255,.04) 0 2px, transparent 3px),
        radial-gradient(circle at 62% 70%, rgba(255,255,255,.04) 0 2px, transparent 3px),
        radial-gradient(circle at 86% 62%, rgba(255,255,255,.04) 0 2px, transparent 3px);
      opacity:.75;
      pointer-events:none;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:14px;
      padding:14px;
    }

    .topbar{
      width:min(520px, 96vw);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: var(--soft);
      backdrop-filter: blur(10px);
    }
    .logo{
      width:34px; height:34px; border-radius:10px;
      background: conic-gradient(from 200deg, #ff4d73, #ffcc4d, #33e28a, #2aa1ff, #a855ff, #ff4d73);
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:6px;
      border-radius:8px;
      background: linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.05));
      mix-blend-mode: overlay;
    }
    .brand .t1{font-weight:900; letter-spacing:.4px; font-size:14px; line-height:1.05;}
    .brand .t2{font-size:11px; color:var(--muted); margin-top:1px;}

    .hud{
      display:flex; gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex:1;
    }
    .pill{
      display:flex; flex-direction:column;
      gap:1px;
      padding:10px 12px;
      border-radius:16px;
      min-width:120px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: var(--soft);
      backdrop-filter: blur(10px);
    }
    .pill .k{font-size:11px; color:var(--muted); font-weight:700;}
    .pill .v{font-size:18px; font-weight:900; letter-spacing:.4px; display:flex; align-items:center; gap:6px;}
    .crown{
      display:inline-grid; place-items:center;
      width:20px; height:20px; border-radius:8px;
      background: linear-gradient(180deg, rgba(255,204,77,.95), rgba(255,166,0,.85));
      color:#3b2500;
      box-shadow: 0 10px 18px rgba(0,0,0,.20);
      font-size:13px;
    }

    .stage{
      width:min(520px, 96vw);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
    }

    .boardWrap{
      position:relative;
      width: min(420px, 92vw);
      aspect-ratio: 1 / 1;
      border-radius:22px;
      padding:10px;
      background: linear-gradient(180deg, rgba(42,161,255,.28), rgba(42,161,255,.10));
      box-shadow: var(--shadow);
    }
    .board{
      width:100%;
      height:100%;
      border-radius:18px;
      background:
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.18)),
        radial-gradient(140% 120% at 50% 0%, rgba(255,255,255,.05), transparent 60%);
      border: 3px solid rgba(42,161,255,.65);
      overflow:hidden;
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(10, 1fr);
      gap: 1px;
      padding: 8px;
    }
    .cell{
      border-radius: 6px;
      background: var(--cellB);
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
    }
    .cell:nth-child(odd){ background: var(--cellA); }

    .cell.filled{
      background: var(--fill, #ff4d73);
      box-shadow: inset 0 -10px 18px rgba(0,0,0,.18), inset 0 10px 18px rgba(255,255,255,.12);
      animation: popIn .16s ease-out;
    }
    .cell.filled:after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 40%),
                  radial-gradient(circle at 70% 70%, rgba(255,255,255,.28), transparent 45%);
      opacity:.22;
      transform: rotate(25deg);
      pointer-events:none;
    }
    @keyframes popIn{
      0%{ transform: scale(.85); filter: brightness(.9); }
      100%{ transform: scale(1); filter: brightness(1); }
    }

    .cell.previewOk{
      outline: 2px solid rgba(47,224,132,.95);
      filter: brightness(1.06);
    }
    .cell.previewBad{
      outline: 2px solid rgba(255,77,115,.95);
      filter: brightness(.92);
    }

    .clearFlash{
      position:absolute; inset:8px;
      border-radius:18px;
      pointer-events:none;
      background:
        linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform: translateX(-120%);
      opacity:0;
    }
    .clearFlash.run{
      animation: sweep .42s ease-out;
    }
    @keyframes sweep{
      0%{ transform: translateX(-120%); opacity:0; }
      20%{ opacity:1; }
      100%{ transform: translateX(120%); opacity:0; }
    }

    .toast{
      position:absolute;
      left:50%; top:12px;
      transform: translateX(-50%);
      padding:10px 14px;
      border-radius:16px;
      background: rgba(0,0,0,.34);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      font-weight:900;
      letter-spacing:.3px;
      opacity:0;
      pointer-events:none;
      z-index:40;
    }
    .toast.show{ animation: toastPop .9s ease forwards; }
    @keyframes toastPop{
      0%{opacity:0; transform: translateX(-50%) translateY(-8px) scale(.98);}
      15%{opacity:1; transform: translateX(-50%) translateY(0) scale(1);}
      75%{opacity:1;}
      100%{opacity:0; transform: translateX(-50%) translateY(-10px) scale(.98);}
    }

    .bottom{
      width:min(520px, 96vw);
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
    }

    .pieces{
      width:min(520px, 96vw);
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .pieceSlot{
      flex:1;
      min-width:0;
      display:grid;
      place-items:center;
      border-radius:18px;
      background: rgba(0,0,0,.12);
      padding:10px;
      position:relative;
      overflow:hidden;
    }
    .pieceSlot.empty{ opacity:.35; }

    .piece{
      width:100%;
      max-width:140px;
      aspect-ratio: 1 / 1;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(5, 1fr);
      gap:4px;
      touch-action:none;
      cursor:grab;
      filter: drop-shadow(0 12px 14px rgba(0,0,0,.25));
      transition: transform .12s ease;
    }
    .piece:active{ cursor:grabbing; }
    .pCell{ border-radius:8px; background: transparent; position:relative; }
    .pCell.on{
      background: var(--pcolor);
      box-shadow: inset 0 -10px 18px rgba(0,0,0,.16), inset 0 10px 18px rgba(255,255,255,.14);
    }
    .pCell.on:after{
      content:"";
      position:absolute; inset:-35%;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.6), transparent 40%),
        radial-gradient(circle at 70% 70%, rgba(255,255,255,.25), transparent 50%);
      opacity:.22;
      transform: rotate(25deg);
      pointer-events:none;
    }

    .controls{
      width:min(520px, 96vw);
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .btn{
      flex:1;
      border:none;
      cursor:pointer;
      border-radius:18px;
      padding:12px 14px;
      font-weight:900;
      letter-spacing:.4px;
      background: linear-gradient(180deg, rgba(47,224,132,.98), rgba(30,207,118,.92));
      color:#08321e;
      box-shadow: var(--shadow);
      transition: transform .12s ease;
    }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      color:var(--text);
      box-shadow: var(--soft);
      flex:.8;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }

    .overlay{
      position:fixed; inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(8px);
      z-index:50;
      padding:16px;
    }
    .overlay.show{ display:grid; }
    .modal{
      width:min(520px, 96vw);
      border-radius:26px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.07));
      box-shadow: var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .modal h2{margin:0 0 6px; font-size:18px;}
    .modal p{margin:0 0 12px; color:var(--muted); font-weight:650;}
    .modal .row{display:flex; gap:10px;}
    .modal .row .btn{flex:1;}

    canvas#fx{ position:fixed; inset:0; pointer-events:none; z-index:60; }

    .dragGhost{
      position:fixed;
      left:0; top:0;
      width: 170px;
      height: 170px;
      transform: translate(-9999px,-9999px);
      z-index:70;
      pointer-events:none;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(5, 1fr);
      gap:5px;
      filter: drop-shadow(0 16px 18px rgba(0,0,0,.32));
      opacity:.98;
    }
    .dragGhost .pCell{ border-radius:10px; }
    .dragGhost.hidden{display:none;}

    .tinyHint{
      font-size:11px; color:var(--muted); font-weight:750;
      text-align:center;
      margin-top:-6px;
    }
  </style>
</head>
<body>
  <canvas id="fx"></canvas>

  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="t1">BLOCK PUZZLE</div>
          <div class="t2">Classic (–Ω–∞ —Ä–µ–∫–æ—Ä–¥)</div>
        </div>
      </div>

      <div class="hud">
        <div class="pill">
          <div class="k">SCORE</div>
          <div class="v" id="score">0</div>
        </div>
        <div class="pill">
          <div class="k">BEST</div>
          <div class="v"><span class="crown">üëë</span><span id="best">0</span></div>
        </div>
      </div>
    </div>

    <div class="stage">
      <div class="boardWrap" id="boardWrap">
        <div class="toast" id="toast">–ö–†–ê–°–ê–í–ê!</div>
        <div class="clearFlash" id="clearFlash"></div>
        <div class="board" id="board"></div>
      </div>

      <div class="tinyHint">
        –õ–æ–º–∞–µ—Ç—Å—è —Ä—è–¥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å / –≤–µ—Ä—Ç–∏–∫–∞–ª—å / 2 –¥–∏–∞–≥–æ–Ω–∞–ª–∏.
      </div>
    </div>

    <div class="bottom">
      <div class="pieces" id="pieces"></div>
      <div class="controls">
        <button class="btn secondary" id="btnNew">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        <button class="btn" id="btnShuffle">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Ñ–∏–≥—É—Ä—ã (x1)</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2 id="modalTitle">–ü—Ä–æ–∏–≥—Ä—ã—à</h2>
      <p id="modalText">–ù–µ–ª—å–∑—è –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∏ –æ–¥–Ω—É —Ñ–∏–≥—É—Ä—É. –ó–∞–Ω–æ–≤–æ?</p>
      <div class="row">
        <button class="btn secondary" id="btnClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="btn" id="btnRestart">–ó–∞–Ω–æ–≤–æ</button>
      </div>
    </div>
  </div>

  <div class="dragGhost hidden" id="ghost"></div>

<script>
(() => {
  // ---------- utils ----------
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const rand = (a,b)=>Math.random()*(b-a)+a;
  const randi = (a,b)=>Math.floor(rand(a,b+1));
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];

  // ---------- DOM ----------
  const boardEl = document.getElementById("board");
  const piecesEl = document.getElementById("pieces");
  const scoreEl = document.getElementById("score");
  const bestEl  = document.getElementById("best");
  const toastEl = document.getElementById("toast");
  const overlayEl = document.getElementById("overlay");
  const modalTextEl = document.getElementById("modalText");
  const clearFlashEl = document.getElementById("clearFlash");
  const btnNew = document.getElementById("btnNew");
  const btnShuffle = document.getElementById("btnShuffle");
  const btnClose = document.getElementById("btnClose");
  const btnRestart = document.getElementById("btnRestart");
  const ghostEl = document.getElementById("ghost");

  // ---------- FX canvas ----------
  const fx = document.getElementById("fx");
  const ctx = fx.getContext("2d");
  let W=0,H=0;
  function resizeFX(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    W = Math.floor(innerWidth*dpr);
    H = Math.floor(innerHeight*dpr);
    fx.width=W; fx.height=H;
    fx.style.width = innerWidth+"px";
    fx.style.height= innerHeight+"px";
    ctx.setTransform(1,0,0,1,0,0);
  }
  addEventListener("resize", resizeFX);
  resizeFX();

  const particles=[];
  function spawnFirework(x,y,power=1){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    const cx=x*dpr, cy=y*dpr;
    const count=Math.floor(90*power);
    const colors=["#ff4d73","#ffcc4d","#33e28a","#2aa1ff","#a855ff","#00e5ff","#ffffff"];
    for(let i=0;i<count;i++){
      const a=rand(0,Math.PI*2);
      const sp=rand(2.0,7.6)*power*dpr;
      particles.push({
        x:cx,y:cy,
        vx:Math.cos(a)*sp,
        vy:Math.sin(a)*sp - rand(0,1.2*dpr),
        life:rand(40,70), t:0,
        size:rand(1.6,3.6)*dpr,
        col:pick(colors),
        grav:0.10*dpr,
        drag:0.985
      });
    }
  }
  function spawnConfetti(power=1){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    const count=Math.floor(120*power);
    const colors=["#ff4d73","#ffcc4d","#33e28a","#2aa1ff","#a855ff","#ffffff"];
    for(let i=0;i<count;i++){
      particles.push({
        x:rand(0,W), y:rand(-40*dpr,0),
        vx:rand(-1.5,1.5)*dpr,
        vy:rand(1.5,4.0)*dpr,
        life:rand(90,150), t:0,
        size:rand(2.2,5.0)*dpr,
        col:pick(colors),
        grav:0.03*dpr,
        drag:0.995,
        rect:true,
        rot:rand(0,Math.PI*2),
        vr:rand(-0.2,0.2)
      });
    }
  }
  function tickFX(){
    ctx.clearRect(0,0,W,H);
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.t++;
      p.vx*=p.drag;
      p.vy=(p.vy+p.grav)*p.drag;
      p.x+=p.vx; p.y+=p.vy;
      const a=1-(p.t/p.life);
      if(a<=0){ particles.splice(i,1); continue; }
      ctx.globalAlpha=clamp(a,0,1);
      ctx.fillStyle=p.col;
      if(p.rect){
        p.rot+=p.vr;
        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.rot);
        ctx.fillRect(-p.size, -p.size*0.35, p.size*2, p.size*0.7);
        ctx.restore();
      }else{
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
        ctx.fill();
      }
    }
    ctx.globalAlpha=1;
    requestAnimationFrame(tickFX);
  }
  tickFX();

  // ---------- Game state ----------
  const N=10;
  const board = Array.from({length:N},()=>Array(N).fill(null));
  const cellEls=[];
  let score=0;
  const BEST_KEY="bb_best_classic_v2";
  let best=parseInt(localStorage.getItem(BEST_KEY)||"0",10);
  if(!Number.isFinite(best)) best=0;
  bestEl.textContent=best;

  let shuffleLeft=1;
  let pieces=[];

  const COLORS=["#ff4d73","#ffcc4d","#33e28a","#2aa1ff","#a855ff","#00e5ff","#ff7a00","#7cff00"];

  const SHAPES = [
    [[1]],
    [[1,1]],
    [[1,1,1]],
    [[1,1,1,1]],
    [[1,1,1,1,1]],
    [[1],[1]],
    [[1],[1],[1]],
    [[1],[1],[1],[1]],
    [[1],[1],[1],[1],[1]],
    [[1,1],[1,1]],
    [[1,1,1],[1,1,1],[1,1,1]],
    [[1,0],[1,0],[1,1]],
    [[0,1],[0,1],[1,1]],
    [[1,1],[1,0],[1,0]],
    [[1,1],[0,1],[0,1]],
    [[1,0,0],[1,0,0],[1,1,1]],
    [[0,0,1],[0,0,1],[1,1,1]],
    [[1,1,1],[1,0,0],[1,0,0]],
    [[1,1,1],[0,0,1],[0,0,1]],
    [[1,1,1],[0,1,0]],
    [[0,1,0],[1,1,1]],
    [[1,0],[1,1],[1,0]],
    [[0,1],[1,1],[0,1]],
    [[1,1,0],[0,1,1]],
    [[0,1,1],[1,1,0]],
    [[1,0],[1,1],[0,1]],
    [[0,1],[1,1],[1,0]],
    [[1,1,1],[1,0,1]],
    [[1,1,1],[1,1,0]],
    [[1,1,1],[0,1,1]],
    [[1,1,0],[1,1,1]],
    [[0,1,1],[1,1,1]],
  ];

  // ---------- Render board ----------
  function buildBoard(){
    boardEl.innerHTML="";
    cellEls.length=0;
    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const d=document.createElement("div");
        d.className="cell";
        d.dataset.x=x;
        d.dataset.y=y;
        boardEl.appendChild(d);
        cellEls.push(d);
      }
    }
  }
  buildBoard();

  function renderBoard(){
    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const el=cellEls[y*N+x];
        const v=board[y][x];
        if(v){
          el.classList.add("filled");
          el.style.setProperty("--fill", v);
        }else{
          el.classList.remove("filled");
          el.style.removeProperty("--fill");
        }
      }
    }
  }

  // ---------- Toast ----------
  function toast(msg){
    toastEl.textContent=msg;
    toastEl.classList.remove("show");
    void toastEl.offsetWidth;
    toastEl.classList.add("show");
  }

  function addScore(delta){
    score += delta;
    if(score<0) score=0;
    scoreEl.textContent=score;
    if(score>best){
      best=score;
      localStorage.setItem(BEST_KEY, String(best));
      bestEl.textContent=best;
    }
  }

  // ---------- Shapes helpers ----------
  function shapeCells(shape){
    const out=[];
    for(let y=0;y<shape.length;y++){
      for(let x=0;x<shape[0].length;x++){
        if(shape[y][x]) out.push([x,y]);
      }
    }
    return out;
  }

  function shapeAnchor(shape){
    // –≤–µ—Ä—Ö-–ª–µ–≤—ã–π –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –±–ª–æ–∫ (—á—Ç–æ–±—ã –¥—Ä–æ–ø –±—ã–ª "—Ç—É–¥–∞ –∫—É–¥–∞ –ø–æ—Å—Ç–∞–≤–∏–ª")
    const cells=shapeCells(shape);
    let minX=999,minY=999;
    for(const [x,y] of cells){ if(x<minX)minX=x; if(y<minY)minY=y; }
    return {ax:minX, ay:minY};
  }

  function canPlace(shape, bx, by){
    const cells=shapeCells(shape);
    for(const [sx,sy] of cells){
      const x=bx+sx, y=by+sy;
      if(x<0||x>=N||y<0||y>=N) return false;
      if(board[y][x]) return false;
    }
    return true;
  }

  function place(shape, color, bx, by){
    for(const [sx,sy] of shapeCells(shape)){
      board[by+sy][bx+sx]=color;
    }
  }

  // ---------- Clear rules: row/col + 2 main diagonals ----------
  function isFullRow(y){
    for(let x=0;x<N;x++) if(!board[y][x]) return false;
    return true;
  }
  function isFullCol(x){
    for(let y=0;y<N;y++) if(!board[y][x]) return false;
    return true;
  }
  function isFullDiagMain(){
    // top-left -> bottom-right
    for(let i=0;i<N;i++) if(!board[i][i]) return false;
    return true;
  }
  function isFullDiagAnti(){
    // top-right -> bottom-left
    for(let i=0;i<N;i++) if(!board[i][N-1-i]) return false;
    return true;
  }

  function clearLinesAndDiagonals(){
    const rows=[], cols=[];
    for(let y=0;y<N;y++) if(isFullRow(y)) rows.push(y);
    for(let x=0;x<N;x++) if(isFullCol(x)) cols.push(x);

    const diagMain = isFullDiagMain();
    const diagAnti = isFullDiagAnti();

    if(rows.length===0 && cols.length===0 && !diagMain && !diagAnti) return {cleared:0, parts:{rows:0,cols:0,diags:0}};

    clearFlashEl.classList.remove("run");
    void clearFlashEl.offsetWidth;
    clearFlashEl.classList.add("run");

    // clear rows
    for(const y of rows){
      for(let x=0;x<N;x++) board[y][x]=null;
    }
    // clear cols
    for(const x of cols){
      for(let y=0;y<N;y++) board[y][x]=null;
    }
    // clear diagonals
    let diags=0;
    if(diagMain){
      diags++;
      for(let i=0;i<N;i++) board[i][i]=null;
    }
    if(diagAnti){
      diags++;
      for(let i=0;i<N;i++) board[i][N-1-i]=null;
    }

    const total = rows.length + cols.length + diags;
    return {cleared:total, parts:{rows:rows.length, cols:cols.length, diags}};
  }

  function isBoardEmpty(){
    for(let y=0;y<N;y++) for(let x=0;x<N;x++) if(board[y][x]) return false;
    return true;
  }

  // ---------- Pieces UI ----------
  function shapeTo5x5(shape){
    const h=shape.length, w=shape[0].length;
    const g=Array.from({length:5},()=>Array(5).fill(0));
    const offY=Math.floor((5-h)/2);
    const offX=Math.floor((5-w)/2);
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        g[offY+y][offX+x]=shape[y][x]?1:0;
      }
    }
    return g;
  }

  function newPieces(){
    pieces = Array.from({length:3}, ()=>({
      shape: pick(SHAPES),
      color: pick(COLORS),
      used:false
    }));
    renderPieces();
  }

  function renderPieces(){
    piecesEl.innerHTML="";
    pieces.forEach((p, i)=>{
      const slot=document.createElement("div");
      slot.className="pieceSlot"+(p.used?" empty":"");
      slot.dataset.idx=i;

      if(!p.used){
        const piece=document.createElement("div");
        piece.className="piece";
        piece.style.setProperty("--pcolor", p.color);
        piece.dataset.idx=i;

        const g=shapeTo5x5(p.shape);
        for(let y=0;y<5;y++){
          for(let x=0;x<5;x++){
            const c=document.createElement("div");
            c.className="pCell"+(g[y][x]?" on":"");
            piece.appendChild(c);
          }
        }
        slot.appendChild(piece);
        piece.addEventListener("pointerdown", (e)=>startDrag(e,i));
      }
      piecesEl.appendChild(slot);
    });
  }

  // ---------- Drag & drop with exact snapping ----------
  let drag=null; // {idx, shape, color, pointerId, ax, ay}
  let lastPreview=[];

  function clearPreview(){
    for(const el of lastPreview) el.classList.remove("previewOk","previewBad");
    lastPreview=[];
  }

  function setPreview(bx, by, ok, shape){
    clearPreview();
    for(const [sx,sy] of shapeCells(shape)){
      const x=bx+sx, y=by+sy;
      if(x<0||x>=N||y<0||y>=N) continue;
      const el=cellEls[y*N+x];
      el.classList.add(ok?"previewOk":"previewBad");
      lastPreview.push(el);
    }
  }

  function boardCellFromPoint(clientX, clientY){
    const rect=boardEl.getBoundingClientRect();
    const inside = clientX>=rect.left && clientX<=rect.right && clientY>=rect.top && clientY<=rect.bottom;
    const nx=(clientX-rect.left)/rect.width;
    const ny=(clientY-rect.top)/rect.height;
    const bx=Math.floor(clamp(nx,0,0.999999)*N);
    const by=Math.floor(clamp(ny,0,0.999999)*N);
    return {bx,by,inside, rect};
  }

  function buildGhost(shape, color){
    ghostEl.innerHTML="";
    ghostEl.style.setProperty("--pcolor", color);
    const g=shapeTo5x5(shape);
    for(let y=0;y<5;y++){
      for(let x=0;x<5;x++){
        const c=document.createElement("div");
        c.className="pCell"+(g[y][x]?" on":"");
        ghostEl.appendChild(c);
      }
    }
  }

  function moveGhost(x,y){
    const size=170;
    ghostEl.style.transform = `translate(${x-size/2}px, ${y-size/2}px) scale(1.02)`;
  }

  function startDrag(e, idx){
    const p=pieces[idx];
    if(!p || p.used) return;

    const {ax, ay} = shapeAnchor(p.shape);
    drag={idx, shape:p.shape, color:p.color, pointerId:e.pointerId, ax, ay};

    buildGhost(p.shape, p.color);
    ghostEl.classList.remove("hidden");
    moveGhost(e.clientX, e.clientY);

    e.currentTarget.setPointerCapture(e.pointerId);

    const onMove=(ev)=>{
      if(!drag || ev.pointerId!==drag.pointerId) return;
      moveGhost(ev.clientX, ev.clientY);
      const hit=boardCellFromPoint(ev.clientX, ev.clientY);
      if(hit.inside){
        const placeX = hit.bx - drag.ax;
        const placeY = hit.by - drag.ay;
        const ok = canPlace(drag.shape, placeX, placeY);
        setPreview(placeX, placeY, ok, drag.shape);
      }else{
        clearPreview();
      }
    };

    const onUp=(ev)=>{
      if(!drag || ev.pointerId!==drag.pointerId) return;
      try{ e.currentTarget.releasePointerCapture(ev.pointerId); }catch(_){}
      ghostEl.classList.add("hidden");
      clearPreview();

      const hit=boardCellFromPoint(ev.clientX, ev.clientY);
      if(hit.inside){
        const placeX = hit.bx - drag.ax;
        const placeY = hit.by - drag.ay;
        if(canPlace(drag.shape, placeX, placeY)){
          doPlace(drag.idx, placeX, placeY);
        }else{
          toast("–°–Æ–î–ê –ù–ï–õ–¨–ó–Ø üëé");
        }
      }else{
        toast("–ú–∏–º–æ üòÖ");
      }

      drag=null;
      window.removeEventListener("pointermove", onMove);
      window.removeEventListener("pointerup", onUp, true);
      window.removeEventListener("pointercancel", onUp, true);
    };

    window.addEventListener("pointermove", onMove);
    window.addEventListener("pointerup", onUp, true);
    window.addEventListener("pointercancel", onUp, true);
  }

  // ---------- Game over logic ----------
  function anyMovePossible(){
    for(const p of pieces){
      if(p.used) continue;
      for(let by=0;by<N;by++){
        for(let bx=0;bx<N;bx++){
          if(canPlace(p.shape,bx,by)) return true;
        }
      }
    }
    return false;
  }

  function showGameOver(){
    overlayEl.classList.add("show");
    modalTextEl.textContent = `–ù–µ–ª—å–∑—è –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∏ –æ–¥–Ω—É —Ñ–∏–≥—É—Ä—É. –¢–≤–æ–π —Å—á—ë—Ç: ${score}. –†–µ–∫–æ—Ä–¥: ${best}.`;
  }

  function closeModal(){ overlayEl.classList.remove("show"); }

  function restart(){
    closeModal();
    score=0;
    scoreEl.textContent="0";
    shuffleLeft=1;
    btnShuffle.textContent="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Ñ–∏–≥—É—Ä—ã (x1)";
    for(let y=0;y<N;y++) for(let x=0;x<N;x++) board[y][x]=null;
    newPieces();
    renderBoard();
    toast("–ü–û–ï–•–ê–õ–ò üöÄ");
  }

  // ---------- Placement ----------
  function doPlace(idx, bx, by){
    const p=pieces[idx];
    if(!p || p.used) return;

    place(p.shape, p.color, bx, by);
    p.used=true;

    // score for placed blocks
    const placed = shapeCells(p.shape).length;
    addScore(placed * 10);

    // clear
    const res = clearLinesAndDiagonals();
    if(res.cleared>0){
      // bonus
      const bonus = 140*res.cleared;
      addScore(bonus);

      if(res.parts.diags>0){
        toast("–î–ò–ê–ì–û–ù–ê–õ–¨ –†–ê–ó–™–ï–ë–ê–õ üí•");
      }else if(res.cleared>=2){
        toast("–ö–û–ú–ë–û üî•");
      }else{
        toast("–ß–ò–°–¢–û ‚úÖ");
      }
    }

    renderBoard();
    renderPieces();

    // special: empty board celebration
    if(isBoardEmpty()){
      toast("–ü–û–õ–ï –í –ù–û–õ–¨ üí£");
      const rect=document.getElementById("boardWrap").getBoundingClientRect();
      spawnConfetti(1.2);
      spawnFirework(rect.left+rect.width/2, rect.top+rect.height/2, 1.4);
      addScore(600);
    }

    // if all used -> refresh 3 new pieces
    if(pieces.every(x=>x.used)){
      newPieces();
    }

    // lose if no moves
    if(!anyMovePossible()){
      showGameOver();
    }
  }

  // ---------- Shuffle ----------
  btnShuffle.addEventListener("click", ()=>{
    if(shuffleLeft<=0){
      toast("–®–∞—Ñ—Ñ–ª –∫–æ–Ω—á–∏–ª—Å—è üòà");
      return;
    }
    for(const p of pieces){
      if(!p.used){
        p.shape = pick(SHAPES);
        p.color = pick(COLORS);
      }
    }
    shuffleLeft--;
    btnShuffle.textContent = `–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Ñ–∏–≥—É—Ä—ã (x${shuffleLeft})`;
    renderPieces();
    toast("–ü–ï–†–ï–ú–ï–®–ê–õ üí´");

    if(!anyMovePossible()){
      showGameOver();
    }
  });

  // ---------- Buttons ----------
  btnNew.addEventListener("click", restart);
  btnClose.addEventListener("click", closeModal);
  btnRestart.addEventListener("click", restart);
  overlayEl.addEventListener("click", (e)=>{ if(e.target===overlayEl) closeModal(); });

  // prevent scroll while dragging (iOS)
  document.addEventListener("touchmove", (e)=>{ if(drag) e.preventDefault(); }, {passive:false});

  // ---------- init ----------
  function init(){
    bestEl.textContent=best;
    restart();
  }
  init();

})();
</script>
</body>
</html>
