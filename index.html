<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>LEVEL RUSH ‚Äî Mobile RPG</title>
  <style>
    :root{
      --bg1:#0b0d14; --bg2:#111427;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --good: #7CFFB2;
      --warn: #FFD56A;
      --bad:  #FF6B8B;
      --acc:  #7AA7FF;
      --acc2: #B47CFF;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ margin:0; height:100%; background: radial-gradient(1200px 700px at 30% 20%, #1a1f3a 0%, var(--bg1) 40%, #07080d 100%); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    body{ overflow:hidden; }

    #game{ position:fixed; inset:0; width:100vw; height:100vh; display:block; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)); }

    .hud{
      position:fixed; left:12px; right:12px; top:10px;
      display:flex; gap:10px; align-items:stretch;
      pointer-events:none;
      z-index: 2;
    }
    .pill{
      pointer-events:auto;
      background: var(--card);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding:10px 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .hud .left{ flex:1; display:flex; flex-direction:column; gap:8px; min-width: 0; }
    .hud .right{ display:flex; gap:10px; align-items:stretch; }

    .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; font-size:12px; color:var(--muted); user-select:none; }
    .row strong{ color:var(--text); font-weight:700; }
    .bars{ display:flex; flex-direction:column; gap:8px; }
    .bar{ height:10px; border-radius:999px; border:1px solid var(--stroke); background: rgba(0,0,0,.25); overflow:hidden; }
    .bar > i{ display:block; height:100%; width:50%; background: linear-gradient(90deg, var(--acc), var(--acc2)); border-radius:999px; box-shadow: 0 0 18px rgba(122,167,255,.35); }
    .bar.hp > i{ background: linear-gradient(90deg, var(--good), #2EE59D); box-shadow: 0 0 18px rgba(124,255,178,.25); }
    .bar.shield > i{ background: linear-gradient(90deg, rgba(122,167,255,.95), rgba(180,124,255,.95)); box-shadow: 0 0 18px rgba(180,124,255,.18); }

    .btn{
      pointer-events:auto;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: 16px;
      padding:10px 12px;
      font-weight:700;
      font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{ border-color: rgba(122,167,255,.35); background: linear-gradient(180deg, rgba(122,167,255,.18), rgba(180,124,255,.10)); }
    .btn.danger{ border-color: rgba(255,107,139,.35); background: linear-gradient(180deg, rgba(255,107,139,.16), rgba(255,107,139,.06)); }
    .btn.warn{ border-color: rgba(255,213,106,.35); background: linear-gradient(180deg, rgba(255,213,106,.18), rgba(255,213,106,.06)); }

    .controls{
      position:fixed; left:0; right:0; bottom:0;
      padding: 12px;
      display:flex; justify-content:space-between; align-items:flex-end;
      pointer-events:none;
      z-index: 2;
    }
    .stickWrap{ width:160px; height:160px; pointer-events:auto; position:relative; touch-action:none; }
    .stickBase{
      position:absolute; inset:0;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
    }
    .stickKnob{
      position:absolute; left:50%; top:50%;
      width:64px; height:64px; margin:-32px 0 0 -32px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      transform: translate(0,0);
    }
    .rightButtons{ display:flex; gap:10px; align-items:flex-end; pointer-events:auto; touch-action:none; }
    .bigBtn{
      width:112px; height:112px;
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.14);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.16), rgba(255,255,255,.05));
      backdrop-filter: blur(10px);
      color:var(--text);
      font-weight:900;
      letter-spacing:.6px;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      user-select:none;
      box-shadow: 0 20px 55px rgba(0,0,0,.45);
      position:relative;
    }
    .bigBtn:active{ transform: translateY(1px) scale(.99); }
    .bigBtn span{ font-size:11px; color:var(--muted); font-weight:750; letter-spacing:0; margin-top:6px; }
    .cool{
      position:absolute; inset:0;
      border-radius: 26px;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center; justify-content:center;
      font-weight:900;
      color:rgba(255,255,255,.92);
    }
    .bigBtn.cooling .cool{ display:flex; }

    .overlay{
      position:fixed; inset:0;
      display:none;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index:10;
      padding:14px;
    }
    .overlay.show{ display:flex; }
    .panel{
      margin:auto;
      width:min(560px, 100%);
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: rgba(17,20,39,.78);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .panelHeader{
      padding:16px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .panelHeader h2{ margin:0; font-size:16px; letter-spacing:.2px; }
    .panelHeader p{ margin:2px 0 0; font-size:12px; color:var(--muted); }
    .panelBody{ padding:14px 16px 16px; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .card{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding:12px;
    }
    .card h3{ margin:0 0 6px; font-size:13px; }
    .card p{ margin:0 0 10px; font-size:12px; color:var(--muted); line-height:1.35; }
    .card .row2{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .tag{ font-size:11px; color:rgba(255,255,255,.78); padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.15); }
    .price{ font-weight:900; color:var(--warn); }
    .mono{ font-variant-numeric: tabular-nums; }

    .wideBtns{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .wideBtns .btn{ flex:1; justify-content:center; padding:12px; border-radius: 18px; }
    .smallnote{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35; }

    #startOverlay .panel{ background: rgba(10,12,20,.82); }
    .title{ font-size:22px; font-weight:950; letter-spacing:.6px; margin:0; }
    .subtitle{ margin:6px 0 0; font-size:12px; color:var(--muted); line-height:1.35; }
    .hero{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    .heroStats{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding:7px 10px;
      font-size:12px;
      color:rgba(255,255,255,.80);
    }

    .input{
      width:100%;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      font-size:14px;
    }

    @media (max-width: 380px){
      .grid{ grid-template-columns:1fr; }
      .stickWrap{ width:145px; height:145px; }
      .bigBtn{ width:104px; height:104px; border-radius: 24px; }
      .cool{ border-radius: 24px; }
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>

  <!-- HUD -->
  <div class="hud">
    <div class="pill left">
      <div class="row">
        <div>–£—Ä–æ–≤–µ–Ω—å: <strong class="mono" id="uiLevel">1</strong> <span id="uiStage" style="margin-left:8px; color:rgba(255,255,255,.65)"></span></div>
        <div>üí∞ <strong class="mono" id="uiCoins">0</strong></div>
      </div>
      <div class="bars">
        <div class="bar hp"><i id="uiHpBar"></i></div>
        <div class="bar shield"><i id="uiShieldBar"></i></div>
        <div class="bar"><i id="uiXpBar"></i></div>
      </div>
      <div class="row">
        <div>HP: <strong class="mono" id="uiHpText">0/0</strong></div>
        <div>–©–∏—Ç: <strong class="mono" id="uiShieldText">0</strong></div>
      </div>
      <div class="row">
        <div>XP: <strong class="mono" id="uiXpText">0/0</strong></div>
        <div>–ö–ª—é—á–∏: üîë <strong class="mono" id="uiKeys">0</strong></div>
      </div>
    </div>

    <div class="pill right">
      <button class="btn primary" id="btnShop">üõçÔ∏è <span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
      <button class="btn warn" id="btnChest">üéÅ <span>–°—É–Ω–¥—É–∫–∏</span></button>
      <button class="btn" id="btnUpgrades">‚öôÔ∏è <span>–ü—Ä–æ–∫–∞—á–∫–∞</span></button>
      <button class="btn danger" id="btnMenu">‚ò∞ <span>–ú–µ–Ω—é</span></button>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="stickWrap" id="stick">
      <div class="stickBase"></div>
      <div class="stickKnob" id="knob"></div>
    </div>

    <div class="rightButtons">
      <div class="bigBtn" id="btnDash">
        –†–´–í–û–ö
        <span id="dashHint">–≤–ø–µ—Ä—ë–¥</span>
        <div class="cool" id="dashCool">0.0</div>
      </div>

      <div class="bigBtn" id="btnShield">
        –©–ò–¢
        <span id="shieldHint">–∑–∞—â–∏—Ç–∞</span>
        <div class="cool" id="shieldCool">0.0</div>
      </div>

      <div class="bigBtn" id="btnAttack">
        –ê–¢–ê–ö–ê
        <span id="attackHint">–¥–µ—Ä–∂–∏/–∂–º–∏</span>
        <div class="cool" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- Start -->
  <div class="overlay show" id="startOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2 class="title">LEVEL RUSH</h2>
          <p class="subtitle">–ú–æ–±–∏–ª–∫–∞ ‚Ä¢ HTML ‚Ä¢ —É—Ä–æ–≤–Ω–∏ ‚Ä¢ –±–æ—Å—Å—ã ‚Ä¢ —Å—É–Ω–¥—É–∫–∏ ‚Ä¢ —Å–∫–∏–ª–ª—ã</p>
        </div>
        <button class="btn" id="btnResetSave">üß® –°–±—Ä–æ—Å</button>
      </div>
      <div class="hero">
        <div class="card">
          <h3>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h3>
          <p>–ü—Ä–æ—Ö–æ–¥–∏—à—å —É—Ä–æ–≤–Ω–∏, —Ñ–∞—Ä–º–∏—à—å XP/–º–æ–Ω–µ—Ç—ã. –ö–∞–∂–¥—ã–µ <b>5 —É—Ä–æ–≤–Ω–µ–π</b> ‚Äî –±–æ—Å—Å. –ó–∞ –±–æ—Å—Å–∞ –¥–∞—é—Ç <b>–∫–ª—é—á</b> üîë –∏ —à–∞–Ω—Å –Ω–∞ –∫—Ä—É—Ç–æ–π —Å—É–Ω–¥—É–∫.</p>
          <div class="heroStats">
            <div class="chip">üéÆ –î–∂–æ–π—Å—Ç–∏–∫ —Å–ª–µ–≤–∞</div>
            <div class="chip">üëä –ê—Ç–∞–∫–∞ —Å–ø—Ä–∞–≤–∞</div>
            <div class="chip">üí® –†—ã–≤–æ–∫</div>
            <div class="chip">üõ°Ô∏è –©–∏—Ç</div>
            <div class="chip">üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</div>
          </div>
        </div>
        <div class="wideBtns">
          <button class="btn primary" id="btnPlay">‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å</button>
          <button class="btn" id="btnHow">‚ùî –ü–æ–º–æ—â—å</button>
        </div>
        <div class="smallnote">
          –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: Safari ‚Üí <b>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí –ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- Menu -->
  <div class="overlay" id="menuOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–ú–µ–Ω—é</h2>
          <p class="subtitle">–ø–∞—É–∑–∞, –Ω–æ–≤–æ–µ, –∞–¥–º–∏–Ω–∫–∞</p>
        </div>
        <button class="btn" data-close="menuOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="grid">
          <div class="card">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <p>–î–∂–æ–π—Å—Ç–∏–∫ ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ. –ê—Ç–∞–∫–∞ ‚Äî –ø–æ –±–ª–∏–∂–∞–π—à–µ–º—É –≤—Ä–∞–≥—É. –†—ã–≤–æ–∫ ‚Äî —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥. –©–∏—Ç ‚Äî —Å–Ω–∏–∂–∞–µ—Ç/–ø–æ–≥–ª–æ—â–∞–µ—Ç —É—Ä–æ–Ω.</p>
            <div class="row2">
              <span class="tag">–ú–æ–±–∏–ª–∫–∞</span>
              <span class="tag">Canvas</span>
            </div>
          </div>
          <div class="card">
            <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
            <p>–¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–±—è. –í–≤–æ–¥–∏—à—å –ø–∞—Ä–æ–ª—å ‚Äî –º–æ–∂–µ—à—å –≤—ã–¥–∞—Ç—å —Å–µ–±–µ –º–æ–Ω–µ—Ç—ã –∏ –æ—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏.</p>
            <div class="row2">
              <button class="btn warn" id="btnAdmin">üõ†Ô∏è –û—Ç–∫—Ä—ã—Ç—å</button>
              <span class="tag">–ø–∞—Ä–æ–ª—å –Ω—É–∂–µ–Ω</span>
            </div>
          </div>
        </div>
        <div class="wideBtns">
          <button class="btn primary" id="btnResume">‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          <button class="btn danger" id="btnRestart">üîÑ –ù–æ–≤—ã–π –∑–∞–±–µ–≥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upgrades -->
  <div class="overlay" id="upOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–ü—Ä–æ–∫–∞—á–∫–∞</h2>
          <p class="subtitle">—Ç—Ä–∞—Ç—å –æ—á–∫–∏ –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è</p>
        </div>
        <button class="btn" data-close="upOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="card">
          <div class="row2">
            <div>–û—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏: <strong class="mono" id="uiSP">0</strong></div>
            <div class="tag">+1 –∑–∞ —É—Ä–æ–≤–µ–Ω—å</div>
          </div>
        </div>
        <div class="grid" style="margin-top:10px;">
          <div class="card">
            <h3>–£—Ä–æ–Ω</h3>
            <p>–ë–æ–ª—å—à–µ —É—Ä–æ–Ω–∞ –ø–æ –≤—Ä–∞–≥–∞–º –∏ –±–æ—Å—Å–∞–º.</p>
            <div class="row2">
              <span class="tag">DMG: <b class="mono" id="uiDmg">0</b></span>
              <button class="btn primary" id="upDmg">+1</button>
            </div>
          </div>
          <div class="card">
            <h3>–ó–¥–æ—Ä–æ–≤—å–µ</h3>
            <p>–ë–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ HP.</p>
            <div class="row2">
              <span class="tag">HP+: <b class="mono" id="uiVit">0</b></span>
              <button class="btn primary" id="upVit">+1</button>
            </div>
          </div>
          <div class="card">
            <h3>–°–∫–æ—Ä–æ—Å—Ç—å</h3>
            <p>–ë—ã—Å—Ç—Ä–µ–µ –±–µ–≥–∞–µ—à—å ‚Äî –ª–µ–≥—á–µ –∫–∞–π—Ç–∏—à—å –±–æ—Å—Å–∞.</p>
            <div class="row2">
              <span class="tag">SPD: <b class="mono" id="uiSpd">0</b></span>
              <button class="btn primary" id="upSpd">+1</button>
            </div>
          </div>
          <div class="card">
            <h3>–ö—Ä–∏—Ç</h3>
            <p>–®–∞–Ω—Å –Ω–∞–Ω–µ—Å—Ç–∏ —É—Å–∏–ª–µ–Ω–Ω—ã–π —É–¥–∞—Ä.</p>
            <div class="row2">
              <span class="tag">CRT: <b class="mono" id="uiCrt">0</b></span>
              <button class="btn primary" id="upCrt">+1</button>
            </div>
          </div>
        </div>
        <div class="smallnote">–°–∫–∏–ª–ª—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç –æ—á–∫–æ–≤: –æ–Ω–∏ –Ω–∞ –∫—É–ª–¥–∞—É–Ω–µ. –ü—Ä–æ–∫–∞—á–∫–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ —É—Ä–æ–Ω/—Ö–ø/—Å–∫–æ—Ä–æ—Å—Ç—å/–∫—Ä–∏—Ç.</div>
      </div>
    </div>
  </div>

  <!-- Shop -->
  <div class="overlay" id="shopOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
          <p class="subtitle">–∫–æ—Å–º–µ—Ç–∏–∫–∞: —Å–∫–∏–Ω—ã –∏ —Ç—Ä–µ–π–ª—ã (–Ω–∞ —Å–∏–ª—É –Ω–µ –≤–ª–∏—è–µ—Ç)</p>
        </div>
        <button class="btn" data-close="shopOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="card">
          <div class="row2">
            <div>–ë–∞–ª–∞–Ω—Å: üí∞ <strong class="mono" id="uiShopCoins">0</strong></div>
            <div class="tag">Cosmetics only</div>
          </div>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="card">
            <h3>–°–∫–∏–Ω ‚Äú–õ—ë–¥‚Äù</h3>
            <p>–•–æ–ª–æ–¥–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.</p>
            <div class="row2">
              <span class="price">250</span>
              <button class="btn primary" id="buySkinIce">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–°–∫–∏–Ω ‚Äú–ù–µ–æ–Ω‚Äù</h3>
            <p>–Ø—Ä–∫–∏–π –Ω–µ–æ–Ω, –≤–∏–¥–Ω–æ –∏–∑–¥–∞–ª–µ–∫–∞.</p>
            <div class="row2">
              <span class="price">400</span>
              <button class="btn primary" id="buySkinNeon">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–¢—Ä–µ–π–ª ‚Äú–ò—Å–∫—Ä—ã‚Äù</h3>
            <p>–°–ª–µ–¥ –∑–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º (–∫—Ä–∞—Å–∏–≤–æ).</p>
            <div class="row2">
              <span class="price">300</span>
              <button class="btn primary" id="buyTrailSparks">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–¢—Ä–µ–π–ª ‚Äú–î—ã–º‚Äù</h3>
            <p>–ú—è–≥–∫–∏–π –¥—ã–º–Ω—ã–π —Å–ª–µ–¥.</p>
            <div class="row2">
              <span class="price">300</span>
              <button class="btn primary" id="buyTrailSmoke">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <h3>–í—ã–±—Ä–∞–Ω–æ</h3>
          <p>–¢–µ–∫—É—â–∏–π —Å–∫–∏–Ω/—Ç—Ä–µ–π–ª –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –µ—Å–ª–∏ –∫—É–ø–ª–µ–Ω–æ.</p>
          <div class="row2">
            <span class="tag">–°–∫–∏–Ω: <b class="mono" id="uiSkin">default</b></span>
            <span class="tag">–¢—Ä–µ–π–ª: <b class="mono" id="uiTrail">none</b></span>
          </div>
          <div class="wideBtns">
            <button class="btn" id="equipDefault">–°–∫–∏–Ω default</button>
            <button class="btn" id="equipNoneTrail">–¢—Ä–µ–π–ª none</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chests -->
  <div class="overlay" id="chestOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–°—É–Ω–¥—É–∫–∏</h2>
          <p class="subtitle">–æ—Ç–∫—Ä—ã–≤–∞–π –∑–∞ –∫–ª—é—á–∏ üîë –∏–ª–∏ –∑–∞ –º–æ–Ω–µ—Ç—ã</p>
        </div>
        <button class="btn" data-close="chestOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="card">
          <div class="row2">
            <div>–ö–ª—é—á–∏: üîë <strong class="mono" id="uiChestKeys">0</strong></div>
            <div>–ë–∞–ª–∞–Ω—Å: üí∞ <strong class="mono" id="uiChestCoins">0</strong></div>
          </div>
          <p style="margin-top:10px;">–õ—É—Ç: –º–æ–Ω–µ—Ç—ã/–æ—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏/–∫–æ—Å–º–µ—Ç–∏–∫–∞. –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —á–∞—â–µ –¥–∞—ë—Ç –∫–æ—Å–º–µ—Ç–∏–∫—É.</p>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="card">
            <h3>–û–±—ã—á–Ω—ã–π</h3>
            <p>–ù–æ—Ä–º –ª—É—Ç, –∏–Ω–æ–≥–¥–∞ –∫–æ—Å–º–µ—Ç–∏–∫–∞.</p>
            <div class="row2">
              <span class="tag">–¶–µ–Ω–∞: 1 üîë –∏–ª–∏ 200 üí∞</span>
              <button class="btn primary" id="openCommon">–û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–†–µ–¥–∫–∏–π</h3>
            <p>–õ—É—Ç –ª—É—á—à–µ, –∫–æ—Å–º–µ—Ç–∏–∫–∞ —á–∞—â–µ.</p>
            <div class="row2">
              <span class="tag">–¶–µ–Ω–∞: 2 üîë –∏–ª–∏ 350 üí∞</span>
              <button class="btn primary" id="openRare">–û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π</h3>
            <p>–ü—É—à–∫–∞. –í—ã—Å–æ–∫–∏–π —à–∞–Ω—Å –∫–æ—Å–º–µ—Ç–∏–∫–∏.</p>
            <div class="row2">
              <span class="tag">–¶–µ–Ω–∞: 3 üîë –∏–ª–∏ 500 üí∞</span>
              <button class="btn primary" id="openLegend">–û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–î—Ä–æ–ø –∫–ª—é—á–µ–π</h3>
            <p>–ó–∞ –∫–∞–∂–¥–æ–≥–æ –±–æ—Å—Å–∞: +1 –∫–ª—é—á. –ò–Ω–æ–≥–¥–∞ +2.</p>
            <div class="row2">
              <span class="tag">–∫–∞–∂–¥—ã–µ 5 —É—Ä–æ–≤–Ω–µ–π</span>
              <span class="tag">–ë–û–°–°</span>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–π –ª—É—Ç</h3>
          <p id="lootText" style="margin:0; color:rgba(255,255,255,.85)">‚Äî</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin -->
  <div class="overlay" id="adminOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
          <p class="subtitle">–≤—ã–¥–∞—á–∞ –º–æ–Ω–µ—Ç/–æ—á–∫–æ–≤ (–ø–æ –ø–∞—Ä–æ–ª—é)</p>
        </div>
        <button class="btn" data-close="adminOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="card">
          <h3>–ü–∞—Ä–æ–ª—å</h3>
          <p>–í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫–∏ –≤—ã–¥–∞—á–∏.</p>
          <input class="input" id="adminPass" type="password" inputmode="numeric" placeholder="–ü–∞—Ä–æ–ª—å..." />
          <div class="wideBtns">
            <button class="btn primary" id="adminLogin">–í–æ–π—Ç–∏</button>
            <button class="btn" id="adminLogout">–í—ã–π—Ç–∏</button>
          </div>
          <p class="smallnote" id="adminState">–°—Ç–∞—Ç—É—Å: üîí –∑–∞–∫—Ä—ã—Ç–æ</p>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="card">
            <h3>–í—ã–¥–∞—Ç—å –º–æ–Ω–µ—Ç—ã</h3>
            <p>–î–æ–±–∞–≤–ª—è–µ—Ç –º–æ–Ω–µ—Ç—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ.</p>
            <div class="row2">
              <button class="btn warn" id="giveCoins1">+500</button>
              <button class="btn warn" id="giveCoins2">+2000</button>
            </div>
          </div>
          <div class="card">
            <h3>–í—ã–¥–∞—Ç—å –æ—á–∫–∏</h3>
            <p>–î–æ–±–∞–≤–ª—è–µ—Ç –æ—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏.</p>
            <div class="row2">
              <button class="btn warn" id="giveSP1">+5</button>
              <button class="btn warn" id="giveSP2">+20</button>
            </div>
          </div>
        </div>

        <div class="smallnote">–í–∞–∂–Ω–æ: —ç—Ç–æ ‚Äú—á–∏—Ç-–∞–¥–º–∏–Ω–∫–∞‚Äù –≤–Ω—É—Ç—Ä–∏ –∫–ª–∏–µ–Ω—Ç–∞. –ï—Å–ª–∏ –∫–æ–º—É-—Ç–æ –¥–∞—Ç—å —Ñ–∞–π–ª ‚Äî –æ–Ω–∏ —É–≤–∏–¥—è—Ç –ø–∞—Ä–æ–ª—å –≤ –∫–æ–¥–µ. –î–ª—è —Ç–≤–æ–µ–π —Å–æ–ª–æ-–∏–≥—Ä—ã –Ω–æ—Ä–º üòÑ</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- Utilities ----------
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const rnd = (a,b) => a + Math.random()*(b-a);
  const dist = (ax,ay,bx,by) => Math.hypot(ax-bx, ay-by);

  // ---------- Canvas ----------
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', { alpha: false });

  function resize(){
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    canvas.width  = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor(innerHeight * dpr);
    canvas.style.width = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize);
  resize();

  // ---------- Save / Load ----------
  const SAVE_KEY = 'level_rush_save_v2';
  const ADMIN_PASSWORD = '1235';

  const defaultSave = () => ({
    coins: 0,
    keys: 0,
    level: 1,
    xp: 0,
    sp: 0,
    stats: { dmg: 0, vit: 0, spd: 0, crt: 0 },
    cosmetics: {
      ownedSkins: { default: true },
      ownedTrails: { none: true },
      skin: 'default',
      trail: 'none'
    },
    adminUnlocked: false
  });

  function loadSave(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return defaultSave();
      const s = JSON.parse(raw);
      const d = defaultSave();
      return {
        ...d, ...s,
        stats: { ...d.stats, ...(s.stats||{}) },
        cosmetics: {
          ...d.cosmetics,
          ...(s.cosmetics||{}),
          ownedSkins: { ...d.cosmetics.ownedSkins, ...((s.cosmetics||{}).ownedSkins||{}) },
          ownedTrails:{ ...d.cosmetics.ownedTrails,...((s.cosmetics||{}).ownedTrails||{}) }
        }
      };
    }catch(e){
      return defaultSave();
    }
  }
  function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify(S)); }

  let S = loadSave();

  // ---------- UI helpers ----------
  const $ = (id) => document.getElementById(id);

  const uiLevel = $('uiLevel');
  const uiCoins = $('uiCoins');
  const uiKeys  = $('uiKeys');

  const uiHpBar = $('uiHpBar');
  const uiXpBar = $('uiXpBar');
  const uiShieldBar = $('uiShieldBar');

  const uiHpText = $('uiHpText');
  const uiXpText = $('uiXpText');
  const uiShieldText = $('uiShieldText');

  const uiStage = $('uiStage');

  const btnShop = $('btnShop');
  const btnUpgrades = $('btnUpgrades');
  const btnMenu = $('btnMenu');
  const btnChest = $('btnChest');

  const startOverlay = $('startOverlay');
  const menuOverlay = $('menuOverlay');
  const upOverlay = $('upOverlay');
  const shopOverlay = $('shopOverlay');
  const chestOverlay = $('chestOverlay');
  const adminOverlay = $('adminOverlay');

  const btnPlay = $('btnPlay');
  const btnHow = $('btnHow');
  const btnResetSave = $('btnResetSave');
  const btnResume = $('btnResume');
  const btnRestart = $('btnRestart');

  const uiSP = $('uiSP');
  const uiDmg = $('uiDmg');
  const uiVit = $('uiVit');
  const uiSpd = $('uiSpd');
  const uiCrt = $('uiCrt');

  const upDmg = $('upDmg');
  const upVit = $('upVit');
  const upSpd = $('upSpd');
  const upCrt = $('upCrt');

  const uiShopCoins = $('uiShopCoins');
  const uiSkin = $('uiSkin');
  const uiTrail = $('uiTrail');

  const buySkinIce = $('buySkinIce');
  const buySkinNeon = $('buySkinNeon');
  const buyTrailSparks = $('buyTrailSparks');
  const buyTrailSmoke = $('buyTrailSmoke');
  const equipDefault = $('equipDefault');
  const equipNoneTrail = $('equipNoneTrail');

  // chest UI
  const uiChestKeys = $('uiChestKeys');
  const uiChestCoins = $('uiChestCoins');
  const lootText = $('lootText');
  const openCommon = $('openCommon');
  const openRare = $('openRare');
  const openLegend = $('openLegend');

  // admin UI
  const btnAdmin = $('btnAdmin');
  const adminPass = $('adminPass');
  const adminLogin = $('adminLogin');
  const adminLogout = $('adminLogout');
  const adminState = $('adminState');
  const giveCoins1 = $('giveCoins1');
  const giveCoins2 = $('giveCoins2');
  const giveSP1 = $('giveSP1');
  const giveSP2 = $('giveSP2');

  document.querySelectorAll('[data-close]').forEach(b=>{
    b.addEventListener('click', () => hideOverlay(b.getAttribute('data-close')));
  });

  let paused = true;
  let gameOver = false;

  function showOverlay(el){
    el.classList.add('show');
    paused = true;
    updateUI();
  }
  function hideOverlay(id){
    const el = typeof id === 'string' ? $(id) : id;
    el.classList.remove('show');
    if(!startOverlay.classList.contains('show')) paused = false;
    updateUI();
    save();
  }

  // ---------- Game state ----------
  const world = { w: () => innerWidth, h: () => innerHeight, arenaPad: 42 };

  function skinColor(name){
    if(name === 'ice')  return '#7AA7FF';
    if(name === 'neon') return '#B47CFF';
    return '#FFFFFF';
  }

  const player = {
    x: innerWidth*0.5, y: innerHeight*0.62,
    r: 14,
    vx: 0, vy: 0,
    maxHp: 100,
    hp: 100,
    baseSpeed: 190,
    atkCd: 0,
    hitFlash: 0,

    // skills
    shield: 0,
    shieldMax: 0,
    shieldTime: 0,

    dashCd: 0,
    shieldCd: 0,
    dashTime: 0,
    dashVx: 0,
    dashVy: 0
  };

  const enemies = [];
  const particles = [];
  const trails = [];

  let wave = 1;
  let enemiesToSpawn = 3;
  let bossActive = false;

  function xpNeedForLevel(lv){
    return Math.floor(60 + lv*25 + Math.pow(lv, 1.25)*6);
  }

  function isBossLevel(lv){ return lv % 5 === 0; }

  function stageName(lv){
    if(isBossLevel(lv)) return '‚Äî –ë–û–°–°';
    return '‚Äî –í–æ–ª–Ω–∞ ' + wave;
  }

  function applyStats(){
    const st = S.stats;
    player.maxHp = 100 + st.vit * 22;
    player.baseSpeed = 190 + st.spd * 14;

    // shield baseline scales slightly with vit
    player.shieldMax = 40 + st.vit * 8;

    if(player.hp > player.maxHp) player.hp = player.maxHp;
    player.shield = clamp(player.shield, 0, player.shieldMax);
  }
  applyStats();

  function spawnEnemy(kind='mob'){
    const pad = world.arenaPad;
    const x = Math.random() < 0.5 ? rnd(pad, world.w()-pad) : (Math.random()<0.5 ? pad : world.w()-pad);
    const y = Math.random() < 0.5 ? rnd(pad+80, world.h()-pad) : (Math.random()<0.5 ? pad+80 : world.h()-pad);

    const baseLv = S.level;

    let hp = 40 + baseLv*9;
    let spd = 95 + baseLv*2.5;
    let dmg = 10 + baseLv*1.2;
    let r = 12;

    if(kind==='brute'){ hp *= 1.6; spd *= 0.82; dmg *= 1.25; r = 15; }
    if(kind==='runner'){ hp *= 0.85; spd *= 1.35; dmg *= 0.9; r = 11; }
    if(kind==='boss'){
      hp = 260 + baseLv*55;
      spd = 110 + baseLv*1.8;
      dmg = 18 + baseLv*2.0;
      r = 26;
    }

    enemies.push({
      x,y,r, vx:0, vy:0,
      hp, maxHp: hp,
      spd, dmg, kind,
      hitFlash: 0,
      atkCd: rnd(0.4, 1.2)
    });
  }

  function spawnWave(){
    enemies.length = 0;
    const lv = S.level;
    const count = enemiesToSpawn + Math.floor(wave*0.6);
    for(let i=0;i<count;i++){
      const t = Math.random();
      if(t < 0.15) spawnEnemy('runner');
      else if(t < 0.35) spawnEnemy('brute');
      else spawnEnemy('mob');
    }
  }

  function startLevel(lv){
    applyStats();
    gameOver = false;
    wave = 1;
    bossActive = false;

    enemies.length = 0;
    particles.length = 0;
    trails.length = 0;

    player.hp = player.maxHp;
    player.shield = 0;
    player.shieldTime = 0;

    if(isBossLevel(lv)){
      bossActive = true;
      spawnEnemy('boss');
    }else{
      enemiesToSpawn = 3 + Math.floor(lv*0.6);
      spawnWave();
    }
  }

  function addCoins(n){ S.coins += n; }
  function addKeys(n){ S.keys = Math.max(0, S.keys + n); }

  function addXp(n){
    S.xp += n;
    while(S.xp >= xpNeedForLevel(S.level)){
      S.xp -= xpNeedForLevel(S.level);
      S.level += 1;
      S.sp += 1;
      player.hp = clamp(player.hp + player.maxHp*0.35, 0, player.maxHp);
    }
  }

  // ---------- Touch joystick ----------
  const stick = $('stick');
  const knob = $('knob');
  let stickActive = false;
  let stickId = null;
  let stickCenter = {x:0,y:0};
  let stickVec = {x:0,y:0};

  function updateStickVisual(dx,dy){
    const max = 48;
    const lx = clamp(dx, -max, max);
    const ly = clamp(dy, -max, max);
    knob.style.transform = `translate(${lx}px, ${ly}px)`;
  }

  function onStickStart(e){
    e.preventDefault();
    const t = e.changedTouches ? e.changedTouches[0] : e;
    stickActive = true;
    stickId = t.identifier ?? 'mouse';
    const rect = stick.getBoundingClientRect();
    stickCenter.x = rect.left + rect.width/2;
    stickCenter.y = rect.top + rect.height/2;
    stickVec.x = 0; stickVec.y = 0;
    updateStickVisual(0,0);
  }
  function onStickMove(e){
    if(!stickActive) return;
    const touches = e.changedTouches ? [...e.changedTouches] : [e];
    const t = touches.find(tt => (tt.identifier ?? 'mouse') === stickId);
    if(!t) return;
    const dx = (t.clientX - stickCenter.x);
    const dy = (t.clientY - stickCenter.y);
    const max = 52;
    stickVec.x = clamp(dx / max, -1, 1);
    stickVec.y = clamp(dy / max, -1, 1);
    updateStickVisual(dx,dy);
  }
  function onStickEnd(e){
    if(!stickActive) return;
    const touches = e.changedTouches ? [...e.changedTouches] : [e];
    const t = touches.find(tt => (tt.identifier ?? 'mouse') === stickId);
    if(!t) return;
    stickActive = false;
    stickId = null;
    stickVec.x = 0; stickVec.y = 0;
    updateStickVisual(0,0);
  }

  stick.addEventListener('touchstart', onStickStart, {passive:false});
  stick.addEventListener('touchmove', onStickMove, {passive:false});
  stick.addEventListener('touchend', onStickEnd, {passive:false});
  stick.addEventListener('touchcancel', onStickEnd, {passive:false});
  stick.addEventListener('mousedown', onStickStart);
  window.addEventListener('mousemove', onStickMove);
  window.addEventListener('mouseup', onStickEnd);

  // ---------- Attack + Skills ----------
  const btnAttack = $('btnAttack');
  const btnDash = $('btnDash');
  const btnShield = $('btnShield');

  const dashCool = $('dashCool');
  const shieldCool = $('shieldCool');

  let attackHeld = false;
  function setAttackHeld(v){ attackHeld = v; }

  btnAttack.addEventListener('touchstart', (e)=>{ e.preventDefault(); setAttackHeld(true); }, {passive:false});
  btnAttack.addEventListener('touchend',   (e)=>{ e.preventDefault(); setAttackHeld(false); }, {passive:false});
  btnAttack.addEventListener('touchcancel',(e)=>{ e.preventDefault(); setAttackHeld(false); }, {passive:false});
  btnAttack.addEventListener('mousedown', ()=>setAttackHeld(true));
  window.addEventListener('mouseup', ()=>setAttackHeld(false));

  function tryDash(){
    if(player.dashCd > 0 || player.dashTime > 0) return;
    // direction: stick if any, else toward nearest enemy, else up
    let dx = stickVec.x, dy = stickVec.y;
    let m = Math.hypot(dx,dy);
    if(m < 0.15){
      const e = nearestEnemy();
      if(e){
        dx = e.x - player.x; dy = e.y - player.y;
        m = Math.hypot(dx,dy);
      }
    }
    if(m < 0.15){ dx = 0; dy = -1; m = 1; }

    dx /= m; dy /= m;

    player.dashTime = 0.16;             // duration
    const dashSpeed = 680;              // punchy
    player.dashVx = dx * dashSpeed;
    player.dashVy = dy * dashSpeed;
    player.dashCd = 2.6;                // cooldown
  }

  function tryShield(){
    if(player.shieldCd > 0 || player.shieldTime > 0) return;
    applyStats();
    player.shield = player.shieldMax;
    player.shieldTime = 3.2;           // active duration
    player.shieldCd = 7.5;             // cooldown
  }

  btnDash.addEventListener('touchstart', (e)=>{ e.preventDefault(); tryDash(); }, {passive:false});
  btnShield.addEventListener('touchstart', (e)=>{ e.preventDefault(); tryShield(); }, {passive:false});
  btnDash.addEventListener('mousedown', ()=>tryDash());
  btnShield.addEventListener('mousedown', ()=>tryShield());

  // ---------- Buttons ----------
  btnPlay.addEventListener('click', ()=>{
    startOverlay.classList.remove('show');
    paused = false;
    startLevel(S.level);
    updateUI();
    save();
  });

  btnHow.addEventListener('click', ()=>{
    alert("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:\n‚Äî –î–∂–æ–π—Å—Ç–∏–∫: –¥–≤–∏–∂–µ–Ω–∏–µ\n‚Äî –ê—Ç–∞–∫–∞: –±—å—ë—à—å –±–ª–∏–∂–Ω–µ–≥–æ –≤—Ä–∞–≥–∞\n‚Äî –†—ã–≤–æ–∫: –±—ã—Å—Ç—Ä—ã–π —Ä—ã–≤–æ–∫ –≤–ø–µ—Ä—ë–¥ (–∫—É–ª–¥–∞—É–Ω)\n‚Äî –©–∏—Ç: –¥–∞—ë—Ç —â–∏—Ç –Ω–∞ 3 —Å–µ–∫ (–∫—É–ª–¥–∞—É–Ω)\n\n–°—É–Ω–¥—É–∫–∏:\n‚Äî –ó–∞ –±–æ—Å—Å–∞ +1 –∫–ª—é—á\n‚Äî –û—Ç–∫—Ä—ã–≤–∞–π —Å—É–Ω–¥—É–∫–∏ –∑–∞ –∫–ª—é—á–∏ –∏–ª–∏ –º–æ–Ω–µ—Ç—ã\n\n–ê–¥–º–∏–Ω–∫–∞:\n‚Äî –ú–µ–Ω—é ‚Üí –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Üí –ø–∞—Ä–æ–ª—å");
  });

  btnShop.addEventListener('click', ()=> showOverlay(shopOverlay));
  btnUpgrades.addEventListener('click', ()=> showOverlay(upOverlay));
  btnMenu.addEventListener('click', ()=> showOverlay(menuOverlay));
  btnChest.addEventListener('click', ()=> showOverlay(chestOverlay));

  btnResume.addEventListener('click', ()=> hideOverlay('menuOverlay'));

  btnRestart.addEventListener('click', ()=>{
    hideOverlay('menuOverlay');
    startLevel(S.level);
    save();
  });

  btnResetSave.addEventListener('click', ()=>{
    const ok = confirm("–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å? –≠—Ç–æ –ø—Ä—è–º –≤—Å—ë-–≤—Å—ë —É–¥–∞–ª–∏—Ç.");
    if(!ok) return;
    localStorage.removeItem(SAVE_KEY);
    S = loadSave();
    applyStats();
    updateUI();
    startLevel(S.level);
  });

  // upgrades
  function trySpendSP(){ if(S.sp <= 0) return false; S.sp -= 1; return true; }
  upDmg.addEventListener('click', ()=>{ if(!trySpendSP()) return; S.stats.dmg += 1; updateUI(); save(); });
  upVit.addEventListener('click', ()=>{ if(!trySpendSP()) return; S.stats.vit += 1; applyStats(); updateUI(); save(); });
  upSpd.addEventListener('click', ()=>{ if(!trySpendSP()) return; S.stats.spd += 1; applyStats(); updateUI(); save(); });
  upCrt.addEventListener('click', ()=>{ if(!trySpendSP()) return; S.stats.crt += 1; updateUI(); save(); });

  // shop helpers
  function canAfford(cost){ return S.coins >= cost; }
  function buy(cost){ if(!canAfford(cost)) return false; S.coins -= cost; return true; }
  function ownSkin(k){ return !!S.cosmetics.ownedSkins[k]; }
  function ownTrail(k){ return !!S.cosmetics.ownedTrails[k]; }

  function equipSkin(k){ if(!ownSkin(k)) return; S.cosmetics.skin = k; updateUI(); save(); }
  function equipTrail(k){ if(!ownTrail(k)) return; S.cosmetics.trail = k; updateUI(); save(); }

  buySkinIce.addEventListener('click', ()=>{
    if(ownSkin('ice')) return equipSkin('ice');
    if(!buy(250)) return;
    S.cosmetics.ownedSkins.ice = true;
    equipSkin('ice');
  });
  buySkinNeon.addEventListener('click', ()=>{
    if(ownSkin('neon')) return equipSkin('neon');
    if(!buy(400)) return;
    S.cosmetics.ownedSkins.neon = true;
    equipSkin('neon');
  });
  buyTrailSparks.addEventListener('click', ()=>{
    if(ownTrail('sparks')) return equipTrail('sparks');
    if(!buy(300)) return;
    S.cosmetics.ownedTrails.sparks = true;
    equipTrail('sparks');
  });
  buyTrailSmoke.addEventListener('click', ()=>{
    if(ownTrail('smoke')) return equipTrail('smoke');
    if(!buy(300)) return;
    S.cosmetics.ownedTrails.smoke = true;
    equipTrail('smoke');
  });

  equipDefault.addEventListener('click', ()=> equipSkin('default'));
  equipNoneTrail.addEventListener('click', ()=> equipTrail('none'));

  // ---------- Chests ----------
  function randPick(arr){
    const total = arr.reduce((s,x)=>s+x.w,0);
    let r = Math.random()*total;
    for(const it of arr){
      r -= it.w;
      if(r <= 0) return it;
    }
    return arr[arr.length-1];
  }

  const CHEST = {
    common: { keyCost: 1, coinCost: 200, name: '–û–±—ã—á–Ω—ã–π' },
    rare:   { keyCost: 2, coinCost: 350, name: '–†–µ–¥–∫–∏–π' },
    legend: { keyCost: 3, coinCost: 500, name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π' },
  };

  function grantCosmeticRandom(tier){
    // pool of cosmetics
    const skins = ['ice','neon'];
    const trails = ['sparks','smoke'];

    // prefer not-owned
    const notOwnedSkins = skins.filter(s=>!ownSkin(s));
    const notOwnedTrails = trails.filter(s=>!ownTrail(s));

    const pool = [];
    // weights depend on tier
    const skinW = tier==='legend' ? 3.0 : tier==='rare' ? 2.0 : 1.0;
    const trailW= tier==='legend' ? 3.0 : tier==='rare' ? 2.0 : 1.0;

    (notOwnedSkins.length ? notOwnedSkins : skins).forEach(s=> pool.push({type:'skin', id:s, w: skinW}));
    (notOwnedTrails.length? notOwnedTrails: trails).forEach(s=> pool.push({type:'trail',id:s, w: trailW}));

    const pick = randPick(pool);
    if(pick.type === 'skin'){ S.cosmetics.ownedSkins[pick.id] = true; S.cosmetics.skin = pick.id; return `üé® –ö–æ—Å–º–µ—Ç–∏–∫–∞: —Å–∫–∏–Ω "${pick.id}" (–Ω–∞–¥–µ—Ç)`; }
    else { S.cosmetics.ownedTrails[pick.id] = true; S.cosmetics.trail = pick.id; return `‚ú® –ö–æ—Å–º–µ—Ç–∏–∫–∞: —Ç—Ä–µ–π–ª "${pick.id}" (–Ω–∞–¥–µ—Ç)`; }
  }

  function openChest(tier){
    const cfg = CHEST[tier];

    // pay: prefer keys if available
    if(S.keys >= cfg.keyCost){
      S.keys -= cfg.keyCost;
    }else{
      if(S.coins < cfg.coinCost){
        lootText.textContent = `–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç üîë –∏–ª–∏ üí∞ –¥–ª—è —Å—É–Ω–¥—É–∫–∞ "${cfg.name}".`;
        return;
      }
      S.coins -= cfg.coinCost;
    }

    // loot table
    // Common: more coins, some xp/sp, rare cosmetic
    // Rare: balanced, more sp chance
    // Legend: high cosmetic chance + good rewards
    const tables = {
      common: [
        { w: 55, fn: ()=>{ const c = 200 + Math.floor(rnd(0,120)); addCoins(c); return `üí∞ –ú–æ–Ω–µ—Ç—ã: +${c}`; } },
        { w: 18, fn: ()=>{ const c = 450 + Math.floor(rnd(0,250)); addCoins(c); return `üí∞ –ú–æ–Ω–µ—Ç—ã: +${c}`; } },
        { w: 14, fn: ()=>{ const sp = 1; S.sp += sp; return `‚≠ê –û—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏: +${sp}`; } },
        { w: 8,  fn: ()=>{ const sp = 2; S.sp += sp; return `‚≠ê –û—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏: +${sp}`; } },
        { w: 5,  fn: ()=> grantCosmeticRandom('common') },
      ],
      rare: [
        { w: 38, fn: ()=>{ const c = 350 + Math.floor(rnd(0,180)); addCoins(c); return `üí∞ –ú–æ–Ω–µ—Ç—ã: +${c}`; } },
        { w: 22, fn: ()=>{ const c = 700 + Math.floor(rnd(0,350)); addCoins(c); return `üí∞ –ú–æ–Ω–µ—Ç—ã: +${c}`; } },
        { w: 18, fn: ()=>{ const sp = 2; S.sp += sp; return `‚≠ê –û—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏: +${sp}`; } },
        { w: 12, fn: ()=>{ const sp = 3; S.sp += sp; return `‚≠ê –û—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏: +${sp}`; } },
        { w: 10, fn: ()=> grantCosmeticRandom('rare') },
      ],
      legend: [
        { w: 18, fn: ()=>{ const c = 600 + Math.floor(rnd(0,250)); addCoins(c); return `üí∞ –ú–æ–Ω–µ—Ç—ã: +${c}`; } },
        { w: 22, fn: ()=>{ const c = 1200 + Math.floor(rnd(0,600)); addCoins(c); return `üí∞ –ú–æ–Ω–µ—Ç—ã: +${c}`; } },
        { w: 20, fn: ()=>{ const sp = 4; S.sp += sp; return `‚≠ê –û—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏: +${sp}`; } },
        { w: 15, fn: ()=>{ const sp = 6; S.sp += sp; return `‚≠ê –û—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏: +${sp}`; } },
        { w: 25, fn: ()=> grantCosmeticRandom('legend') },
      ],
    };

    const pick = randPick(tables[tier]);
    const text = pick.fn();
    lootText.textContent = `–°—É–Ω–¥—É–∫ "${cfg.name}": ${text}`;
    updateUI();
    save();
  }

  openCommon.addEventListener('click', ()=> openChest('common'));
  openRare.addEventListener('click', ()=> openChest('rare'));
  openLegend.addEventListener('click', ()=> openChest('legend'));

  // ---------- Admin panel ----------
  btnAdmin.addEventListener('click', ()=> showOverlay(adminOverlay));

  function setAdminUI(){
    const on = !!S.adminUnlocked;
    adminState.textContent = `–°—Ç–∞—Ç—É—Å: ${on ? 'üîì –æ—Ç–∫—Ä—ã—Ç–æ' : 'üîí –∑–∞–∫—Ä—ã—Ç–æ'}`;
    const dis = !on;
    [giveCoins1,giveCoins2,giveSP1,giveSP2].forEach(b=>{
      b.disabled = dis;
      b.style.opacity = dis ? 0.5 : 1;
    });
  }

  adminLogin.addEventListener('click', ()=>{
    const pass = (adminPass.value || '').trim();
    if(pass === ADMIN_PASSWORD){
      S.adminUnlocked = true;
      adminPass.value = '';
      setAdminUI();
      updateUI(); save();
    }else{
      alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å üòà');
    }
  });

  adminLogout.addEventListener('click', ()=>{
    S.adminUnlocked = false;
    setAdminUI();
    updateUI(); save();
  });

  function adminGuard(){
    if(!S.adminUnlocked){
      alert('–ê–¥–º–∏–Ω–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞. –í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å.');
      return false;
    }
    return true;
  }
  giveCoins1.addEventListener('click', ()=>{ if(!adminGuard()) return; addCoins(500); updateUI(); save(); });
  giveCoins2.addEventListener('click', ()=>{ if(!adminGuard()) return; addCoins(2000); updateUI(); save(); });
  giveSP1.addEventListener('click', ()=>{ if(!adminGuard()) return; S.sp += 5; updateUI(); save(); });
  giveSP2.addEventListener('click', ()=>{ if(!adminGuard()) return; S.sp += 20; updateUI(); save(); });

  // ---------- Combat ----------
  function damageForPlayer(){
    const st = S.stats;
    const base = 18 + st.dmg*6;
    const critChance = 0.03 + st.crt*0.025;
    const crit = Math.random() < critChance;
    return { dmg: crit ? base*1.9 : base, crit };
  }

  function nearestEnemy(){
    if(enemies.length===0) return null;
    let best = null, bestD = 1e9;
    for(const e of enemies){
      const d = dist(player.x,player.y,e.x,e.y);
      if(d < bestD){ bestD = d; best = e; }
    }
    return best;
  }

  function doAttack(){
    if(player.atkCd > 0) return;
    const e = nearestEnemy();
    if(!e) return;
    const d = dist(player.x,player.y,e.x,e.y);
    if(d > player.r + e.r + 24) return;
    player.atkCd = 0.22;
    const {dmg, crit} = damageForPlayer();
    e.hp -= dmg;
    e.hitFlash = 0.12;
    spawnHit(e.x, e.y, crit);
    const nx = (e.x - player.x) / (d || 1);
    const ny = (e.y - player.y) / (d || 1);
    e.vx += nx*120;
    e.vy += ny*120;
  }

  function spawnHit(x,y,crit){
    for(let i=0;i<10;i++){
      particles.push({
        x, y,
        vx: rnd(-180,180),
        vy: rnd(-220,80),
        life: rnd(0.25,0.45),
        t: 0,
        r: rnd(1.5,3.5),
        crit
      });
    }
  }

  function spawnTrail(){
    const t = S.cosmetics.trail;
    if(t === 'none') return;
    trails.push({
      x: player.x, y: player.y,
      r: player.r * (t==='smoke' ? 1.05 : 0.85),
      life: t==='smoke' ? 0.55 : 0.35,
      t: 0,
      kind: t
    });
  }

  // ---------- Enemy AI ----------
  function takePlayerDamage(amount){
    // shield absorbs first
    if(player.shield > 0){
      const use = Math.min(player.shield, amount);
      player.shield -= use;
      amount -= use;
    }
    if(amount > 0) player.hp -= amount;
  }

  function enemyUpdate(e, dt){
    const dx = player.x - e.x;
    const dy = player.y - e.y;
    const d = Math.hypot(dx,dy) || 1;

    const ax = (dx/d) * e.spd;
    const ay = (dy/d) * e.spd;
    e.vx += ax * dt;
    e.vy += ay * dt;

    e.vx *= Math.pow(0.0006, dt);
    e.vy *= Math.pow(0.0006, dt);

    e.x += e.vx * dt;
    e.y += e.vy * dt;

    const pad = world.arenaPad;
    e.x = clamp(e.x, pad, world.w()-pad);
    e.y = clamp(e.y, pad+60, world.h()-pad);

    e.atkCd -= dt;
    const range = e.r + player.r + (e.kind==='boss' ? 18 : 10);
    if(e.atkCd <= 0 && d < range){
      e.atkCd = e.kind==='boss' ? 0.55 : 0.75;

      const raw = e.dmg;
      takePlayerDamage(raw);

      player.hitFlash = 0.12;

      const nx = (player.x - e.x)/(d||1);
      const ny = (player.y - e.y)/(d||1);
      player.vx += nx*220;
      player.vy += ny*220;

      spawnHit(player.x, player.y, false);

      if(player.hp <= 0){
        player.hp = 0;
        gameOver = true;
        paused = true;
        setTimeout(()=>{
          alert("–ù–£ –¢–´ –ò –õ–û–• üòà\n(—à—É—Ç–∫–∞)\n\n–¢—ã —É–º–µ—Ä(–ª–∞). –ù–∞–∂–º–∏ –û–ö ‚Äî –Ω–∞—á–Ω—ë—à—å —É—Ä–æ–≤–µ–Ω—å –∑–∞–Ω–æ–≤–æ.");
          player.hp = player.maxHp;
          player.shield = 0;
          gameOver = false;
          paused = false;
          startLevel(S.level);
          updateUI();
          save();
        }, 50);
      }
    }

    e.hitFlash = Math.max(0, e.hitFlash - dt);
  }

  // ---------- UI update ----------
  function updateUI(){
    uiLevel.textContent = S.level;
    uiCoins.textContent = S.coins;
    uiKeys.textContent = S.keys;

    uiShopCoins.textContent = S.coins;
    uiSP.textContent = S.sp;

    uiDmg.textContent = S.stats.dmg;
    uiVit.textContent = S.stats.vit;
    uiSpd.textContent = S.stats.spd;
    uiCrt.textContent = S.stats.crt;

    uiSkin.textContent = S.cosmetics.skin;
    uiTrail.textContent = S.cosmetics.trail;

    uiChestCoins.textContent = S.coins;
    uiChestKeys.textContent = S.keys;

    uiHpText.textContent = `${Math.ceil(player.hp)}/${player.maxHp}`;
    const hn = player.maxHp ? player.hp/player.maxHp : 0;
    uiHpBar.style.width = `${clamp(hn*100,0,100)}%`;

    uiShieldText.textContent = `${Math.ceil(player.shield)}`;
    const sn = player.shieldMax ? player.shield/player.shieldMax : 0;
    uiShieldBar.style.width = `${clamp(sn*100,0,100)}%`;

    const need = xpNeedForLevel(S.level);
    uiXpText.textContent = `${S.xp}/${need}`;
    uiXpBar.style.width = `${clamp((S.xp/need)*100,0,100)}%`;

    uiStage.textContent = stageName(S.level);

    buySkinIce.textContent = ownSkin('ice') ? (S.cosmetics.skin==='ice' ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';
    buySkinNeon.textContent = ownSkin('neon') ? (S.cosmetics.skin==='neon' ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';
    buyTrailSparks.textContent = ownTrail('sparks') ? (S.cosmetics.trail==='sparks' ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';
    buyTrailSmoke.textContent = ownTrail('smoke') ? (S.cosmetics.trail==='smoke' ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';

    // skill cooldown display
    if(player.dashCd > 0){
      btnDash.classList.add('cooling');
      dashCool.textContent = player.dashCd.toFixed(1);
    }else{
      btnDash.classList.remove('cooling');
    }
    if(player.shieldCd > 0){
      btnShield.classList.add('cooling');
      shieldCool.textContent = player.shieldCd.toFixed(1);
    }else{
      btnShield.classList.remove('cooling');
    }

    setAdminUI();
  }

  // ---------- Drawing ----------
  function roundRect(c, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    c.moveTo(x+rr,y);
    c.arcTo(x+w,y, x+w,y+h, rr);
    c.arcTo(x+w,y+h, x,y+h, rr);
    c.arcTo(x,y+h, x,y, rr);
    c.arcTo(x,y, x+w,y, rr);
    c.closePath();
  }

  function drawBg(){
    const w = world.w(), h = world.h();
    ctx.fillStyle = '#0a0b12';
    ctx.fillRect(0,0,w,h);

    const g = ctx.createRadialGradient(w*0.3,h*0.2,0,w*0.3,h*0.2,520);
    g.addColorStop(0,'rgba(122,167,255,.10)');
    g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle = g; ctx.fillRect(0,0,w,h);

    const g2 = ctx.createRadialGradient(w*0.75,h*0.35,0,w*0.75,h*0.35,580);
    g2.addColorStop(0,'rgba(180,124,255,.10)');
    g2.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle = g2; ctx.fillRect(0,0,w,h);

    ctx.globalAlpha = 0.12;
    ctx.strokeStyle = 'rgba(255,255,255,.18)';
    ctx.lineWidth = 1;
    const step = 44;
    ctx.beginPath();
    for(let x=0; x<w; x+=step){ ctx.moveTo(x,0); ctx.lineTo(x,h); }
    for(let y=0; y<h; y+=step){ ctx.moveTo(0,y); ctx.lineTo(w,y); }
    ctx.stroke();
    ctx.globalAlpha = 1;

    const pad = world.arenaPad;
    ctx.strokeStyle = 'rgba(255,255,255,.16)';
    ctx.lineWidth = 2;
    ctx.strokeRect(pad, pad+60, w-pad*2, h-(pad*2+60));
  }

  function drawEntityCircle(x,y,r,color,flash=0){
    ctx.save();
    if(flash>0){
      ctx.shadowColor = 'rgba(255,255,255,.9)';
      ctx.shadowBlur = 18;
    }else{
      ctx.shadowColor = 'rgba(0,0,0,.6)';
      ctx.shadowBlur = 12;
    }
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function drawHpBar(x,y,w,h,ratio,color){
    ctx.save();
    ctx.fillStyle = 'rgba(0,0,0,.35)';
    ctx.strokeStyle = 'rgba(255,255,255,.10)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    roundRect(ctx, x, y, w, h, 999);
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = color;
    ctx.beginPath();
    roundRect(ctx, x, y, w*clamp(ratio,0,1), h, 999);
    ctx.fill();
    ctx.restore();
  }

  function draw(){
    const w = world.w(), h = world.h();
    drawBg();

    // trails
    for(const t of trails){
      const a = 1 - (t.t / t.life);
      ctx.globalAlpha = a * (t.kind==='smoke' ? 0.18 : 0.30);
      ctx.fillStyle = t.kind==='sparks' ? 'rgba(255,213,106,1)' : 'rgba(255,255,255,1)';
      ctx.beginPath();
      ctx.arc(t.x, t.y, t.r*(0.9 + (t.t/t.life)*0.6), 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // enemies
    for(const e of enemies){
      const isBoss = e.kind==='boss';
      const c = isBoss ? '#FF6B8B' : (e.kind==='runner' ? '#FFD56A' : (e.kind==='brute' ? '#7CFFB2' : '#FFFFFF'));
      drawEntityCircle(e.x,e.y,e.r, c, e.hitFlash);
      const ratio = e.hp / e.maxHp;
      drawHpBar(e.x - 26, e.y - e.r - 14, 52, 8, ratio, isBoss ? 'rgba(255,107,139,.95)' : 'rgba(255,255,255,.75)');
    }

    // player + shield ring
    const pc = skinColor(S.cosmetics.skin);
    drawEntityCircle(player.x,player.y,player.r+3,'rgba(0,0,0,.45)');
    drawEntityCircle(player.x,player.y,player.r, pc, player.hitFlash);

    if(player.shield > 0){
      ctx.save();
      ctx.globalAlpha = 0.55 + 0.25*Math.sin(performance.now()/120);
      ctx.strokeStyle = 'rgba(180,124,255,.95)';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.r+10, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    // particles
    for(const p of particles){
      const a = 1 - (p.t/p.life);
      ctx.globalAlpha = a;
      ctx.fillStyle = p.crit ? 'rgba(255,213,106,1)' : 'rgba(255,255,255,1)';
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // bottom helper
    ctx.save();
    ctx.globalAlpha = 0.85;
    ctx.fillStyle = 'rgba(255,255,255,.75)';
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
    const t = isBossLevel(S.level) ? '–ë–û–°–°: –∑–∞–±–µ—Ä–∏ –∫–ª—é—á üîë –∏ –ª—É—Ç' : '–í–û–õ–ù–´: –∑–∞—á–∏—Å—Ç–∏ –∞—Ä–µ–Ω—É';
    ctx.fillText(t, 14, h-14);
    ctx.restore();
  }

  // ---------- Loop ----------
  let last = performance.now();
  function loop(now){
    const dt = clamp((now - last)/1000, 0, 0.033);
    last = now;

    if(!paused){
      // cooldowns + skill timers
      player.atkCd = Math.max(0, player.atkCd - dt);
      player.dashCd = Math.max(0, player.dashCd - dt);
      player.shieldCd = Math.max(0, player.shieldCd - dt);

      if(player.shieldTime > 0){
        player.shieldTime -= dt;
        if(player.shieldTime <= 0){
          player.shieldTime = 0;
          // when shield ends, keep remaining shield but it will be only value, not regen
          // (simple)
        }
      }

      // player movement
      const spd = player.baseSpeed;
      const ix = stickVec.x;
      const iy = stickVec.y;
      const mag = Math.hypot(ix,iy);
      const nx = mag ? ix/mag : 0;
      const ny = mag ? iy/mag : 0;

      // dash overrides normal for short time
      if(player.dashTime > 0){
        player.dashTime -= dt;
        player.vx = player.dashVx;
        player.vy = player.dashVy;
      }else{
        player.vx += nx * spd * dt * 7.0;
        player.vy += ny * spd * dt * 7.0;
        player.vx *= Math.pow(0.0008, dt);
        player.vy *= Math.pow(0.0008, dt);
      }

      player.x += player.vx * dt;
      player.y += player.vy * dt;

      const pad = world.arenaPad;
      player.x = clamp(player.x, pad, world.w()-pad);
      player.y = clamp(player.y, pad+60, world.h()-pad);

      // attack
      if(attackHeld) doAttack();

      // trail spawn
      if((S.cosmetics.trail !== 'none') && (Math.abs(player.vx)+Math.abs(player.vy) > 40)){
        if(Math.random() < 0.35) spawnTrail();
      }

      // enemies update
      for(const e of enemies) enemyUpdate(e, dt);

      // dead enemies + rewards
      for(let i=enemies.length-1;i>=0;i--){
        const e = enemies[i];
        if(e.hp <= 0){
          enemies.splice(i,1);
          const baseXp = e.kind==='boss' ? 120 : 18;
          const coins = e.kind==='boss' ? 140 : (10 + Math.floor(S.level*0.35));
          addXp(baseXp + Math.floor(S.level*6));
          addCoins(coins);
        }
      }

      // wave/level complete logic
      if(enemies.length === 0){
        if(isBossLevel(S.level)){
          // boss beaten -> keys reward
          let k = 1;
          if(Math.random() < 0.18) k = 2; // lucky
          addKeys(k);
          lootText.textContent = `–ë–û–°–° –ø–æ–≤–µ—Ä–∂–µ–Ω: üîë +${k} (–∑–∞–π–¥–∏ –≤ —Å—É–Ω–¥—É–∫–∏ üéÅ)`;

          // next level
          S.level += 1;
          S.sp += 1;
          player.hp = clamp(player.hp + player.maxHp*0.45, 0, player.maxHp);
          startLevel(S.level);
          save();
        }else{
          wave += 1;
          if(wave <= 3){
            enemiesToSpawn = 3 + Math.floor(S.level*0.6);
            spawnWave();
          }else{
            addXp(70 + Math.floor(S.level*18));
            addCoins(60 + Math.floor(S.level*10));
            S.level += 1;
            S.sp += 1;
            startLevel(S.level);
            save();
          }
        }
      }

      // particles update
      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.t += dt;
        p.x += p.vx*dt;
        p.y += p.vy*dt;
        p.vy += 520*dt;
        if(p.t >= p.life) particles.splice(i,1);
      }

      // trails update
      for(let i=trails.length-1;i>=0;i--){
        const t = trails[i];
        t.t += dt;
        if(t.t >= t.life) trails.splice(i,1);
      }

      player.hitFlash = Math.max(0, player.hitFlash - dt);

      updateUI();
    }

    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // initial UI state
  updateUI();
  setAdminUI();

  // prevent scroll
  document.addEventListener('touchmove', (e)=>{ if(e.target.closest('.stickWrap') || e.target.closest('.rightButtons')) e.preventDefault(); }, {passive:false});

})();
</script>
</body>
</html>
