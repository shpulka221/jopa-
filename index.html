<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>LEVEL RUSH ‚Äî Mobile RPG</title>
  <style>
    :root{
      --bg1:#0b0d14; --bg2:#111427;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --good: #7CFFB2;
      --warn: #FFD56A;
      --bad:  #FF6B8B;
      --acc:  #7AA7FF;
      --acc2: #B47CFF;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ margin:0; height:100%; background: radial-gradient(1200px 700px at 30% 20%, #1a1f3a 0%, var(--bg1) 40%, #07080d 100%); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    body{ overflow:hidden; }

    /* Canvas */
    #game{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      display:block;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    }

    /* Top HUD */
    .hud{
      position:fixed; left:12px; right:12px; top:10px;
      display:flex; gap:10px; align-items:stretch;
      pointer-events:none;
    }
    .pill{
      pointer-events:auto;
      background: var(--card);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding:10px 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .hud .left{
      flex:1;
      display:flex; flex-direction:column; gap:8px;
      min-width: 0;
    }
    .hud .right{
      display:flex; gap:10px; align-items:stretch;
    }
    .row{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-size:12px; color:var(--muted);
      user-select:none;
    }
    .row strong{ color:var(--text); font-weight:700; }
    .bars{
      display:flex; flex-direction:column; gap:8px;
    }
    .bar{
      height:10px; border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      width:50%;
      background: linear-gradient(90deg, var(--acc), var(--acc2));
      border-radius:999px;
      box-shadow: 0 0 18px rgba(122,167,255,.35);
    }
    .bar.hp > i{
      background: linear-gradient(90deg, var(--good), #2EE59D);
      box-shadow: 0 0 18px rgba(124,255,178,.25);
    }

    .btn{
      pointer-events:auto;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: 16px;
      padding:10px 12px;
      font-weight:700;
      font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn small{ color:var(--muted); font-weight:600; }
    .btn.primary{
      border-color: rgba(122,167,255,.35);
      background: linear-gradient(180deg, rgba(122,167,255,.18), rgba(180,124,255,.10));
    }
    .btn.danger{
      border-color: rgba(255,107,139,.35);
      background: linear-gradient(180deg, rgba(255,107,139,.16), rgba(255,107,139,.06));
    }

    /* Bottom controls */
    .controls{
      position:fixed; left:0; right:0; bottom:0;
      padding: 12px;
      display:flex; justify-content:space-between; align-items:flex-end;
      pointer-events:none;
    }
    .stickWrap{
      width:160px; height:160px;
      pointer-events:auto;
      position:relative;
      touch-action:none;
    }
    .stickBase{
      position:absolute; inset:0;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
    }
    .stickKnob{
      position:absolute; left:50%; top:50%;
      width:64px; height:64px;
      margin:-32px 0 0 -32px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      transform: translate(0,0);
    }

    .rightButtons{
      display:flex; gap:10px; align-items:flex-end;
      pointer-events:auto;
      touch-action:none;
    }
    .bigBtn{
      width:124px; height:124px;
      border-radius: 28px;
      border:1px solid rgba(255,255,255,.14);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.16), rgba(255,255,255,.05));
      backdrop-filter: blur(10px);
      color:var(--text);
      font-weight:900;
      letter-spacing:.6px;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      user-select:none;
      box-shadow: 0 20px 55px rgba(0,0,0,.45);
    }
    .bigBtn:active{ transform: translateY(1px) scale(.99); }
    .bigBtn span{ font-size:12px; color:var(--muted); font-weight:700; letter-spacing:0; margin-top:6px; }

    /* Panels */
    .overlay{
      position:fixed; inset:0;
      display:none;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index:10;
      padding:14px;
    }
    .overlay.show{ display:flex; }
    .panel{
      margin:auto;
      width:min(560px, 100%);
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: rgba(17,20,39,.78);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .panelHeader{
      padding:16px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .panelHeader h2{
      margin:0; font-size:16px; letter-spacing:.2px;
    }
    .panelHeader p{
      margin:2px 0 0; font-size:12px; color:var(--muted);
    }
    .panelBody{ padding:14px 16px 16px; }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .card{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding:12px;
    }
    .card h3{ margin:0 0 6px; font-size:13px; }
    .card p{ margin:0 0 10px; font-size:12px; color:var(--muted); line-height:1.35; }
    .card .row2{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .tag{ font-size:11px; color:rgba(255,255,255,.78); padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.15); }
    .price{ font-weight:900; color:var(--warn); }

    .wideBtns{ display:flex; gap:10px; margin-top:12px; }
    .wideBtns .btn{ flex:1; justify-content:center; padding:12px; border-radius: 18px; }

    .mono{ font-variant-numeric: tabular-nums; }
    .smallnote{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35; }

    /* Start screen */
    #startOverlay .panel{
      background: rgba(10,12,20,.82);
    }
    .title{
      font-size:22px; font-weight:950; letter-spacing:.6px;
      margin:0;
    }
    .subtitle{
      margin:6px 0 0;
      font-size:12px; color:var(--muted); line-height:1.35;
    }
    .hero{
      padding:16px;
      display:flex; flex-direction:column; gap:12px;
    }
    .heroStats{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding:7px 10px;
      font-size:12px;
      color:rgba(255,255,255,.80);
    }

    @media (max-width: 380px){
      .grid{ grid-template-columns:1fr; }
      .stickWrap{ width:145px; height:145px; }
      .bigBtn{ width:112px; height:112px; border-radius: 26px; }
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>

  <!-- HUD -->
  <div class="hud">
    <div class="pill left">
      <div class="row">
        <div>–£—Ä–æ–≤–µ–Ω—å: <strong class="mono" id="uiLevel">1</strong> <span id="uiStage" style="margin-left:8px; color:rgba(255,255,255,.65)"></span></div>
        <div>üí∞ <strong class="mono" id="uiCoins">0</strong></div>
      </div>
      <div class="bars">
        <div class="bar hp"><i id="uiHpBar"></i></div>
        <div class="bar"><i id="uiXpBar"></i></div>
      </div>
      <div class="row">
        <div>HP: <strong class="mono" id="uiHpText">0/0</strong></div>
        <div>XP: <strong class="mono" id="uiXpText">0/0</strong></div>
      </div>
    </div>

    <div class="pill right">
      <button class="btn primary" id="btnShop">üõçÔ∏è <span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
      <button class="btn" id="btnUpgrades">‚öôÔ∏è <span>–ü—Ä–æ–∫–∞—á–∫–∞</span></button>
      <button class="btn danger" id="btnMenu">‚ò∞ <span>–ú–µ–Ω—é</span></button>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="stickWrap" id="stick">
      <div class="stickBase"></div>
      <div class="stickKnob" id="knob"></div>
    </div>

    <div class="rightButtons">
      <div class="bigBtn" id="btnAttack">
        –ê–¢–ê–ö–ê
        <span id="attackHint">–¥–µ—Ä–∂–∏/–∂–º–∏</span>
      </div>
    </div>
  </div>

  <!-- Start -->
  <div class="overlay show" id="startOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2 class="title">LEVEL RUSH</h2>
          <p class="subtitle">–ú–æ–±–∏–ª–∫–∞ ‚Ä¢ HTML ‚Ä¢ —É—Ä–æ–≤–Ω–∏ ‚Ä¢ –±–æ—Å—Å—ã ‚Ä¢ –ø—Ä–æ–∫–∞—á–∫–∞ ‚Ä¢ –∫–æ—Å–º–µ—Ç–∏–∫–∞</p>
        </div>
        <button class="btn" id="btnResetSave">üß® –°–±—Ä–æ—Å</button>
      </div>
      <div class="hero">
        <div class="card">
          <h3>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h3>
          <p>–ü—Ä–æ—Ö–æ–¥–∏—à—å —É—Ä–æ–≤–Ω–∏, —Ñ–∞—Ä–º–∏—à—å XP –∏ –º–æ–Ω–µ—Ç—ã, –∫–∞—á–∞–µ—à—å —Å—Ç–∞—Ç—ã. –ö–∞–∂–¥—ã–µ <b>5 —É—Ä–æ–≤–Ω–µ–π</b> ‚Äî –±–æ—Å—Å. –ú–∞–≥–∞–∑–∏–Ω –¥–∞—ë—Ç –∫–æ—Å–º–µ—Ç–∏–∫—É (—Å–∫–∏–Ω –∏ —Ç—Ä–µ–π–ª).</p>
          <div class="heroStats">
            <div class="chip">üéÆ –î–∂–æ–π—Å—Ç–∏–∫ —Å–ª–µ–≤–∞</div>
            <div class="chip">üëä –ê—Ç–∞–∫–∞ —Å–ø—Ä–∞–≤–∞</div>
            <div class="chip">üíæ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</div>
          </div>
        </div>
        <div class="wideBtns">
          <button class="btn primary" id="btnPlay">‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å</button>
          <button class="btn" id="btnHow">‚ùî –ü–æ–º–æ—â—å</button>
        </div>
        <div class="smallnote">
          –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äú–∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ‚Äù: –≤ Safari –Ω–∞–∂–º–∏ <b>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí –ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- Menu -->
  <div class="overlay" id="menuOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–ú–µ–Ω—é</h2>
          <p class="subtitle">–ø–∞—É–∑–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</p>
        </div>
        <button class="btn" data-close="menuOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="grid">
          <div class="card">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <p>–î–∂–æ–π—Å—Ç–∏–∫ ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ. –ê—Ç–∞–∫–∞ ‚Äî —É–¥–∞—Ä –ø–æ –±–ª–∏–∂–∞–π—à–µ–º—É –≤—Ä–∞–≥—É. –î–µ—Ä–∂–∏ –∞—Ç–∞–∫—É ‚Äî –±—É–¥–µ—Ç —Å–µ—Ä–∏—è.</p>
            <div class="row2">
              <span class="tag">–ú–æ–±–∏–ª–∫–∞</span>
              <span class="tag">Canvas</span>
            </div>
          </div>
          <div class="card">
            <h3>–°–ª–æ–∂–Ω–æ—Å—Ç—å</h3>
            <p>–° –∫–∞–∂–¥—ã–º —É—Ä–æ–≤–Ω–µ–º –≤—Ä–∞–≥–∏ —Ç–æ–ª—â–µ. –ë–æ—Å—Å—ã –æ—Å–æ–±–µ–Ω–Ω–æ –∑–ª—ã–µ ‚Äî –¥–µ—Ä–∂–∏ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –∏ –±–µ–π —Å–µ—Ä–∏—è–º–∏.</p>
            <div class="row2">
              <span class="tag">–£—Ä–æ–≤–Ω–∏</span>
              <span class="tag">–ë–æ—Å—Å—ã</span>
            </div>
          </div>
        </div>
        <div class="wideBtns">
          <button class="btn primary" id="btnResume">‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          <button class="btn danger" id="btnRestart">üîÑ –ù–æ–≤—ã–π –∑–∞–±–µ–≥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upgrades -->
  <div class="overlay" id="upOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–ü—Ä–æ–∫–∞—á–∫–∞</h2>
          <p class="subtitle">—Ç—Ä–∞—Ç—å –æ—á–∫–∏ –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è</p>
        </div>
        <button class="btn" data-close="upOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="card">
          <div class="row2">
            <div>–û—á–∫–∏ –ø—Ä–æ–∫–∞—á–∫–∏: <strong class="mono" id="uiSP">0</strong></div>
            <div class="tag">+1 –∑–∞ —É—Ä–æ–≤–µ–Ω—å</div>
          </div>
        </div>
        <div class="grid" style="margin-top:10px;">
          <div class="card">
            <h3>–£—Ä–æ–Ω</h3>
            <p>–ë–æ–ª—å—à–µ —É—Ä–æ–Ω–∞ –ø–æ –≤—Ä–∞–≥–∞–º –∏ –±–æ—Å—Å–∞–º.</p>
            <div class="row2">
              <span class="tag">DMG: <b class="mono" id="uiDmg">0</b></span>
              <button class="btn primary" id="upDmg">+1</button>
            </div>
          </div>
          <div class="card">
            <h3>–ó–¥–æ—Ä–æ–≤—å–µ</h3>
            <p>–ë–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ HP.</p>
            <div class="row2">
              <span class="tag">HP+: <b class="mono" id="uiVit">0</b></span>
              <button class="btn primary" id="upVit">+1</button>
            </div>
          </div>
          <div class="card">
            <h3>–°–∫–æ—Ä–æ—Å—Ç—å</h3>
            <p>–ë—ã—Å—Ç—Ä–µ–µ –±–µ–≥–∞–µ—à—å ‚Äî –ª–µ–≥—á–µ –∫–∞–π—Ç–∏—à—å –±–æ—Å—Å–∞.</p>
            <div class="row2">
              <span class="tag">SPD: <b class="mono" id="uiSpd">0</b></span>
              <button class="btn primary" id="upSpd">+1</button>
            </div>
          </div>
          <div class="card">
            <h3>–ö—Ä–∏—Ç</h3>
            <p>–®–∞–Ω—Å –Ω–∞–Ω–µ—Å—Ç–∏ —É—Å–∏–ª–µ–Ω–Ω—ã–π —É–¥–∞—Ä.</p>
            <div class="row2">
              <span class="tag">CRT: <b class="mono" id="uiCrt">0</b></span>
              <button class="btn primary" id="upCrt">+1</button>
            </div>
          </div>
        </div>
        <div class="smallnote">–°—Ç–∞—Ç—ã –≤–ª–∏—è—é—Ç —á–µ—Å—Ç–Ω–æ: —É—Ä–æ–Ω/—Ö–ø/—Å–∫–æ—Ä–æ—Å—Ç—å/–∫—Ä–∏—Ç. –ù–∏–∫–∞–∫–æ–π –º–∞–≥–∏–∏, —Ç–æ–ª—å–∫–æ –º—è—Å–æ üòà</div>
      </div>
    </div>
  </div>

  <!-- Shop -->
  <div class="overlay" id="shopOverlay">
    <div class="panel">
      <div class="panelHeader">
        <div>
          <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
          <p class="subtitle">–∫–æ—Å–º–µ—Ç–∏–∫–∞: —Å–∫–∏–Ω—ã –∏ —Ç—Ä–µ–π–ª—ã (–Ω–∞ —Å–∏–ª—É –Ω–µ –≤–ª–∏—è–µ—Ç)</p>
        </div>
        <button class="btn" data-close="shopOverlay">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="card">
          <div class="row2">
            <div>–ë–∞–ª–∞–Ω—Å: üí∞ <strong class="mono" id="uiShopCoins">0</strong></div>
            <div class="tag">Cosmetics only</div>
          </div>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="card">
            <h3>–°–∫–∏–Ω ‚Äú–õ—ë–¥‚Äù</h3>
            <p>–•–æ–ª–æ–¥–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.</p>
            <div class="row2">
              <span class="price">250</span>
              <button class="btn primary" id="buySkinIce">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–°–∫–∏–Ω ‚Äú–ù–µ–æ–Ω‚Äù</h3>
            <p>–Ø—Ä–∫–∏–π –Ω–µ–æ–Ω, –≤–∏–¥–Ω–æ –∏–∑–¥–∞–ª–µ–∫–∞.</p>
            <div class="row2">
              <span class="price">400</span>
              <button class="btn primary" id="buySkinNeon">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–¢—Ä–µ–π–ª ‚Äú–ò—Å–∫—Ä—ã‚Äù</h3>
            <p>–°–ª–µ–¥ –∑–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º (–∫—Ä–∞—Å–∏–≤–æ).</p>
            <div class="row2">
              <span class="price">300</span>
              <button class="btn primary" id="buyTrailSparks">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <h3>–¢—Ä–µ–π–ª ‚Äú–î—ã–º‚Äù</h3>
            <p>–ú—è–≥–∫–∏–π –¥—ã–º–Ω—ã–π —Å–ª–µ–¥.</p>
            <div class="row2">
              <span class="price">300</span>
              <button class="btn primary" id="buyTrailSmoke">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <h3>–í—ã–±—Ä–∞–Ω–æ</h3>
          <p>–¢–µ–∫—É—â–∏–π —Å–∫–∏–Ω/—Ç—Ä–µ–π–ª –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –µ—Å–ª–∏ –∫—É–ø–ª–µ–Ω–æ.</p>
          <div class="row2">
            <span class="tag">–°–∫–∏–Ω: <b class="mono" id="uiSkin">default</b></span>
            <span class="tag">–¢—Ä–µ–π–ª: <b class="mono" id="uiTrail">none</b></span>
          </div>
          <div class="wideBtns">
            <button class="btn" id="equipDefault">–°–∫–∏–Ω default</button>
            <button class="btn" id="equipNoneTrail">–¢—Ä–µ–π–ª none</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- Utilities ----------
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const rnd = (a,b) => a + Math.random()*(b-a);
  const dist = (ax,ay,bx,by) => Math.hypot(ax-bx, ay-by);

  // ---------- Canvas ----------
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', { alpha: false });

  function resize(){
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    canvas.width  = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor(innerHeight * dpr);
    canvas.style.width = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize);
  resize();

  // ---------- Save / Load ----------
  const SAVE_KEY = 'level_rush_save_v1';

  const defaultSave = () => ({
    coins: 0,
    level: 1,
    xp: 0,
    sp: 0, // skill points
    stats: { dmg: 0, vit: 0, spd: 0, crt: 0 },
    cosmetics: {
      ownedSkins: { default: true },
      ownedTrails: { none: true },
      skin: 'default',
      trail: 'none'
    }
  });

  function loadSave(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return defaultSave();
      const s = JSON.parse(raw);
      // merge to be safe
      const d = defaultSave();
      return {
        ...d,
        ...s,
        stats: { ...d.stats, ...(s.stats||{}) },
        cosmetics: {
          ...d.cosmetics,
          ...(s.cosmetics||{}),
          ownedSkins: { ...d.cosmetics.ownedSkins, ...((s.cosmetics||{}).ownedSkins||{}) },
          ownedTrails:{ ...d.cosmetics.ownedTrails,...((s.cosmetics||{}).ownedTrails||{}) }
        }
      };
    }catch(e){
      return defaultSave();
    }
  }
  function save(){
    localStorage.setItem(SAVE_KEY, JSON.stringify(S));
  }

  let S = loadSave();

  // ---------- UI refs ----------
  const $ = (id) => document.getElementById(id);

  const uiLevel = $('uiLevel');
  const uiCoins = $('uiCoins');
  const uiHpBar = $('uiHpBar');
  const uiXpBar = $('uiXpBar');
  const uiHpText = $('uiHpText');
  const uiXpText = $('uiXpText');
  const uiStage = $('uiStage');

  const btnShop = $('btnShop');
  const btnUpgrades = $('btnUpgrades');
  const btnMenu = $('btnMenu');

  const startOverlay = $('startOverlay');
  const menuOverlay = $('menuOverlay');
  const upOverlay = $('upOverlay');
  const shopOverlay = $('shopOverlay');

  const btnPlay = $('btnPlay');
  const btnHow = $('btnHow');
  const btnResetSave = $('btnResetSave');
  const btnResume = $('btnResume');
  const btnRestart = $('btnRestart');

  const uiSP = $('uiSP');
  const uiDmg = $('uiDmg');
  const uiVit = $('uiVit');
  const uiSpd = $('uiSpd');
  const uiCrt = $('uiCrt');
  const upDmg = $('upDmg');
  const upVit = $('upVit');
  const upSpd = $('upSpd');
  const upCrt = $('upCrt');

  const uiShopCoins = $('uiShopCoins');
  const uiSkin = $('uiSkin');
  const uiTrail = $('uiTrail');
  const buySkinIce = $('buySkinIce');
  const buySkinNeon = $('buySkinNeon');
  const buyTrailSparks = $('buyTrailSparks');
  const buyTrailSmoke = $('buyTrailSmoke');
  const equipDefault = $('equipDefault');
  const equipNoneTrail = $('equipNoneTrail');

  // close buttons
  document.querySelectorAll('[data-close]').forEach(b=>{
    b.addEventListener('click', () => hideOverlay(b.getAttribute('data-close')));
  });

  function showOverlay(el){
    el.classList.add('show');
    paused = true;
    updateUI();
  }
  function hideOverlay(id){
    const el = typeof id === 'string' ? $(id) : id;
    el.classList.remove('show');
    if(!startOverlay.classList.contains('show')) paused = false;
    updateUI();
    save();
  }

  // ---------- Game state ----------
  let paused = true;
  let gameOver = false;

  const world = {
    w: () => innerWidth,
    h: () => innerHeight,
    arenaPad: 42,
  };

  // cosmetics colors
  function skinColor(name){
    if(name === 'ice')  return '#7AA7FF';
    if(name === 'neon') return '#B47CFF';
    return '#FFFFFF';
  }

  // Player
  const player = {
    x: innerWidth*0.5, y: innerHeight*0.62,
    r: 14,
    vx: 0, vy: 0,
    maxHp: 100,
    hp: 100,
    baseSpeed: 190,
    atkCd: 0,
    hitFlash: 0,
  };

  // progression helpers
  function xpNeedForLevel(lv){
    // —Ä–æ—Å—Ç –ø–ª–∞–≤–Ω—ã–π, –Ω–æ –æ—â—É—Ç–∏–º—ã–π
    return Math.floor(60 + lv*25 + Math.pow(lv, 1.25)*6);
  }

  function applyStats(){
    const st = S.stats;
    player.maxHp = 100 + st.vit * 22;
    player.baseSpeed = 190 + st.spd * 14;
    if(player.hp > player.maxHp) player.hp = player.maxHp;
  }
  applyStats();

  // Enemies
  const enemies = [];
  const particles = [];
  const trails = [];

  let wave = 1;          // –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–æ–ª–Ω–∞ –≤ —É—Ä–æ–≤–Ω–µ
  let enemiesToSpawn = 3;
  let bossActive = false;

  function isBossLevel(lv){ return lv % 5 === 0; }

  function stageName(lv){
    if(isBossLevel(lv)) return '‚Äî –ë–û–°–°';
    return '‚Äî –í–æ–ª–Ω–∞ ' + wave;
  }

  function spawnEnemy(kind='mob'){
    const pad = world.arenaPad;
    const x = Math.random() < 0.5 ? rnd(pad, world.w()-pad) : (Math.random()<0.5 ? pad : world.w()-pad);
    const y = Math.random() < 0.5 ? rnd(pad+80, world.h()-pad) : (Math.random()<0.5 ? pad+80 : world.h()-pad);

    const baseLv = S.level;

    let hp = 40 + baseLv*9;
    let spd = 95 + baseLv*2.5;
    let dmg = 10 + baseLv*1.2;
    let r = 12;

    if(kind==='brute'){
      hp *= 1.6; spd *= 0.82; dmg *= 1.25; r = 15;
    }
    if(kind==='runner'){
      hp *= 0.85; spd *= 1.35; dmg *= 0.9; r = 11;
    }
    if(kind==='boss'){
      hp = 260 + baseLv*55;
      spd = 110 + baseLv*1.8;
      dmg = 18 + baseLv*2.0;
      r = 26;
    }

    enemies.push({
      x,y,r,
      vx:0, vy:0,
      hp, maxHp: hp,
      spd,
      dmg,
      kind,
      hitFlash: 0,
      atkCd: rnd(0.4, 1.2)
    });
  }

  function startLevel(lv){
    applyStats();
    gameOver = false;
    wave = 1;
    bossActive = false;

    enemies.length = 0;
    particles.length = 0;
    trails.length = 0;

    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —É—Ä–æ–≤–µ–Ω—å (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –¥—É—à–Ω–æ)
    player.hp = player.maxHp;

    if(isBossLevel(lv)){
      bossActive = true;
      spawnEnemy('boss');
    }else{
      enemiesToSpawn = 3 + Math.floor(lv*0.6);
      spawnWave();
    }
  }

  function spawnWave(){
    enemies.length = 0;
    const lv = S.level;
    const count = enemiesToSpawn + Math.floor(wave*0.6);
    for(let i=0;i<count;i++){
      const t = Math.random();
      if(t < 0.15) spawnEnemy('runner');
      else if(t < 0.35) spawnEnemy('brute');
      else spawnEnemy('mob');
    }
  }

  function addCoins(n){
    S.coins += n;
  }
  function addXp(n){
    S.xp += n;
    while(S.xp >= xpNeedForLevel(S.level)){
      S.xp -= xpNeedForLevel(S.level);
      S.level += 1;
      S.sp += 1;
      // –Ω–µ–±–æ–ª—å—à–æ–π –±–æ–Ω—É—Å ‚Äî –ø–æ–¥—Ö–∏–ª –ø—Ä–∏ –∞–ø–µ
      player.hp = clamp(player.hp + player.maxHp*0.35, 0, player.maxHp);
    }
  }

  // ---------- Touch joystick ----------
  const stick = $('stick');
  const knob = $('knob');
  let stickActive = false;
  let stickId = null;
  let stickCenter = {x:0,y:0};
  let stickVec = {x:0,y:0}; // normalized -1..1

  function updateStickVisual(dx,dy){
    const max = 48;
    const lx = clamp(dx, -max, max);
    const ly = clamp(dy, -max, max);
    knob.style.transform = `translate(${lx}px, ${ly}px)`;
  }

  function onStickStart(e){
    e.preventDefault();
    const t = e.changedTouches ? e.changedTouches[0] : e;
    stickActive = true;
    stickId = t.identifier ?? 'mouse';
    const rect = stick.getBoundingClientRect();
    stickCenter.x = rect.left + rect.width/2;
    stickCenter.y = rect.top + rect.height/2;
    stickVec.x = 0; stickVec.y = 0;
    updateStickVisual(0,0);
  }
  function onStickMove(e){
    if(!stickActive) return;
    const touches = e.changedTouches ? [...e.changedTouches] : [e];
    const t = touches.find(tt => (tt.identifier ?? 'mouse') === stickId);
    if(!t) return;
    const dx = (t.clientX - stickCenter.x);
    const dy = (t.clientY - stickCenter.y);
    const mag = Math.hypot(dx,dy);
    const max = 52;
    const nx = mag ? dx / Math.max(max, mag) : 0;
    const ny = mag ? dy / Math.max(max, mag) : 0;
    stickVec.x = clamp(dx / max, -1, 1);
    stickVec.y = clamp(dy / max, -1, 1);
    updateStickVisual(dx,dy);
  }
  function onStickEnd(e){
    if(!stickActive) return;
    const touches = e.changedTouches ? [...e.changedTouches] : [e];
    const t = touches.find(tt => (tt.identifier ?? 'mouse') === stickId);
    if(!t) return;
    stickActive = false;
    stickId = null;
    stickVec.x = 0; stickVec.y = 0;
    updateStickVisual(0,0);
  }

  stick.addEventListener('touchstart', onStickStart, {passive:false});
  stick.addEventListener('touchmove', onStickMove, {passive:false});
  stick.addEventListener('touchend', onStickEnd, {passive:false});
  stick.addEventListener('touchcancel', onStickEnd, {passive:false});
  // desktop fallback
  stick.addEventListener('mousedown', onStickStart);
  window.addEventListener('mousemove', onStickMove);
  window.addEventListener('mouseup', onStickEnd);

  // ---------- Attack button ----------
  const btnAttack = $('btnAttack');
  let attackHeld = false;

  function setAttackHeld(v){ attackHeld = v; }
  btnAttack.addEventListener('touchstart', (e)=>{ e.preventDefault(); setAttackHeld(true); }, {passive:false});
  btnAttack.addEventListener('touchend',   (e)=>{ e.preventDefault(); setAttackHeld(false); }, {passive:false});
  btnAttack.addEventListener('touchcancel',(e)=>{ e.preventDefault(); setAttackHeld(false); }, {passive:false});
  btnAttack.addEventListener('mousedown', ()=>setAttackHeld(true));
  window.addEventListener('mouseup', ()=>setAttackHeld(false));

  // ---------- Buttons ----------
  btnPlay.addEventListener('click', ()=>{
    startOverlay.classList.remove('show');
    paused = false;
    startLevel(S.level);
    updateUI();
    save();
  });

  btnHow.addEventListener('click', ()=>{
    alert("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:\n‚Äî –î–∂–æ–π—Å—Ç–∏–∫ —Å–ª–µ–≤–∞: –¥–≤–∏–∂–µ–Ω–∏–µ\n‚Äî –ê—Ç–∞–∫–∞ —Å–ø—Ä–∞–≤–∞: —É–¥–∞—Ä –ø–æ –±–ª–∏–∂–∞–π—à–µ–º—É –≤—Ä–∞–≥—É\n\n–ü—Ä–æ–∫–∞—á–∫–∞:\n‚Äî –ó–∞ —É—Ä–æ–≤–µ–Ω—å –¥–∞—ë—Ç—Å—è 1 –æ—á–∫–æ\n‚Äî –£—Ä–æ–Ω/HP/–°–∫–æ—Ä–æ—Å—Ç—å/–ö—Ä–∏—Ç\n\n–ë–æ—Å—Å—ã:\n‚Äî –ö–∞–∂–¥—ã–µ 5 —É—Ä–æ–≤–Ω–µ–π\n\n–ö–æ—Å–º–µ—Ç–∏–∫–∞:\n‚Äî –í –º–∞–≥–∞–∑–∏–Ω–µ, –Ω–∞ —Å–∏–ª—É –Ω–µ –≤–ª–∏—è–µ—Ç");
  });

  btnShop.addEventListener('click', ()=> showOverlay(shopOverlay));
  btnUpgrades.addEventListener('click', ()=> showOverlay(upOverlay));
  btnMenu.addEventListener('click', ()=> showOverlay(menuOverlay));
  btnResume.addEventListener('click', ()=> hideOverlay('menuOverlay'));

  btnRestart.addEventListener('click', ()=>{
    // –Ω–æ–≤—ã–π –∑–∞–±–µ–≥ = –Ω–∞—á–∞—Ç—å —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∑–∞–Ω–æ–≤–æ, –Ω–µ —É–¥–∞–ª—è—è –ø—Ä–æ–≥—Ä–µ—Å—Å
    hideOverlay('menuOverlay');
    startLevel(S.level);
    save();
  });

  btnResetSave.addEventListener('click', ()=>{
    const ok = confirm("–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å? –≠—Ç–æ –ø—Ä—è–º –≤—Å—ë-–≤—Å—ë —É–¥–∞–ª–∏—Ç.");
    if(!ok) return;
    localStorage.removeItem(SAVE_KEY);
    S = loadSave();
    applyStats();
    updateUI();
    startLevel(S.level);
  });

  // upgrades
  function trySpendSP(){
    if(S.sp <= 0) return false;
    S.sp -= 1;
    return true;
  }
  upDmg.addEventListener('click', ()=>{
    if(!trySpendSP()) return;
    S.stats.dmg += 1;
    updateUI(); save();
  });
  upVit.addEventListener('click', ()=>{
    if(!trySpendSP()) return;
    S.stats.vit += 1;
    applyStats();
    updateUI(); save();
  });
  upSpd.addEventListener('click', ()=>{
    if(!trySpendSP()) return;
    S.stats.spd += 1;
    applyStats();
    updateUI(); save();
  });
  upCrt.addEventListener('click', ()=>{
    if(!trySpendSP()) return;
    S.stats.crt += 1;
    updateUI(); save();
  });

  // shop helpers
  function canAfford(cost){ return S.coins >= cost; }
  function buy(cost){
    if(!canAfford(cost)) return false;
    S.coins -= cost;
    return true;
  }
  function ownSkin(k){ return !!S.cosmetics.ownedSkins[k]; }
  function ownTrail(k){ return !!S.cosmetics.ownedTrails[k]; }

  function equipSkin(k){
    if(!ownSkin(k)) return;
    S.cosmetics.skin = k;
    updateUI(); save();
  }
  function equipTrail(k){
    if(!ownTrail(k)) return;
    S.cosmetics.trail = k;
    updateUI(); save();
  }

  buySkinIce.addEventListener('click', ()=>{
    if(ownSkin('ice')) return equipSkin('ice');
    if(!buy(250)) return;
    S.cosmetics.ownedSkins.ice = true;
    equipSkin('ice');
  });
  buySkinNeon.addEventListener('click', ()=>{
    if(ownSkin('neon')) return equipSkin('neon');
    if(!buy(400)) return;
    S.cosmetics.ownedSkins.neon = true;
    equipSkin('neon');
  });
  buyTrailSparks.addEventListener('click', ()=>{
    if(ownTrail('sparks')) return equipTrail('sparks');
    if(!buy(300)) return;
    S.cosmetics.ownedTrails.sparks = true;
    equipTrail('sparks');
  });
  buyTrailSmoke.addEventListener('click', ()=>{
    if(ownTrail('smoke')) return equipTrail('smoke');
    if(!buy(300)) return;
    S.cosmetics.ownedTrails.smoke = true;
    equipTrail('smoke');
  });

  equipDefault.addEventListener('click', ()=> equipSkin('default'));
  equipNoneTrail.addEventListener('click', ()=> equipTrail('none'));

  // ---------- Combat ----------
  function damageForPlayer(){
    const st = S.stats;
    const base = 18 + st.dmg*6;
    // crit chance: 3% + crt*2.5%
    const critChance = 0.03 + st.crt*0.025;
    const crit = Math.random() < critChance;
    return { dmg: crit ? base*1.9 : base, crit };
  }

  function nearestEnemy(){
    if(enemies.length===0) return null;
    let best = null, bestD = 1e9;
    for(const e of enemies){
      const d = dist(player.x,player.y,e.x,e.y);
      if(d < bestD){
        bestD = d; best = e;
      }
    }
    return best;
  }

  function doAttack(){
    if(player.atkCd > 0) return;
    const e = nearestEnemy();
    if(!e) return;
    const d = dist(player.x,player.y,e.x,e.y);
    if(d > player.r + e.r + 24) return; // range
    player.atkCd = 0.22; // attack speed base
    const {dmg, crit} = damageForPlayer();
    e.hp -= dmg;
    e.hitFlash = 0.12;
    spawnHit(e.x, e.y, crit);
    // little knockback
    const nx = (e.x - player.x) / (d || 1);
    const ny = (e.y - player.y) / (d || 1);
    e.vx += nx*120;
    e.vy += ny*120;
  }

  function spawnHit(x,y,crit){
    for(let i=0;i<10;i++){
      particles.push({
        x, y,
        vx: rnd(-180,180),
        vy: rnd(-220,80),
        life: rnd(0.25,0.45),
        t: 0,
        r: rnd(1.5,3.5),
        crit
      });
    }
  }

  function spawnTrail(){
    const t = S.cosmetics.trail;
    if(t === 'none') return;
    trails.push({
      x: player.x,
      y: player.y,
      r: player.r * (t==='smoke' ? 1.05 : 0.85),
      life: t==='smoke' ? 0.55 : 0.35,
      t: 0,
      kind: t
    });
  }

  // ---------- Enemy AI ----------
  function enemyUpdate(e, dt){
    // move toward player
    const dx = player.x - e.x;
    const dy = player.y - e.y;
    const d = Math.hypot(dx,dy) || 1;

    // steer
    const ax = (dx/d) * e.spd;
    const ay = (dy/d) * e.spd;
    e.vx += ax * dt;
    e.vy += ay * dt;

    // friction
    e.vx *= Math.pow(0.0006, dt);
    e.vy *= Math.pow(0.0006, dt);

    // integrate
    e.x += e.vx * dt;
    e.y += e.vy * dt;

    // bounds
    const pad = world.arenaPad;
    e.x = clamp(e.x, pad, world.w()-pad);
    e.y = clamp(e.y, pad+60, world.h()-pad);

    // attack player if close
    e.atkCd -= dt;
    const range = e.r + player.r + (e.kind==='boss' ? 18 : 10);
    if(e.atkCd <= 0 && d < range){
      e.atkCd = e.kind==='boss' ? 0.55 : 0.75;
      player.hp -= e.dmg;
      player.hitFlash = 0.12;
      // knockback player
      const nx = (player.x - e.x)/(d||1);
      const ny = (player.y - e.y)/(d||1);
      player.vx += nx*220;
      player.vy += ny*220;
      // hit particles on player
      spawnHit(player.x, player.y, false);
      if(player.hp <= 0){
        player.hp = 0;
        gameOver = true;
        paused = true;
        setTimeout(()=>{
          alert("–ù–£ –¢–´ –ò –õ–û–• üòà\n(—à—É—Ç–∫–∞)\n\n–¢—ã —É–º–µ—Ä(–ª–∞). –ù–∞–∂–º–∏ –û–ö ‚Äî –Ω–∞—á–Ω—ë—à—å —É—Ä–æ–≤–µ–Ω—å –∑–∞–Ω–æ–≤–æ.");
          player.hp = player.maxHp;
          gameOver = false;
          paused = false;
          startLevel(S.level);
          updateUI();
          save();
        }, 50);
      }
    }

    // flash decay
    e.hitFlash = Math.max(0, e.hitFlash - dt);
  }

  // ---------- UI update ----------
  function updateUI(){
    uiLevel.textContent = S.level;
    uiCoins.textContent = S.coins;

    uiShopCoins.textContent = S.coins;
    uiSP.textContent = S.sp;

    uiDmg.textContent = S.stats.dmg;
    uiVit.textContent = S.stats.vit;
    uiSpd.textContent = S.stats.spd;
    uiCrt.textContent = S.stats.crt;

    uiSkin.textContent = S.cosmetics.skin;
    uiTrail.textContent = S.cosmetics.trail;

    // hp/xp
    uiHpText.textContent = `${Math.ceil(player.hp)}/${player.maxHp}`;
    const hn = player.maxHp ? player.hp/player.maxHp : 0;
    uiHpBar.style.width = `${clamp(hn*100,0,100)}%`;

    const need = xpNeedForLevel(S.level);
    uiXpText.textContent = `${S.xp}/${need}`;
    uiXpBar.style.width = `${clamp((S.xp/need)*100,0,100)}%`;

    uiStage.textContent = stageName(S.level);

    // shop button text
    buySkinIce.textContent = ownSkin('ice') ? (S.cosmetics.skin==='ice' ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';
    buySkinNeon.textContent = ownSkin('neon') ? (S.cosmetics.skin==='neon' ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';
    buyTrailSparks.textContent = ownTrail('sparks') ? (S.cosmetics.trail==='sparks' ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';
    buyTrailSmoke.textContent = ownTrail('smoke') ? (S.cosmetics.trail==='smoke' ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';
  }

  // ---------- Drawing ----------
  function drawBg(){
    // subtle grid
    const w = world.w(), h = world.h();
    ctx.fillStyle = '#0a0b12';
    ctx.fillRect(0,0,w,h);

    // glow blobs
    const g = ctx.createRadialGradient(w*0.3,h*0.2,0,w*0.3,h*0.2,520);
    g.addColorStop(0,'rgba(122,167,255,.10)');
    g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle = g; ctx.fillRect(0,0,w,h);

    const g2 = ctx.createRadialGradient(w*0.75,h*0.35,0,w*0.75,h*0.35,580);
    g2.addColorStop(0,'rgba(180,124,255,.10)');
    g2.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle = g2; ctx.fillRect(0,0,w,h);

    // grid
    ctx.globalAlpha = 0.12;
    ctx.strokeStyle = 'rgba(255,255,255,.18)';
    ctx.lineWidth = 1;
    const step = 44;
    ctx.beginPath();
    for(let x=0; x<w; x+=step){ ctx.moveTo(x,0); ctx.lineTo(x,h); }
    for(let y=0; y<h; y+=step){ ctx.moveTo(0,y); ctx.lineTo(w,y); }
    ctx.stroke();
    ctx.globalAlpha = 1;

    // arena border
    const pad = world.arenaPad;
    ctx.strokeStyle = 'rgba(255,255,255,.16)';
    ctx.lineWidth = 2;
    ctx.strokeRect(pad, pad+60, w-pad*2, h-(pad*2+60));
  }

  function drawEntityCircle(x,y,r,color,flash=0){
    ctx.save();
    if(flash>0){
      ctx.shadowColor = 'rgba(255,255,255,.9)';
      ctx.shadowBlur = 18;
    }else{
      ctx.shadowColor = 'rgba(0,0,0,.6)';
      ctx.shadowBlur = 12;
    }
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function drawHpBar(x,y,w,h,ratio,color){
    ctx.save();
    ctx.fillStyle = 'rgba(0,0,0,.35)';
    ctx.strokeStyle = 'rgba(255,255,255,.10)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    roundRect(ctx, x, y, w, h, 999);
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = color;
    ctx.beginPath();
    roundRect(ctx, x, y, w*clamp(ratio,0,1), h, 999);
    ctx.fill();
    ctx.restore();
  }

  function roundRect(c, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    c.moveTo(x+rr,y);
    c.arcTo(x+w,y, x+w,y+h, rr);
    c.arcTo(x+w,y+h, x,y+h, rr);
    c.arcTo(x,y+h, x,y, rr);
    c.arcTo(x,y, x+w,y, rr);
    c.closePath();
  }

  function draw(){
    const w = world.w(), h = world.h();
    drawBg();

    // trails
    for(const t of trails){
      const a = 1 - (t.t / t.life);
      ctx.globalAlpha = a * (t.kind==='smoke' ? 0.18 : 0.30);
      ctx.fillStyle = t.kind==='sparks' ? 'rgba(255,213,106,1)' : 'rgba(255,255,255,1)';
      ctx.beginPath();
      ctx.arc(t.x, t.y, t.r*(0.9 + (t.t/t.life)*0.6), 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // enemies
    for(const e of enemies){
      const isBoss = e.kind==='boss';
      const c = isBoss ? '#FF6B8B' : (e.kind==='runner' ? '#FFD56A' : (e.kind==='brute' ? '#7CFFB2' : '#FFFFFF'));
      drawEntityCircle(e.x,e.y,e.r, c, e.hitFlash);
      // hp bar
      const ratio = e.hp / e.maxHp;
      drawHpBar(e.x - 26, e.y - e.r - 14, 52, 8, ratio, isBoss ? 'rgba(255,107,139,.95)' : 'rgba(255,255,255,.75)');
    }

    // player
    const pc = skinColor(S.cosmetics.skin);
    // outline + inner for style
    drawEntityCircle(player.x,player.y,player.r+3,'rgba(0,0,0,.45)');
    drawEntityCircle(player.x,player.y,player.r, pc, player.hitFlash);

    // particles
    for(const p of particles){
      const a = 1 - (p.t/p.life);
      ctx.globalAlpha = a;
      ctx.fillStyle = p.crit ? 'rgba(255,213,106,1)' : 'rgba(255,255,255,1)';
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // bottom info (small)
    ctx.save();
    ctx.globalAlpha = 0.85;
    ctx.fillStyle = 'rgba(255,255,255,.75)';
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
    const t = isBossLevel(S.level) ? '–ë–û–°–°: –≤—ã–∂–∏–≤–∏ –∏ –∑–∞–±–µ—Ä–∏ –ª—É—Ç' : '–í–û–õ–ù–´: –∑–∞—á–∏—Å—Ç–∏ –∞—Ä–µ–Ω—É';
    ctx.fillText(t, 14, h-14);
    ctx.restore();
  }

  // ---------- Loop ----------
  let last = performance.now();
  function loop(now){
    const dt = clamp((now - last)/1000, 0, 0.033);
    last = now;

    if(!paused){
      // player move
      const st = S.stats;
      const spd = player.baseSpeed;

      // intended direction
      const ix = stickVec.x;
      const iy = stickVec.y;
      const mag = Math.hypot(ix,iy);
      const nx = mag ? ix/mag : 0;
      const ny = mag ? iy/mag : 0;

      player.vx += nx * spd * dt * 7.0;
      player.vy += ny * spd * dt * 7.0;

      // friction
      player.vx *= Math.pow(0.0008, dt);
      player.vy *= Math.pow(0.0008, dt);

      player.x += player.vx * dt;
      player.y += player.vy * dt;

      // bounds
      const pad = world.arenaPad;
      player.x = clamp(player.x, pad, world.w()-pad);
      player.y = clamp(player.y, pad+60, world.h()-pad);

      // attack
      player.atkCd = Math.max(0, player.atkCd - dt);
      if(attackHeld) doAttack();

      // trail
      if((S.cosmetics.trail !== 'none') && (Math.abs(player.vx)+Math.abs(player.vy) > 40)){
        if(Math.random() < 0.35) spawnTrail();
      }

      // enemies update
      for(const e of enemies) enemyUpdate(e, dt);

      // clean dead enemies + rewards
      for(let i=enemies.length-1;i>=0;i--){
        const e = enemies[i];
        if(e.hp <= 0){
          enemies.splice(i,1);
          const base = e.kind==='boss' ? 120 : 18;
          const coins = e.kind==='boss' ? 140 : (10 + Math.floor(S.level*0.35));
          addXp(base + Math.floor(S.level*6));
          addCoins(coins);
        }
      }

      // waves / level complete
      if(enemies.length === 0){
        if(isBossLevel(S.level)){
          // beat boss -> next level
          S.level += 1;
          S.sp += 1;
          player.hp = clamp(player.hp + player.maxHp*0.45, 0, player.maxHp);
          startLevel(S.level);
          save();
        }else{
          wave += 1;
          // —Å–¥–µ–ª–∞–µ–º 3 –≤–æ–ª–Ω—ã –Ω–∞ —É—Ä–æ–≤–µ–Ω—å, –ø–æ—Ç–æ–º –∞–ø —É—Ä–æ–≤–Ω—è
          if(wave <= 3){
            enemiesToSpawn = 3 + Math.floor(S.level*0.6);
            spawnWave();
          }else{
            // end level
            addXp(70 + Math.floor(S.level*18));
            addCoins(60 + Math.floor(S.level*10));
            S.level += 1;
            S.sp += 1;
            startLevel(S.level);
            save();
          }
        }
      }

      // particles update
      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.t += dt;
        p.x += p.vx*dt;
        p.y += p.vy*dt;
        p.vy += 520*dt;
        if(p.t >= p.life) particles.splice(i,1);
      }

      // trails update
      for(let i=trails.length-1;i>=0;i--){
        const t = trails[i];
        t.t += dt;
        if(t.t >= t.life) trails.splice(i,1);
      }

      player.hitFlash = Math.max(0, player.hitFlash - dt);

      // UI
      updateUI();
    }

    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // Start state
  updateUI();

  // Prevent page scroll on touch
  document.addEventListener('touchmove', (e)=>{ if(e.target.closest('.stickWrap') || e.target.closest('#btnAttack')) e.preventDefault(); }, {passive:false});

})();
</script>
</body>
</html>
