<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BLOCK MASTER ‚Äî Classic</title>
  <style>
    :root{
      --bg1:#0b2a7b;
      --bg2:#0a1b4d;

      --panel: rgba(255,255,255,.10);
      --panel2: rgba(255,255,255,.06);

      --gridBorder:#2aa1ff;
      --cellBase: rgba(255,255,255,.06);
      --cellAlt: rgba(255,255,255,.03);

      --cellSkin: #1c2c80; /* –º–µ–Ω—è–µ–º —Å–∫–∏–Ω–æ–º */
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --soft: 0 10px 20px rgba(0,0,0,.25);

      --text:#e9f3ff;
      --muted:rgba(233,243,255,.72);

      --good:#2fe084;
      --good2:#1ecf76;

      --bad:#ff4d73;
      --warn:#ffcc4d;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%; margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    body{
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 50% -10%, #1f63ff33, transparent 60%),
        radial-gradient(900px 600px at 20% 20%, #53c1ff22, transparent 55%),
        radial-gradient(900px 600px at 85% 35%, #a855ff1f, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
      user-select:none;
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background-image:
        radial-gradient(circle at 12% 22%, rgba(255,255,255,.06) 0 2px, transparent 3px),
        radial-gradient(circle at 40% 14%, rgba(255,255,255,.05) 0 2px, transparent 3px),
        radial-gradient(circle at 74% 18%, rgba(255,255,255,.05) 0 2px, transparent 3px),
        radial-gradient(circle at 22% 60%, rgba(255,255,255,.04) 0 2px, transparent 3px),
        radial-gradient(circle at 62% 70%, rgba(255,255,255,.04) 0 2px, transparent 3px),
        radial-gradient(circle at 86% 62%, rgba(255,255,255,.04) 0 2px, transparent 3px);
      opacity:.75;
      pointer-events:none;
    }

    canvas#fx{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:80;
    }

    /* -------- MENU -------- */
    .menu{
      position:fixed; inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:14px;
      padding:18px;
      z-index:100;
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(20,60,255,.35), rgba(10,27,77,.92));
      backdrop-filter: blur(12px);
    }
    .menuCard{
      width:min(560px, 96vw);
      border-radius:26px;
      padding:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.07));
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .menuCard:before{
      content:"";
      position:absolute; inset:-60%;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,204,77,.22), transparent 55%),
        radial-gradient(circle at 75% 60%, rgba(47,224,132,.18), transparent 60%),
        radial-gradient(circle at 60% 20%, rgba(42,161,255,.18), transparent 60%);
      transform: rotate(12deg);
      pointer-events:none;
    }
    .menuTitle{
      display:flex; align-items:center; gap:10px;
      font-weight:1000; letter-spacing:.5px;
      margin:0;
      font-size:22px;
    }
    .menuSub{
      margin:6px 0 0;
      color:var(--muted);
      font-weight:750;
      line-height:1.25;
      font-size:13px;
    }

    .logo{
      width:38px; height:38px;
      border-radius:12px;
      background: conic-gradient(from 210deg, #ff4d73, #ffcc4d, #33e28a, #2aa1ff, #a855ff, #ff4d73);
      box-shadow: 0 12px 20px rgba(0,0,0,.25);
      position:relative;
      flex:0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute; inset:7px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.05));
      mix-blend-mode: overlay;
    }

    .skins{
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .skinBtn{
      width:42px; height:42px;
      border-radius:14px;
      border:2px solid rgba(255,255,255,.22);
      cursor:pointer;
      box-shadow: var(--soft);
      position:relative;
      overflow:hidden;
      background: #1c2c80;
    }
    .skinBtn.active{
      outline: 3px solid rgba(47,224,132,.85);
      border-color: rgba(47,224,132,.35);
      transform: translateY(-1px);
    }
    .skinBtn:after{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.35), transparent 55%),
        radial-gradient(circle at 70% 80%, rgba(255,255,255,.18), transparent 55%);
      opacity:.35;
      transform: rotate(20deg);
    }

    .menuActions{
      margin-top:14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .btn{
      border:none;
      cursor:pointer;
      border-radius:18px;
      padding:12px 14px;
      font-weight:1000;
      letter-spacing:.35px;
      box-shadow: var(--shadow);
      transition: transform .12s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{
      flex:1;
      background: linear-gradient(180deg, rgba(47,224,132,.98), rgba(30,207,118,.92));
      color:#08321e;
    }
    .btn.secondary{
      flex:.7;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      color:var(--text);
      box-shadow: var(--soft);
    }

    /* -------- GAME UI -------- */
    .app{
      height:100%;
      display:none;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:14px;
    }
    .topbar{
      width:min(560px, 96vw);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .pill{
      display:flex; flex-direction:column;
      gap:2px;
      padding:10px 12px;
      border-radius:16px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--soft);
      backdrop-filter: blur(10px);
      min-width:130px;
    }
    .pill .k{font-size:11px; color:var(--muted); font-weight:800;}
    .pill .v{font-size:18px; font-weight:1000; letter-spacing:.4px; display:flex; align-items:center; gap:6px;}
    .crown{
      display:inline-grid; place-items:center;
      width:20px; height:20px; border-radius:8px;
      background: linear-gradient(180deg, rgba(255,204,77,.95), rgba(255,166,0,.85));
      color:#3b2500;
      box-shadow: 0 10px 18px rgba(0,0,0,.20);
      font-size:13px;
    }

    .boardWrap{
      position:relative;
      width: min(430px, 92vw);
      aspect-ratio: 1 / 1;
      border-radius:22px;
      padding:10px;
      background: linear-gradient(180deg, rgba(42,161,255,.28), rgba(42,161,255,.10));
      box-shadow: var(--shadow);
    }

    .board{
      width:100%;
      height:100%;
      border-radius:18px;
      background:
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.18)),
        radial-gradient(140% 120% at 50% 0%, rgba(255,255,255,.05), transparent 60%);
      border: 3px solid rgba(42,161,255,.65);
      overflow:hidden;
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(10, 1fr);
      gap: 1px;
      padding: 8px;
    }
    .cell{
      border-radius: 6px;
      background: var(--cellAlt);
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
      transition: transform .08s ease, filter .08s ease;
    }
    .cell:nth-child(odd){ background: var(--cellBase); }

    .cell.filled{
      background: var(--fill, #ff4d73);
      box-shadow: inset 0 -10px 18px rgba(0,0,0,.18), inset 0 10px 18px rgba(255,255,255,.12);
      animation: popIn .16s ease-out;
    }
    .cell.filled:after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 40%),
                  radial-gradient(circle at 70% 70%, rgba(255,255,255,.28), transparent 45%);
      opacity:.22;
      transform: rotate(25deg);
      pointer-events:none;
    }
    @keyframes popIn{
      0%{ transform: scale(.85); filter: brightness(.9); }
      100%{ transform: scale(1); filter: brightness(1); }
    }

    .cell.blink{
      animation: blink .22s ease-in-out 2;
    }
    @keyframes blink{
      0%{ filter: brightness(1); transform: scale(1); }
      50%{ filter: brightness(1.2); transform: scale(1.03); }
      100%{ filter: brightness(1); transform: scale(1); }
    }

    .clearFlash{
      position:absolute; inset:8px;
      border-radius:18px;
      pointer-events:none;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform: translateX(-120%);
      opacity:0;
    }
    .clearFlash.run{ animation: sweep .42s ease-out; }
    @keyframes sweep{
      0%{ transform: translateX(-120%); opacity:0; }
      20%{ opacity:1; }
      100%{ transform: translateX(120%); opacity:0; }
    }

    .toast{
      position:absolute;
      left:50%; top:12px;
      transform: translateX(-50%);
      padding:10px 14px;
      border-radius:16px;
      background: rgba(0,0,0,.34);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      font-weight:1000;
      letter-spacing:.3px;
      opacity:0;
      pointer-events:none;
      z-index:40;
      white-space:nowrap;
    }
    .toast.show{ animation: toastPop .9s ease forwards; }
    @keyframes toastPop{
      0%{opacity:0; transform: translateX(-50%) translateY(-8px) scale(.98);}
      15%{opacity:1; transform: translateX(-50%) translateY(0) scale(1);}
      75%{opacity:1;}
      100%{opacity:0; transform: translateX(-50%) translateY(-10px) scale(.98);}
    }

    .pieces{
      width:min(560px, 96vw);
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border-radius:22px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .pieceSlot{
      flex:1;
      min-width:0;
      display:grid;
      place-items:center;
      border-radius:18px;
      background: rgba(0,0,0,.12);
      padding:10px;
      position:relative;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease, outline .12s ease;
    }
    .pieceSlot:active{ transform: translateY(1px) scale(.99); }
    .pieceSlot.selected{
      outline: 3px solid rgba(47,224,132,.85);
      filter: brightness(1.05);
    }

    .piece{
      width:100%;
      max-width:140px;
      aspect-ratio: 1 / 1;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(5, 1fr);
      gap:4px;
      filter: drop-shadow(0 12px 14px rgba(0,0,0,.25));
      pointer-events:none;
    }
    .pCell{ border-radius:8px; background: transparent; position:relative; }
    .pCell.on{
      background: var(--pcolor);
      box-shadow: inset 0 -10px 18px rgba(0,0,0,.16), inset 0 10px 18px rgba(255,255,255,.14);
    }
    .pCell.on:after{
      content:"";
      position:absolute; inset:-35%;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.6), transparent 40%),
        radial-gradient(circle at 70% 70%, rgba(255,255,255,.25), transparent 50%);
      opacity:.22;
      transform: rotate(25deg);
      pointer-events:none;
    }

    .controls{
      width:min(560px, 96vw);
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .tinyHint{
      width:min(560px,96vw);
      text-align:center;
      font-size:11px;
      color:var(--muted);
      font-weight:800;
      margin-top:-4px;
    }

    .overlay{
      position:fixed; inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      z-index:120;
      padding:16px;
    }
    .overlay.show{ display:grid; }
    .modal{
      width:min(560px, 96vw);
      border-radius:26px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.07));
      box-shadow: var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .modal h2{margin:0 0 6px; font-size:18px; letter-spacing:.2px;}
    .modal p{margin:0 0 12px; color:var(--muted); font-weight:750; line-height:1.25;}
    .modal .row{display:flex; gap:10px;}

    .shakeLose{
      animation: loseShake .5s ease;
    }
    @keyframes loseShake{
      0%{ transform: translateX(0); }
      15%{ transform: translateX(-10px); }
      30%{ transform: translateX(10px); }
      45%{ transform: translateX(-8px); }
      60%{ transform: translateX(8px); }
      75%{ transform: translateX(-4px); }
      90%{ transform: translateX(4px); }
      100%{ transform: translateX(0); }
    }

    @media (max-height: 760px){
      .boardWrap{ width:min(390px, 92vw); }
      .piece{ max-width:120px; }
      .pill{ min-width:120px; }
    }
  </style>
</head>

<body>
<canvas id="fx"></canvas>

<!-- MENU -->
<div class="menu" id="menu">
  <div class="menuCard">
    <div class="menuTitle"><div class="logo"></div>BLOCK MASTER</div>
    <div class="menuSub">
      –¢–æ–ª—å–∫–æ —Ä–µ–∫–æ—Ä–¥. –°—Ç–∞–≤—å –∫—É–¥–∞ —Ö–æ—á–µ—à—å (–º–æ–∂–Ω–æ –¥–∞–∂–µ –ø–æ–≤–µ—Ä—Ö –±–ª–æ–∫–æ–≤).<br>
      –†—è–¥/–∫–æ–ª–æ–Ω–∫–∞/–¥–∏–∞–≥–æ–Ω–∞–ª—å —á–∏—Å—Ç–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω–∞.
    </div>

    <div class="menuSub" style="margin-top:12px;">–í—ã–±–µ—Ä–∏ –¥–∏–∑–∞–π–Ω –ø–æ–ª—è:</div>
    <div class="skins" id="skins"></div>

    <div class="menuActions">
      <button class="btn secondary" id="btnHow">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</button>
      <button class="btn primary" id="btnPlay">–ò–≥—Ä–∞—Ç—å</button>
    </div>
  </div>

  <div class="menuCard" id="howCard" style="display:none;">
    <div class="menuTitle">–ü—Ä–∞–≤–∏–ª–∞</div>
    <div class="menuSub">
      1) –í—ã–±–µ—Ä–∏ —Ñ–∏–≥—É—Ä—É —Å–Ω–∏–∑—É (–æ–Ω–∞ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—Å—è).<br>
      2) –¢–∫–Ω–∏ –≤ –∫–ª–µ—Ç–∫—É –ø–æ–ª—è ‚Äî —Ñ–∏–≥—É—Ä–∞ –≤—Å—Ç–∞–Ω–µ—Ç —Ç—É–¥–∞, –∫—É–¥–∞ —Ç–∫–Ω—É–ª–∞ (—Å–∞–º–∞ ‚Äú–≤–ø–∏—à–µ—Ç—Å—è‚Äù —É –∫—Ä–∞—è).<br>
      3) –ú–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –ø–æ–≤–µ—Ä—Ö –±–ª–æ–∫–æ–≤ ‚Äî —ç—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ.<br>
      4) –ü—Ä–æ–∏–≥—Ä—ã—à –∫–æ–≥–¥–∞ –ø–æ–ª–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–±–∏—Ç–æ (–Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –ø—É—Å—Ç–æ–π –∫–ª–µ—Ç–∫–∏).<br>
      5) –°–∞–ª—é—Ç –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ –∏ –ø—Ä–∏ –Ω–æ–≤–æ–º —Ä–µ–∫–æ—Ä–¥–µ üí•
    </div>
    <div class="menuActions">
      <button class="btn secondary" id="btnBack">–ù–∞–∑–∞–¥</button>
      <button class="btn primary" id="btnPlay2">–ò–≥—Ä–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- GAME -->
<div class="app" id="app">
  <div class="topbar">
    <div class="pill">
      <div class="k">SCORE</div>
      <div class="v" id="score">0</div>
    </div>
    <div class="pill">
      <div class="k">BEST</div>
      <div class="v"><span class="crown">üëë</span><span id="best">0</span></div>
    </div>
  </div>

  <div class="boardWrap" id="boardWrap">
    <div class="toast" id="toast">–ö–†–ê–°–ê–í–ê!</div>
    <div class="clearFlash" id="clearFlash"></div>
    <div class="board" id="board"></div>
  </div>

  <div class="tinyHint">–í—ã–±–µ—Ä–∏ —Ñ–∏–≥—É—Ä—É ‚Üí —Ç–∫–Ω–∏ –∫–ª–µ—Ç–∫—É. –ß–∏—Å—Ç–∫–∞: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å / –≤–µ—Ä—Ç–∏–∫–∞–ª—å / 2 –¥–∏–∞–≥–æ–Ω–∞–ª–∏.</div>

  <div class="pieces" id="pieces"></div>

  <div class="controls">
    <button class="btn secondary" id="btnMenu">–ú–µ–Ω—é</button>
    <button class="btn secondary" id="btnNew">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    <button class="btn primary" id="btnShuffle">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Ñ–∏–≥—É—Ä—ã (x1)</button>
  </div>
</div>

<!-- GAME OVER -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h2 id="modalTitle">–ü—Ä–æ–∏–≥—Ä—ã—à</h2>
    <p id="modalText">–ü–æ–ª–µ –∑–∞–±–∏—Ç–æ. –ó–∞–Ω–æ–≤–æ?</p>
    <div class="row">
      <button class="btn secondary" id="btnClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn primary" id="btnRestart">–ó–∞–Ω–æ–≤–æ</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ------------------ helpers ------------------
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const rand = (a,b)=>Math.random()*(b-a)+a;
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];

  // ------------------ DOM ------------------
  const menuEl = document.getElementById("menu");
  const appEl = document.getElementById("app");
  const boardEl = document.getElementById("board");
  const piecesEl = document.getElementById("pieces");
  const scoreEl = document.getElementById("score");
  const bestEl  = document.getElementById("best");
  const toastEl = document.getElementById("toast");
  const overlayEl = document.getElementById("overlay");
  const modalTextEl = document.getElementById("modalText");
  const boardWrapEl = document.getElementById("boardWrap");
  const clearFlashEl = document.getElementById("clearFlash");

  const btnPlay = document.getElementById("btnPlay");
  const btnPlay2 = document.getElementById("btnPlay2");
  const btnHow = document.getElementById("btnHow");
  const btnBack = document.getElementById("btnBack");
  const howCard = document.getElementById("howCard");

  const btnMenu = document.getElementById("btnMenu");
  const btnNew = document.getElementById("btnNew");
  const btnShuffle = document.getElementById("btnShuffle");
  const btnClose = document.getElementById("btnClose");
  const btnRestart = document.getElementById("btnRestart");

  // ------------------ FX canvas ------------------
  const fx = document.getElementById("fx");
  const ctx = fx.getContext("2d");
  let W=0,H=0, DPR=1;
  function resizeFX(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    W = Math.floor(innerWidth * DPR);
    H = Math.floor(innerHeight * DPR);
    fx.width = W; fx.height = H;
    fx.style.width = innerWidth+"px";
    fx.style.height= innerHeight+"px";
    ctx.setTransform(1,0,0,1,0,0);
  }
  addEventListener("resize", resizeFX);
  resizeFX();

  const particles = [];
  function spawnFirework(x,y,power=1){
    const cx = x*DPR, cy = y*DPR;
    const colors = ["#ff4d73","#ffcc4d","#33e28a","#2aa1ff","#a855ff","#00e5ff","#ffffff"];
    const count = Math.floor(110 * power);
    for(let i=0;i<count;i++){
      const a = rand(0, Math.PI*2);
      const sp = rand(2.0, 8.0) * power * DPR;
      particles.push({
        x:cx,y:cy,
        vx:Math.cos(a)*sp,
        vy:Math.sin(a)*sp - rand(0,1.4*DPR),
        life:rand(45,85),
        t:0,
        size:rand(1.7,3.8)*DPR,
        col:pick(colors),
        grav:0.10*DPR,
        drag:0.985
      });
    }
  }
  function spawnConfetti(power=1){
    const colors = ["#ff4d73","#ffcc4d","#33e28a","#2aa1ff","#a855ff","#ffffff"];
    const count = Math.floor(160 * power);
    for(let i=0;i<count;i++){
      particles.push({
        x:rand(0,W),
        y:rand(-60*DPR, 0),
        vx:rand(-1.6,1.6)*DPR,
        vy:rand(1.6,4.4)*DPR,
        life:rand(110,170),
        t:0,
        size:rand(2.4,5.4)*DPR,
        col:pick(colors),
        grav:0.03*DPR,
        drag:0.995,
        rect:true,
        rot:rand(0,Math.PI*2),
        vr:rand(-0.22,0.22)
      });
    }
  }
  function boomAtBoard(power=1.2){
    const r = boardWrapEl.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;
    spawnConfetti(power);
    spawnFirework(cx, cy, power);
    spawnFirework(cx - r.width*0.22, cy + r.height*0.05, power*0.85);
    spawnFirework(cx + r.width*0.22, cy - r.height*0.05, power*0.85);
  }
  function tickFX(){
    ctx.clearRect(0,0,W,H);
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.t++;
      p.vx *= p.drag;
      p.vy = (p.vy + p.grav) * p.drag;
      p.x += p.vx;
      p.y += p.vy;

      const a = 1 - (p.t / p.life);
      if(a <= 0){
        particles.splice(i,1);
        continue;
      }
      ctx.globalAlpha = clamp(a,0,1);
      ctx.fillStyle = p.col;

      if(p.rect){
        p.rot += p.vr;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.fillRect(-p.size, -p.size*0.35, p.size*2, p.size*0.7);
        ctx.restore();
      }else{
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        ctx.fill();
      }
    }
    ctx.globalAlpha = 1;
    requestAnimationFrame(tickFX);
  }
  tickFX();

  // ------------------ game data ------------------
  const N = 10;
  let board = Array.from({length:N}, ()=>Array(N).fill(null));
  const cellEls = [];
  let score = 0;

  const BEST_KEY = "bb_best_classic_final_v1";
  const SKIN_KEY = "bb_skin_final_v1";

  let best = parseInt(localStorage.getItem(BEST_KEY) || "0", 10);
  if(!Number.isFinite(best)) best = 0;

  // skins
  const SKINS = [
    {name:"Ocean", cell:"#1c2c80", border:"#2aa1ff"},
    {name:"Night", cell:"#141414", border:"#8aa0ff"},
    {name:"Emerald", cell:"#054a3b", border:"#33e28a"},
    {name:"Crimson", cell:"#3b0c18", border:"#ff4d73"},
    {name:"Violet", cell:"#24114a", border:"#a855ff"},
    {name:"Sand", cell:"#3b2f14", border:"#ffcc4d"},
  ];
  let currentSkin = localStorage.getItem(SKIN_KEY) || "Ocean";

  function applySkin(name){
    const s = SKINS.find(x=>x.name===name) || SKINS[0];
    currentSkin = s.name;
    document.documentElement.style.setProperty("--cellSkin", s.cell);
    document.documentElement.style.setProperty("--gridBorder", s.border);
    localStorage.setItem(SKIN_KEY, currentSkin);
    // —Ç–∞–∫–∂–µ —á—É—Ç—å –º–µ–Ω—è–µ–º —Ñ–æ–Ω –∫–ª–µ—Ç–æ–∫ (—á—Ç–æ–± —Å–∫–∏–Ω –æ—â—É—â–∞–ª—Å—è)
    // –±–∞–∑–æ–≤—ã–µ –∫–ª–µ—Ç–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º–∏, –Ω–æ –¥–æ–±–∞–≤–∏–º –æ–±—â–∏–π –æ—Ç—Ç–µ–Ω–æ–∫ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
  }

  // pieces
  const COLORS = ["#ff4d73","#ffcc4d","#33e28a","#2aa1ff","#a855ff","#00e5ff","#ff7a00","#7cff00"];
  const SHAPES = [
    [[1]],
    [[1,1]],
    [[1,1,1]],
    [[1,1,1,1]],
    [[1,1,1,1,1]],
    [[1],[1]],
    [[1],[1],[1]],
    [[1],[1],[1],[1]],
    [[1],[1],[1],[1],[1]],
    [[1,1],[1,1]],
    [[1,1,1],[1,1,1],[1,1,1]],
    [[1,0],[1,0],[1,1]],
    [[0,1],[0,1],[1,1]],
    [[1,1],[1,0],[1,0]],
    [[1,1],[0,1],[0,1]],
    [[1,0,0],[1,0,0],[1,1,1]],
    [[0,0,1],[0,0,1],[1,1,1]],
    [[1,1,1],[1,0,0],[1,0,0]],
    [[1,1,1],[0,0,1],[0,0,1]],
    [[1,1,1],[0,1,0]],
    [[0,1,0],[1,1,1]],
    [[1,0],[1,1],[1,0]],
    [[0,1],[1,1],[0,1]],
    [[1,1,0],[0,1,1]],
    [[0,1,1],[1,1,0]],
    [[1,0],[1,1],[0,1]],
    [[0,1],[1,1],[1,0]],
    [[1,1,1],[1,0,1]],
    [[1,1,1],[1,1,0]],
    [[1,1,1],[0,1,1]],
    [[1,1,0],[1,1,1]],
    [[0,1,1],[1,1,1]],
  ];

  let pieces = []; // {shape,color}
  let selectedIndex = -1;
  let shuffleLeft = 1;

  // ------------------ UI helpers ------------------
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.remove("show");
    void toastEl.offsetWidth;
    toastEl.classList.add("show");
  }

  function updateHUD(){
    scoreEl.textContent = score;
    bestEl.textContent = best;
    btnShuffle.textContent = `–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Ñ–∏–≥—É—Ä—ã (x${shuffleLeft})`;
  }

  // ------------------ board render ------------------
  function buildBoard(){
    boardEl.innerHTML = "";
    cellEls.length = 0;
    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const d = document.createElement("div");
        d.className = "cell";
        d.dataset.x = x;
        d.dataset.y = y;
        // click to place
        d.addEventListener("click", ()=> onCellClick(x,y));
        boardEl.appendChild(d);
        cellEls.push(d);
      }
    }
  }

  function renderBoard(blinkCells=[]){
    const blinkSet = new Set(blinkCells.map(([x,y])=>`${x},${y}`));
    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const el = cellEls[y*N + x];
        const v = board[y][x];
        if(v){
          el.classList.add("filled");
          el.style.setProperty("--fill", v);
        }else{
          el.classList.remove("filled");
          el.style.removeProperty("--fill");
        }
        el.classList.toggle("blink", blinkSet.has(`${x},${y}`));
      }
    }
  }

  // ------------------ pieces render ------------------
  function shapeTo5x5(shape){
    const h=shape.length, w=shape[0].length;
    const g=Array.from({length:5},()=>Array(5).fill(0));
    const offY=Math.floor((5-h)/2);
    const offX=Math.floor((5-w)/2);
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        g[offY+y][offX+x]=shape[y][x]?1:0;
      }
    }
    return g;
  }

  function newPieces(){
    pieces = Array.from({length:3}, ()=>({
      shape: pick(SHAPES),
      color: pick(COLORS),
    }));
    selectedIndex = -1;
    renderPieces();
  }

  function renderPieces(){
    piecesEl.innerHTML = "";
    pieces.forEach((p,i)=>{
      const slot = document.createElement("div");
      slot.className = "pieceSlot" + (i===selectedIndex ? " selected" : "");
      slot.addEventListener("click", ()=> {
        selectedIndex = (selectedIndex===i ? -1 : i);
        renderPieces();
      });

      const piece = document.createElement("div");
      piece.className = "piece";
      piece.style.setProperty("--pcolor", p.color);

      const g = shapeTo5x5(p.shape);
      for(let y=0;y<5;y++){
        for(let x=0;x<5;x++){
          const c = document.createElement("div");
          c.className = "pCell" + (g[y][x] ? " on" : "");
          piece.appendChild(c);
        }
      }
      slot.appendChild(piece);
      piecesEl.appendChild(slot);
    });
  }

  // ------------------ placement: "–∫—É–¥–∞ —Ç–∫–Ω—É–ª–∞" ------------------
  function shapeFilledBounds(shape){
    let minX=999, minY=999, maxX=-999, maxY=-999;
    for(let y=0;y<shape.length;y++){
      for(let x=0;x<shape[0].length;x++){
        if(shape[y][x]){
          if(x<minX) minX=x;
          if(y<minY) minY=y;
          if(x>maxX) maxX=x;
          if(y>maxY) maxY=y;
        }
      }
    }
    return {minX,minY,maxX,maxY};
  }

  function onCellClick(clickX, clickY){
    if(selectedIndex < 0) { toast("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ñ–∏–≥—É—Ä—É —Å–Ω–∏–∑—É üëá"); return; }

    const {shape, color} = pieces[selectedIndex];

    // "–æ–ø–æ—Ä–Ω—ã–π" –±–ª–æ–∫: —Å–∞–º—ã–π –≤–µ—Ä—Ö–Ω–∏–π-–ª–µ–≤—ã–π –∑–∞–Ω—è—Ç—ã–π
    const b = shapeFilledBounds(shape);

    // —Ö–æ—Ç–∏–º —á—Ç–æ–±—ã —ç—Ç–æ—Ç –±–ª–æ–∫ –ø–æ–ø–∞–ª –≤ –∫–ª–µ—Ç–∫—É (clickX, clickY)
    let baseX = clickX - b.minX;
    let baseY = clickY - b.minY;

    // –∞–≤—Ç–æ–ø–æ–¥–≥–æ–Ω –ø–æ –∫—Ä–∞—è–º, —á—Ç–æ–±—ã –≤–ª–µ–∑–∞–ª–æ (–±–µ–∑ –∑–∞–ø—Ä–µ—Ç–æ–≤)
    const overflowRight  = (baseX + b.maxX) - (N-1);
    const overflowBottom = (baseY + b.maxY) - (N-1);
    if(overflowRight  > 0) baseX -= overflowRight;
    if(overflowBottom > 0) baseY -= overflowBottom;
    if(baseX < 0) baseX = 0;
    if(baseY < 0) baseY = 0;

    // —Å—Ç–∞–≤–∏–º –í–ï–ó–î–ï, –º–æ–∂–Ω–æ –ø–æ–≤–µ—Ä—Ö (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—å)
    const placedCells = [];
    for(let dy=0;dy<shape.length;dy++){
      for(let dx=0;dx<shape[0].length;dx++){
        if(!shape[dy][dx]) continue;
        const x = baseX + dx;
        const y = baseY + dy;
        if(x>=0 && x<N && y>=0 && y<N){
          board[y][x] = color;
          placedCells.push([x,y]);
        }
      }
    }

    // –æ—á–∫–∏ –∑–∞ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫—É
    score += placedCells.length * 10;

    // –ª—ë–≥–∫–∏–π "–ø–æ–ø" –Ω–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–ª–µ—Ç–∫–∞—Ö
    renderBoard(placedCells);

    // –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–∏—Å—Ç–∫—É
    const cleared = clearLines();
    if(cleared.total > 0){
      score += 140 * cleared.total;
      if(cleared.diags > 0) toast("–î–ò–ê–ì–û–ù–ê–õ–¨ üí•");
      else if(cleared.total >= 2) toast("–ö–û–ú–ë–û üî•");
      else toast("–ß–ò–°–¢–û ‚úÖ");
    } else {
      toast("–ü–û–°–¢–ê–í–ò–õ üòà");
    }

    // —Å–º–µ–Ω–∞ —Ñ–∏–≥—É—Ä
    newPieces();

    // –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ ‚Äî –±–æ–Ω—É—Å + —Å–∞–ª—é—Ç
    if(isBoardEmpty()){
      score += 600;
      toast("–ü–û–õ–ï –í –ù–û–õ–¨ üí£");
      boomAtBoard(1.2);
    }

    updateHUD();

    // –ø—Ä–æ–∏–≥—Ä—ã—à: –Ω–µ—Ç –ø—É—Å—Ç—ã—Ö –∫–ª–µ—Ç–æ–∫
    if(!hasMove()){
      gameOver();
    }
  }

  // ------------------ clear rules ------------------
  function isFullRow(y){
    for(let x=0;x<N;x++) if(!board[y][x]) return false;
    return true;
  }
  function isFullCol(x){
    for(let y=0;y<N;y++) if(!board[y][x]) return false;
    return true;
  }
  function isFullDiagMain(){
    for(let i=0;i<N;i++) if(!board[i][i]) return false;
    return true;
  }
  function isFullDiagAnti(){
    for(let i=0;i<N;i++) if(!board[i][N-1-i]) return false;
    return true;
  }

  function clearLines(){
    const rows=[], cols=[];
    for(let y=0;y<N;y++) if(isFullRow(y)) rows.push(y);
    for(let x=0;x<N;x++) if(isFullCol(x)) cols.push(x);

    const diagMain = isFullDiagMain();
    const diagAnti = isFullDiagAnti();

    if(rows.length===0 && cols.length===0 && !diagMain && !diagAnti){
      return {total:0, rows:0, cols:0, diags:0};
    }

    clearFlashEl.classList.remove("run");
    void clearFlashEl.offsetWidth;
    clearFlashEl.classList.add("run");

    // clear rows
    for(const y of rows) for(let x=0;x<N;x++) board[y][x]=null;
    // clear cols
    for(const x of cols) for(let y=0;y<N;y++) board[y][x]=null;

    let diags=0;
    if(diagMain){ diags++; for(let i=0;i<N;i++) board[i][i]=null; }
    if(diagAnti){ diags++; for(let i=0;i<N;i++) board[i][N-1-i]=null; }

    renderBoard();
    return {total: rows.length + cols.length + diags, rows: rows.length, cols: cols.length, diags};
  }

  // ------------------ lose logic ------------------
  function hasMove(){
    // —Ç.–∫. –º—ã —Ä–∞–∑—Ä–µ—à–∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å, —Ö–æ–¥ –µ—Å—Ç—å –ø–æ–∫–∞ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 1 –ø—É—Å—Ç–∞—è –∫–ª–µ—Ç–∫–∞
    return board.some(row => row.some(cell => !cell));
  }
  function isBoardEmpty(){
    for(let y=0;y<N;y++) for(let x=0;x<N;x++) if(board[y][x]) return false;
    return true;
  }

  function gameOver(){
    // –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–∏–≥—Ä—ã—à–∞
    boardWrapEl.classList.remove("shakeLose");
    void boardWrapEl.offsetWidth;
    boardWrapEl.classList.add("shakeLose");

    // —Å–∞–ª—é—Ç –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ (–≤—Å–µ–≥–¥–∞)
    boomAtBoard(1.25);

    // —Ä–µ–∫–æ—Ä–¥
    let newRecord = false;
    if(score > best){
      best = score;
      localStorage.setItem(BEST_KEY, String(best));
      newRecord = true;
      // –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ—â–Ω—ã–π —Å–∞–ª—é—Ç –Ω–∞ —Ä–µ–∫–æ—Ä–¥
      setTimeout(()=>boomAtBoard(1.55), 180);
      toast("–ù–û–í–´–ô –†–ï–ö–û–†–î üëëüéÜ");
    } else {
      toast("–ü–†–û–ï–ë–ê–õ üòà");
    }

    updateHUD();

    // –º–æ–¥–∞–ª–∫–∞
    overlayEl.classList.add("show");
    modalTextEl.textContent = newRecord
      ? `–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥: ${best} üëë  –°—á—ë—Ç: ${score}. –ï—â—ë —Ä–∞–∑?`
      : `–°—á—ë—Ç: ${score}. –†–µ–∫–æ—Ä–¥: ${best}. –ï—â—ë —Ä–∞–∑?`;
  }

  function closeModal(){
    overlayEl.classList.remove("show");
  }

  function restartGame(){
    closeModal();
    score = 0;
    shuffleLeft = 1;
    board = Array.from({length:N}, ()=>Array(N).fill(null));
    renderBoard();
    newPieces();
    updateHUD();
    toast("–ü–û–ï–•–ê–õ–ò üöÄ");
  }

  // ------------------ shuffle ------------------
  function shufflePieces(){
    if(shuffleLeft<=0){
      toast("–®–∞—Ñ—Ñ–ª –∫–æ–Ω—á–∏–ª—Å—è üòà");
      return;
    }
    for(let i=0;i<pieces.length;i++){
      pieces[i] = {shape: pick(SHAPES), color: pick(COLORS)};
    }
    selectedIndex = -1;
    shuffleLeft--;
    renderPieces();
    updateHUD();
    toast("–ü–ï–†–ï–ú–ï–®–ê–õ üí´");
  }

  // ------------------ menu build ------------------
  function buildSkins(){
    const skinsEl = document.getElementById("skins");
    skinsEl.innerHTML = "";
    for(const s of SKINS){
      const b = document.createElement("div");
      b.className = "skinBtn" + (s.name===currentSkin ? " active" : "");
      b.title = s.name;
      b.style.background = s.cell;
      b.addEventListener("click", ()=>{
        applySkin(s.name);
        buildSkins();
      });
      skinsEl.appendChild(b);
    }
  }

  function showMenu(){
    appEl.style.display = "none";
    menuEl.style.display = "flex";
  }
  function showGame(){
    menuEl.style.display = "none";
    appEl.style.display = "flex";
  }

  // ------------------ events ------------------
  btnPlay.addEventListener("click", ()=>{
    showGame();
    restartGame();
  });
  btnPlay2.addEventListener("click", ()=>{
    showGame();
    restartGame();
  });
  btnHow.addEventListener("click", ()=>{
    howCard.style.display = "block";
  });
  btnBack.addEventListener("click", ()=>{
    howCard.style.display = "none";
  });

  btnMenu.addEventListener("click", ()=>{
    closeModal();
    showMenu();
  });

  btnNew.addEventListener("click", restartGame);
  btnShuffle.addEventListener("click", shufflePieces);

  btnClose.addEventListener("click", closeModal);
  btnRestart.addEventListener("click", restartGame);
  overlayEl.addEventListener("click", (e)=>{ if(e.target===overlayEl) closeModal(); });

  // ------------------ init ------------------
  function init(){
    buildBoard();
    applySkin(currentSkin);
    buildSkins();
    updateHUD();
    renderBoard();
    newPieces();
    // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–µ–Ω—é
    showMenu();
  }
  init();

})();
</script>
</body>
</html>
